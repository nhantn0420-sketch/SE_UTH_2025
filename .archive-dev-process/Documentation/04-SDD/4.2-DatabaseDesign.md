# 4.2. DATABASE DESIGN (Thi·∫øt k·∫ø C∆° s·ªü D·ªØ li·ªáu)

**Thi·∫øt k·∫ø CSDL Chi ti·∫øt - CollabSphere**

---

## 4.2.1. DATABASE OVERVIEW

### Th√¥ng tin C∆° b·∫£n

| Thu·ªôc t√≠nh | Gi√° tr·ªã |
|------------|---------|
| **DBMS** | PostgreSQL 15.x |
| **Database Name** | collabsphere_db |
| **Character Set** | UTF-8 |
| **Collation** | en_US.UTF-8 |
| **Total Tables** | 28 tables |
| **ORM Framework** | SQLModel (Python) |
| **Migration Tool** | Alembic |

### C√°c Nh√≥m B·∫£ng (Table Groups)

```
collabsphere_db (28 tables)
‚îú‚îÄ‚îÄ 1. Users & Authentication (1 table)
‚îÇ   ‚îî‚îÄ‚îÄ users
‚îÇ
‚îú‚îÄ‚îÄ 2. Academic Management (4 tables)
‚îÇ   ‚îú‚îÄ‚îÄ subjects
‚îÇ   ‚îú‚îÄ‚îÄ curricula
‚îÇ   ‚îú‚îÄ‚îÄ classes
‚îÇ   ‚îî‚îÄ‚îÄ class_members
‚îÇ
‚îú‚îÄ‚îÄ 3. Project & Group (9 tables)
‚îÇ   ‚îú‚îÄ‚îÄ projects
‚îÇ   ‚îú‚îÄ‚îÄ project_milestones
‚îÇ   ‚îú‚îÄ‚îÄ class_projects
‚îÇ   ‚îú‚îÄ‚îÄ groups
‚îÇ   ‚îú‚îÄ‚îÄ group_members
‚îÇ   ‚îú‚îÄ‚îÄ group_milestones
‚îÇ   ‚îú‚îÄ‚îÄ checkpoints
‚îÇ   ‚îú‚îÄ‚îÄ tasks
‚îÇ   ‚îî‚îÄ‚îÄ milestone_questions
‚îÇ
‚îú‚îÄ‚îÄ 4. Collaboration (7 tables)
‚îÇ   ‚îú‚îÄ‚îÄ meetings
‚îÇ   ‚îú‚îÄ‚îÄ meeting_participants
‚îÇ   ‚îú‚îÄ‚îÄ chat_messages
‚îÇ   ‚îú‚îÄ‚îÄ resources
‚îÇ   ‚îú‚îÄ‚îÄ whiteboard_sessions
‚îÇ   ‚îú‚îÄ‚îÄ document_sessions
‚îÇ   ‚îî‚îÄ‚îÄ video_sessions (optional)
‚îÇ
‚îú‚îÄ‚îÄ 5. Evaluation (5 tables)
‚îÇ   ‚îú‚îÄ‚îÄ peer_reviews
‚îÇ   ‚îú‚îÄ‚îÄ group_evaluations
‚îÇ   ‚îú‚îÄ‚îÄ member_evaluations
‚îÇ   ‚îú‚îÄ‚îÄ checkpoint_evaluations
‚îÇ   ‚îî‚îÄ‚îÄ milestone_answers
‚îÇ
‚îî‚îÄ‚îÄ 6. Notification (1 table)
    ‚îî‚îÄ‚îÄ notifications
```

---

## 4.2.2. ERD - CONCEPTUAL MODEL

### S∆° ƒë·ªì Quan h·ªá Th·ª±c th·ªÉ T·ªïng quan

![Figure 4.2.2: Conceptual Database Model](diagrams/4.2-conceptual-model.png)

*Figure 4.2.2: M√¥ h√¨nh Conceptual Database c·ªßa CollabSphere - Hi·ªÉn th·ªã ki·∫øn tr√∫c c·∫•p cao v·ªõi 6 nh√≥m th·ª±c th·ªÉ ch√≠nh: USERS (Admin, Staff, Head, Lecturer, Student), ACADEMIC (Subject, Class, Members), PROJECTS (Project, Milestone), GROUPS & TEAMS (Group, Group Members, Tasks & Checkpoints), COLLABORATION (Chat, Meetings, Resources, Whiteboard), EVALUATION (Peer Review, Evaluations, Feedback), v√† NOTIFICATION (Email, Real-time). C√°c m≈©i t√™n th·ªÉ hi·ªán lu·ªìng d·ªØ li·ªáu v√† m·ªëi quan h·ªá gi·ªØa c√°c nh√≥m th·ª±c th·ªÉ trong h·ªá th·ªëng qu·∫£n l√Ω Project-Based Learning.*

---

## 4.2.3. ERD - LOGICAL MODEL

### Entity Relationship Diagram (ERD)

**Complete ERD with 37 tables across 6 zones:**

![Figure 4.2: Entity Relationship Diagram](diagrams/4.2-erd-full.png)

*Figure 4.2: Complete Entity Relationship Diagram showing all 37 database tables organized into 6 functional zones (Users/Academic, Projects/Groups, Collaboration, Evaluation, Notifications, Activity Logs) with primary keys, foreign keys, and relationships.*

**Diagram Legend:**
- üîë **PRIMARY_KEY**: Gold indicator for primary key fields
- üîó **FOREIGN_KEY**: Blue indicator for foreign key relationships
- ‚ö° **UNIQUE**: Green indicator for unique constraints
- **Lines with cardinality**: Show relationships (1:1, 1:N, M:N)
- **Color zones**: Group related tables by functional domain

**Zone Breakdown:**
- **Zone 1 (Blue)**: Users & Academic (7 tables) - users, subjects, curricula, classes, class_members, class_projects
- **Zone 2 (Orange)**: Projects & Groups (15 tables) - projects, milestones, groups, checkpoints, tasks, workspace
- **Zone 3 (Green)**: Collaboration (7 tables) - meetings, chat, resources, whiteboard, documents
- **Zone 4 (Purple)**: Evaluation (6 tables) - peer reviews, evaluations, checkpoint assessments
- **Zone 5 (Yellow)**: Notifications (1 table) - real-time and email notifications
- **Zone 6 (Gray)**: Activity Logs (1 table) - audit trail (optional)

For detailed table specifications, see sections below.

---

### Module 1: Users & Authentication

![Figure 4.2.3: Users & Authentication Module](diagrams/4.2-module1-users.png)

*Figure 4.2.3: Module Users & Authentication - B·∫£ng users l√† b·∫£ng trung t√¢m qu·∫£n l√Ω t·∫•t c·∫£ ng∆∞·ªùi d√πng trong h·ªá th·ªëng v·ªõi RBAC (Role-Based Access Control). Bao g·ªìm 5 vai tr√≤: ADMIN, STAFF, HEAD, LECTURER, STUDENT. Password ƒë∆∞·ª£c m√£ h√≥a b·∫±ng bcrypt, email d√πng l√†m authentication. B·∫£ng c√≥ c√°c unique constraints tr√™n username v√† email, c√πng v·ªõi c√°c indexes ƒë·ªÉ t·ªëi ∆∞u truy v·∫•n. Users c√≥ relationships 1:N v·ªõi nhi·ªÅu b·∫£ng kh√°c: class_members (as student), classes (as lecturer), group_members (as member), projects (as creator), chat_messages (as sender), evaluations (as evaluator), v√† notifications (as recipient).*

### Module 2: Academic Management

![Figure 4.2.4: Academic Management Module](diagrams/4.2-module2-academic.png)

*Figure 4.2.4: Module Academic Management - G·ªìm 4 b·∫£ng qu·∫£n l√Ω th√¥ng tin h·ªçc thu·∫≠t: (1) **subjects** - Danh m·ª•c m√¥n h·ªçc v·ªõi m√£ m√¥n (code) duy nh·∫•t v√† s·ªë t√≠n ch·ªâ; (2) **curricula** - N·ªôi dung gi·∫£ng d·∫°y theo tu·∫ßn cho m·ªói m√¥n h·ªçc; (3) **classes** - L·ªõp h·ªçc c·ª• th·ªÉ trong h·ªçc k·ª≥, ƒë∆∞·ª£c ph·ª• tr√°ch b·ªüi Lecturer, c√≥ gi·ªõi h·∫°n sinh vi√™n v√† tr·∫°ng th√°i (ACTIVE/INACTIVE/COMPLETED); (4) **class_members** - Quan h·ªá many-to-many gi·ªØa students v√† classes, v·ªõi role (MEMBER/MONITOR). Relationships: Subject ‚Üí Classes (1:N), Subject ‚Üí Curricula (1:N), Class ‚Üí Members (1:N), Lecturer ‚Üí Classes (1:N), Student ‚Üí Class Members (1:N).*

### Module 3: Project & Group

![Figure 4.2.5: Project & Group Management Module](diagrams/4.2-module3-projects.png)

*Figure 4.2.5: Module Project & Group Management - Module ph·ª©c t·∫°p nh·∫•t v·ªõi 9 b·∫£ng: (1) **projects** - ƒê·ªÅ t√†i d·ª± √°n template do Lecturer t·∫°o v√† Head ph√™ duy·ªát, c√≥ tr·∫°ng th√°i PENDING/SUBMITTED/APPROVED/REJECTED; (2) **project_milestones** - C√°c c·ªôt m·ªëc c·ªßa project template; (3) **class_projects** - G√°n project cho classes; (4) **groups** - Nh√≥m sinh vi√™n l√†m d·ª± √°n, m·ªói nh√≥m c√≥ 1 leader v√† 1 project; (5) **group_members** - Th√†nh vi√™n trong nh√≥m v·ªõi contribution_score; (6) **group_milestones** - Milestone c·ª• th·ªÉ c·ªßa nh√≥m v·ªõi deadline; (7) **checkpoints** - ƒêi·ªÉm ki·ªÉm tra/n·ªôp b√†i; (8) **tasks** - Kanban board tasks v·ªõi status TODO/IN_PROGRESS/DONE. Workflow: Lecturer creates Project ‚Üí Head approves ‚Üí Assigned to Classes ‚Üí Students form Groups ‚Üí Groups implement Projects ‚Üí Track Milestones/Tasks.*

### Module 4: Collaboration

![Figure 4.2.6: Collaboration Tools Module](diagrams/4.2-module4-collaboration.png)

*Figure 4.2.6: Module Collaboration Tools - G·ªìm 7 b·∫£ng h·ªó tr·ª£ l√†m vi·ªác nh√≥m: (1) **meetings** - Cu·ªôc h·ªçp nh√≥m v·ªõi Zoom/Google Meet integration, status SCHEDULED/IN_PROGRESS/COMPLETED/CANCELLED; (2) **meeting_participants** - Ng∆∞·ªùi tham gia meeting v·ªõi tr·∫°ng th√°i INVITED/ACCEPTED/DECLINED/ATTENDED; (3) **chat_messages** - Chat real-time cho group ho·∫∑c class, h·ªó tr·ª£ TEXT/FILE/IMAGE/VIDEO v·ªõi read receipts; (4) **resources** - File management v·ªõi Cloudinary integration, h·ªó tr·ª£ PDF/DOCX/XLSX/PPT, c√≥ th·ªÉ share ·ªü group ho·∫∑c class level; (5) **whiteboard_sessions** - B·∫£ng tr·∫Øng c·ªông t√°c real-time l∆∞u d·ªØ li·ªáu JSON; (6) **document_sessions** - Ch·ªânh s·ª≠a t√†i li·ªáu c·ªông t√°c (HTML/Markdown) gi·ªëng Google Docs. Integration: Socket.IO (real-time), Cloudinary (storage), Zoom/Google Meet (video).*

### Module 5: Evaluation

![Figure 4.2.7: Evaluation & Assessment Module](diagrams/4.2-module5-evaluation.png)

*Figure 4.2.7: Module Evaluation & Assessment - G·ªìm 5 b·∫£ng ƒë√°nh gi√° ƒëa chi·ªÅu: (1) **peer_reviews** - ƒê√°nh gi√° ƒë·ªìng nghi·ªáp Student‚ÜíStudent v·ªõi rating 1-5 sao, c√≥ th·ªÉ ·∫©n danh, theo period (Midterm/Final/Weekly), criteria JSON t√πy ch·ªânh (communication, contribution, collaboration); (2) **group_evaluations** - Lecturer ƒë√°nh gi√° nh√≥m v·ªõi score 0-10, evaluation_type: Progress/Final/Presentation; (3) **member_evaluations** - Lecturer ƒë√°nh gi√° t·ª´ng th√†nh vi√™n d·ª±a tr√™n contribution_score v√† peer reviews; (4) **checkpoint_evaluations** - ƒê√°nh gi√° c√°c deliverables c·ª• th·ªÉ v·ªõi quick feedback; (5) **milestone_answers** - Nh√≥m tr·∫£ l·ªùi c√¢u h·ªèi milestone ƒë·ªÉ track progress. Score scales: Peer reviews 1-5 stars, t·∫•t c·∫£ kh√°c 0-10 points.*

---

## 4.2.4. ERD - PHYSICAL MODEL (Chi ti·∫øt 28 Tables)

### Table 1: users

**Purpose**: L∆∞u tr·ªØ th√¥ng tin t√†i kho·∫£n ng∆∞·ªùi d√πng

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | User ID |
| `username` | VARCHAR(100) | UNIQUE, NOT NULL | - | T√™n ƒëƒÉng nh·∫≠p |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | - | Email (d√πng login) |
| `full_name` | VARCHAR(255) | NOT NULL | - | H·ªç t√™n ƒë·∫ßy ƒë·ªß |
| `hashed_password` | VARCHAR(255) | NOT NULL | - | Password ƒë√£ hash (bcrypt) |
| `role` | VARCHAR(20) | NOT NULL | 'STUDENT' | Vai tr√≤: ADMIN/STAFF/HEAD/LECTURER/STUDENT |
| `avatar_url` | TEXT | NULL | NULL | URL ·∫£nh ƒë·∫°i di·ªán |
| `phone` | VARCHAR(20) | NULL | NULL | S·ªë ƒëi·ªán tho·∫°i |
| `is_active` | BOOLEAN | NOT NULL | TRUE | Tr·∫°ng th√°i k√≠ch ho·∫°t |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |
| `last_login` | TIMESTAMP | NULL | NULL | L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**Sample Data:**
```sql
INSERT INTO users (username, email, full_name, hashed_password, role) VALUES
('admin', 'admin@collabsphere.com', 'System Admin', '$2b$12$...', 'ADMIN'),
('john.lecturer', 'john@fpt.edu.vn', 'John Doe', '$2b$12$...', 'LECTURER'),
('jane.student', 'jane@student.fpt.edu.vn', 'Jane Smith', '$2b$12$...', 'STUDENT');
```

---

### Table 2: subjects

**Purpose**: Qu·∫£n l√Ω m√¥n h·ªçc

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Subject ID |
| `code` | VARCHAR(20) | UNIQUE, NOT NULL | - | M√£ m√¥n h·ªçc (VD: SE101) |
| `name` | VARCHAR(255) | NOT NULL | - | T√™n m√¥n h·ªçc |
| `credits` | INTEGER | NOT NULL | - | S·ªë t√≠n ch·ªâ |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ m√¥n h·ªçc |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE INDEX idx_subjects_name ON subjects(name);
```

**Sample Data:**
```sql
INSERT INTO subjects (code, name, credits, description) VALUES
('SE101', 'Software Engineering', 3, 'Introduction to Software Engineering'),
('SE401', 'Capstone Project', 6, 'Final year capstone project');
```

---

### Table 3: curricula

**Purpose**: N·ªôi dung gi·∫£ng d·∫°y theo tu·∫ßn

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Curriculum ID |
| `subject_id` | INTEGER | FOREIGN KEY ‚Üí subjects(id), NOT NULL | - | M√¥n h·ªçc |
| `content` | TEXT | NOT NULL | - | N·ªôi dung h·ªçc |
| `week_number` | INTEGER | NULL | NULL | Tu·∫ßn h·ªçc (1-15) |
| `learning_outcomes` | TEXT | NULL | NULL | ƒê·∫ßu ra h·ªçc t·∫≠p |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_curricula_subject_id ON curricula(subject_id);
CREATE INDEX idx_curricula_week ON curricula(subject_id, week_number);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE
```

---

### Table 4: classes

**Purpose**: Qu·∫£n l√Ω l·ªõp h·ªçc

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Class ID |
| `code` | VARCHAR(50) | UNIQUE, NOT NULL | - | M√£ l·ªõp (VD: SE1701) |
| `name` | VARCHAR(255) | NOT NULL | - | T√™n l·ªõp |
| `subject_id` | INTEGER | FOREIGN KEY ‚Üí subjects(id), NOT NULL | - | M√¥n h·ªçc |
| `lecturer_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Gi·∫£ng vi√™n ph·ª• tr√°ch |
| `semester` | VARCHAR(20) | NOT NULL | - | H·ªçc k·ª≥ (Spring2025) |
| `academic_year` | VARCHAR(20) | NOT NULL | - | NƒÉm h·ªçc (2024-2025) |
| `max_students` | INTEGER | NULL | 40 | S·ªë SV t·ªëi ƒëa |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
CREATE INDEX idx_classes_subject_id ON classes(subject_id);
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_classes_semester ON classes(semester);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE RESTRICT,
FOREIGN KEY (lecturer_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 5: class_members

**Purpose**: Sinh vi√™n trong l·ªõp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `class_id` | INTEGER | FOREIGN KEY ‚Üí classes(id), NOT NULL | - | L·ªõp h·ªçc |
| `student_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Sinh vi√™n |
| `role` | VARCHAR(20) | NOT NULL | 'MEMBER' | MEMBER/MONITOR |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y tham gia |

**Indexes:**
```sql
CREATE INDEX idx_class_members_class_id ON class_members(class_id);
CREATE INDEX idx_class_members_student_id ON class_members(student_id);
CREATE UNIQUE INDEX idx_class_members_unique ON class_members(class_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 6: projects

**Purpose**: Qu·∫£n l√Ω ƒë·ªÅ t√†i d·ª± √°n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Project ID |
| `title` | VARCHAR(255) | NOT NULL | - | T√™n ƒë·ªÅ t√†i |
| `description` | TEXT | NOT NULL | - | M√¥ t·∫£ chi ti·∫øt |
| `objectives` | TEXT | NULL | NULL | M·ª•c ti√™u |
| `scope` | TEXT | NULL | NULL | Ph·∫°m vi |
| `expected_outcomes` | TEXT | NULL | NULL | K·∫øt qu·∫£ mong ƒë·ª£i |
| `created_by` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi t·∫°o (Lecturer) |
| `approved_by` | INTEGER | FOREIGN KEY ‚Üí users(id), NULL | NULL | Ng∆∞·ªùi duy·ªát (Head) |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/APPROVED/REJECTED |
| `approval_status` | VARCHAR(20) | NULL | NULL | Tr·∫°ng th√°i duy·ªát |
| `rejection_reason` | TEXT | NULL | NULL | L√Ω do t·ª´ ch·ªëi (n·∫øu rejected) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |

**Indexes:**
```sql
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_approval_status ON projects(approval_status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 7: project_milestones

**Purpose**: C√°c c·ªôt m·ªëc c·ªßa d·ª± √°n (template)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `project_id` | INTEGER | FOREIGN KEY ‚Üí projects(id), NOT NULL | - | D·ª± √°n |
| `title` | VARCHAR(255) | NOT NULL | - | T√™n milestone |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ |
| `order_index` | INTEGER | NOT NULL | - | Th·ª© t·ª± (1, 2, 3...) |
| `duration_weeks` | INTEGER | NULL | NULL | Th·ªùi l∆∞·ª£ng ∆∞·ªõc t√≠nh (tu·∫ßn) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_project_milestones_project_id ON project_milestones(project_id);
CREATE INDEX idx_project_milestones_order ON project_milestones(project_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 8: class_projects

**Purpose**: G√°n d·ª± √°n cho l·ªõp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Assignment ID |
| `class_id` | INTEGER | FOREIGN KEY ‚Üí classes(id), NOT NULL | - | L·ªõp h·ªçc |
| `project_id` | INTEGER | FOREIGN KEY ‚Üí projects(id), NOT NULL | - | D·ª± √°n |
| `assigned_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y g√°n |
| `max_groups` | INTEGER | NULL | NULL | S·ªë nh√≥m t·ªëi ƒëa c√≥ th·ªÉ ch·ªçn |

**Indexes:**
```sql
CREATE INDEX idx_class_projects_class_id ON class_projects(class_id);
CREATE INDEX idx_class_projects_project_id ON class_projects(project_id);
CREATE UNIQUE INDEX idx_class_projects_unique ON class_projects(class_id, project_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 9: groups

**Purpose**: Nh√≥m sinh vi√™n l√†m d·ª± √°n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Group ID |
| `name` | VARCHAR(255) | NOT NULL | - | T√™n nh√≥m |
| `class_id` | INTEGER | FOREIGN KEY ‚Üí classes(id), NOT NULL | - | L·ªõp h·ªçc |
| `project_id` | INTEGER | FOREIGN KEY ‚Üí projects(id), NOT NULL | - | D·ª± √°n ƒë∆∞·ª£c ch·ªçn |
| `leader_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Nh√≥m tr∆∞·ªüng |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ nh√≥m |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |

**Indexes:**
```sql
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_groups_project_id ON groups(project_id);
CREATE INDEX idx_groups_leader_id ON groups(leader_id);
CREATE INDEX idx_groups_status ON groups(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE RESTRICT,
FOREIGN KEY (leader_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 10: group_members

**Purpose**: Th√†nh vi√™n trong nh√≥m

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `student_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Sinh vi√™n |
| `role` | VARCHAR(50) | NULL | 'MEMBER' | LEADER/MEMBER/... |
| `contribution_score` | FLOAT | NOT NULL | 0.0 | ƒêi·ªÉm ƒë√≥ng g√≥p (0-100) |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y tham gia |

**Indexes:**
```sql
CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_student_id ON group_members(student_id);
CREATE UNIQUE INDEX idx_group_members_unique ON group_members(group_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 11: group_milestones

**Purpose**: Milestone c·ªßa t·ª´ng nh√≥m (copy t·ª´ project_milestones)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `title` | VARCHAR(255) | NOT NULL | - | T√™n milestone |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/IN_PROGRESS/COMPLETED |
| `is_completed` | BOOLEAN | NOT NULL | FALSE | ƒê√£ ho√†n th√†nh ch∆∞a |
| `completed_at` | TIMESTAMP | NULL | NULL | Ng√†y ho√†n th√†nh |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_group_milestones_group_id ON group_milestones(group_id);
CREATE INDEX idx_group_milestones_deadline ON group_milestones(deadline);
CREATE INDEX idx_group_milestones_status ON group_milestones(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 12: checkpoints

**Purpose**: ƒêi·ªÉm ki·ªÉm tra/n·ªôp b√†i trong milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Checkpoint ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `title` | VARCHAR(255) | NOT NULL | - | T√™n checkpoint |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `assigned_members` | JSON | NULL | NULL | Danh s√°ch th√†nh vi√™n ƒë∆∞·ª£c g√°n |
| `submission_url` | TEXT | NULL | NULL | Link n·ªôp b√†i |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/EVALUATED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_checkpoints_group_id ON checkpoints(group_id);
CREATE INDEX idx_checkpoints_deadline ON checkpoints(deadline);
CREATE INDEX idx_checkpoints_status ON checkpoints(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 13: tasks

**Purpose**: Task trong Kanban board (workspace)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Task ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `title` | VARCHAR(255) | NOT NULL | - | T√™n task |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ chi ti·∫øt |
| `assigned_to` | INTEGER | FOREIGN KEY ‚Üí users(id), NULL | NULL | Ng∆∞·ªùi ƒë∆∞·ª£c g√°n |
| `status` | VARCHAR(20) | NOT NULL | 'TODO' | TODO/IN_PROGRESS/DONE |
| `priority` | VARCHAR(20) | NOT NULL | 'MEDIUM' | LOW/MEDIUM/HIGH |
| `due_date` | TIMESTAMP | NULL | NULL | H·∫°n ho√†n th√†nh |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y c·∫≠p nh·∫≠t |

**Indexes:**
```sql
CREATE INDEX idx_tasks_group_id ON tasks(group_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 14: meetings

**Purpose**: Cu·ªôc h·ªçp nh√≥m

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Meeting ID |
| `title` | VARCHAR(255) | NOT NULL | - | Ti√™u ƒë·ªÅ cu·ªôc h·ªçp |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `created_by` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi t·∫°o |
| `scheduled_at` | TIMESTAMP | NOT NULL | - | Th·ªùi gian h·ªçp |
| `duration` | INTEGER | NULL | 60 | Th·ªùi l∆∞·ª£ng (ph√∫t) |
| `meeting_url` | TEXT | NULL | NULL | Link meeting (Zoom/Google Meet) |
| `status` | VARCHAR(20) | NOT NULL | 'SCHEDULED' | SCHEDULED/IN_PROGRESS/COMPLETED/CANCELLED |
| `notes` | TEXT | NULL | NULL | Ghi ch√∫ |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_meetings_group_id ON meetings(group_id);
CREATE INDEX idx_meetings_created_by ON meetings(created_by);
CREATE INDEX idx_meetings_scheduled_at ON meetings(scheduled_at);
CREATE INDEX idx_meetings_status ON meetings(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 15: meeting_participants

**Purpose**: Ng∆∞·ªùi tham gia cu·ªôc h·ªçp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Participant ID |
| `meeting_id` | INTEGER | FOREIGN KEY ‚Üí meetings(id), NOT NULL | - | Cu·ªôc h·ªçp |
| `user_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi tham gia |
| `status` | VARCHAR(20) | NOT NULL | 'INVITED' | INVITED/ACCEPTED/DECLINED/ATTENDED |
| `joined_at` | TIMESTAMP | NULL | NULL | Th·ªùi gian join |

**Indexes:**
```sql
CREATE INDEX idx_meeting_participants_meeting_id ON meeting_participants(meeting_id);
CREATE INDEX idx_meeting_participants_user_id ON meeting_participants(user_id);
CREATE UNIQUE INDEX idx_meeting_participants_unique ON meeting_participants(meeting_id, user_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (meeting_id) REFERENCES meetings(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 16: chat_messages

**Purpose**: Tin nh·∫Øn chat

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Message ID |
| `sender_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi g·ª≠i |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NULL | NULL | Nh√≥m (n·∫øu group chat) |
| `class_id` | INTEGER | FOREIGN KEY ‚Üí classes(id), NULL | NULL | L·ªõp (n·∫øu class chat) |
| `message` | TEXT | NOT NULL | - | N·ªôi dung tin nh·∫Øn |
| `message_type` | VARCHAR(20) | NOT NULL | 'TEXT' | TEXT/FILE/IMAGE/VIDEO |
| `file_url` | TEXT | NULL | NULL | URL file ƒë√≠nh k√®m |
| `is_read` | BOOLEAN | NOT NULL | FALSE | ƒê√£ ƒë·ªçc ch∆∞a |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Th·ªùi gian g·ª≠i |

**Indexes:**
```sql
CREATE INDEX idx_chat_messages_sender_id ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
CREATE INDEX idx_chat_messages_class_id ON chat_messages(class_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at DESC);
CREATE INDEX idx_chat_messages_group_created ON chat_messages(group_id, created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 17: resources

**Purpose**: T√†i li·ªáu/t√†i nguy√™n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Resource ID |
| `title` | VARCHAR(255) | NOT NULL | - | Ti√™u ƒë·ªÅ |
| `description` | TEXT | NULL | NULL | M√¥ t·∫£ |
| `file_url` | TEXT | NOT NULL | - | URL file (Cloudinary) |
| `file_type` | VARCHAR(50) | NULL | NULL | Lo·∫°i file (PDF, DOCX...) |
| `file_size` | INTEGER | NULL | NULL | K√≠ch th∆∞·ªõc (bytes) |
| `uploaded_by` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi upload |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NULL | NULL | Nh√≥m (n·∫øu nh√≥m upload) |
| `class_id` | INTEGER | FOREIGN KEY ‚Üí classes(id), NULL | NULL | L·ªõp (n·∫øu gi·∫£ng vi√™n upload) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y upload |

**Indexes:**
```sql
CREATE INDEX idx_resources_uploaded_by ON resources(uploaded_by);
CREATE INDEX idx_resources_group_id ON resources(group_id);
CREATE INDEX idx_resources_class_id ON resources(class_id);
CREATE INDEX idx_resources_created_at ON resources(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 18: whiteboard_sessions

**Purpose**: Phi√™n b·∫£ng tr·∫Øng c·ªông t√°c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Session ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `session_name` | VARCHAR(255) | NULL | NULL | T√™n phi√™n |
| `data` | JSON | NULL | NULL | D·ªØ li·ªáu v·∫Ω (JSON) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | L·∫ßn c·∫≠p nh·∫≠t cu·ªëi |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_whiteboard_sessions_group_id ON whiteboard_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 19: document_sessions

**Purpose**: Phi√™n ch·ªânh s·ª≠a t√†i li·ªáu c·ªông t√°c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Document ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `title` | VARCHAR(255) | NOT NULL | - | Ti√™u ƒë·ªÅ t√†i li·ªáu |
| `content` | TEXT | NULL | NULL | N·ªôi dung (HTML/Markdown) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | L·∫ßn c·∫≠p nh·∫≠t cu·ªëi |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_document_sessions_group_id ON document_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 20: peer_reviews

**Purpose**: ƒê√°nh gi√° ƒë·ªìng nghi·ªáp (peer review)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Review ID |
| `reviewer_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi ƒë√°nh gi√° |
| `reviewee_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `period` | VARCHAR(50) | NOT NULL | - | Giai ƒëo·∫°n (Midterm/Final) |
| `rating` | INTEGER | NOT NULL | - | ƒêi·ªÉm (1-5) |
| `comments` | TEXT | NULL | NULL | Nh·∫≠n x√©t |
| `criteria` | JSON | NULL | NULL | Ti√™u ch√≠ ƒë√°nh gi√° (JSON) |
| `is_anonymous` | BOOLEAN | NOT NULL | TRUE | ·∫®n danh hay kh√¥ng |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y ƒë√°nh gi√° |

**Indexes:**
```sql
CREATE INDEX idx_peer_reviews_reviewer_id ON peer_reviews(reviewer_id);
CREATE INDEX idx_peer_reviews_reviewee_id ON peer_reviews(reviewee_id);
CREATE INDEX idx_peer_reviews_group_id ON peer_reviews(group_id);
CREATE INDEX idx_peer_reviews_period ON peer_reviews(period);
```

**Constraints:**
```sql
CHECK (rating >= 1 AND rating <= 5)
```

**Foreign Keys:**
```sql
FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (reviewee_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 21: group_evaluations

**Purpose**: ƒê√°nh gi√° nh√≥m b·ªüi gi·∫£ng vi√™n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `evaluator_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi ƒë√°nh gi√° (Lecturer) |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Lo·∫°i (Progress/Final/Presentation) |
| `score` | FLOAT | NOT NULL | - | ƒêi·ªÉm (0-10) |
| `feedback` | TEXT | NULL | NULL | Ph·∫£n h·ªìi |
| `criteria` | JSON | NULL | NULL | Ti√™u ch√≠ (JSON) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y ƒë√°nh gi√° |

**Indexes:**
```sql
CREATE INDEX idx_group_evaluations_group_id ON group_evaluations(group_id);
CREATE INDEX idx_group_evaluations_evaluator_id ON group_evaluations(evaluator_id);
CREATE INDEX idx_group_evaluations_type ON group_evaluations(evaluation_type);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 22: member_evaluations

**Purpose**: ƒê√°nh gi√° th√†nh vi√™n b·ªüi gi·∫£ng vi√™n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_member_id` | INTEGER | FOREIGN KEY ‚Üí group_members(id), NOT NULL | - | Th√†nh vi√™n |
| `evaluator_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi ƒë√°nh gi√° |
| `score` | FLOAT | NOT NULL | - | ƒêi·ªÉm (0-10) |
| `feedback` | TEXT | NULL | NULL | Ph·∫£n h·ªìi |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Lo·∫°i ƒë√°nh gi√° |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y ƒë√°nh gi√° |

**Indexes:**
```sql
CREATE INDEX idx_member_evaluations_member_id ON member_evaluations(group_member_id);
CREATE INDEX idx_member_evaluations_evaluator_id ON member_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_member_id) REFERENCES group_members(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 23: checkpoint_evaluations

**Purpose**: ƒê√°nh gi√° checkpoint

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `checkpoint_id` | INTEGER | FOREIGN KEY ‚Üí checkpoints(id), NOT NULL | - | Checkpoint |
| `evaluator_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi ƒë√°nh gi√° |
| `score` | FLOAT | NOT NULL | - | ƒêi·ªÉm (0-10) |
| `feedback` | TEXT | NULL | NULL | Ph·∫£n h·ªìi |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y ƒë√°nh gi√° |

**Indexes:**
```sql
CREATE INDEX idx_checkpoint_evaluations_checkpoint_id ON checkpoint_evaluations(checkpoint_id);
CREATE INDEX idx_checkpoint_evaluations_evaluator_id ON checkpoint_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (checkpoint_id) REFERENCES checkpoints(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 24: milestone_questions

**Purpose**: C√¢u h·ªèi cho t·ª´ng milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Question ID |
| `milestone_id` | INTEGER | FOREIGN KEY ‚Üí project_milestones(id), NOT NULL | - | Milestone template |
| `question` | TEXT | NOT NULL | - | N·ªôi dung c√¢u h·ªèi |
| `order_index` | INTEGER | NOT NULL | - | Th·ª© t·ª± (1, 2, 3...) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |

**Indexes:**
```sql
CREATE INDEX idx_milestone_questions_milestone_id ON milestone_questions(milestone_id);
CREATE INDEX idx_milestone_questions_order ON milestone_questions(milestone_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (milestone_id) REFERENCES project_milestones(id) ON DELETE CASCADE
```

---

### Table 25: milestone_answers

**Purpose**: C√¢u tr·∫£ l·ªùi c·ªßa nh√≥m cho milestone questions

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Answer ID |
| `question_id` | INTEGER | FOREIGN KEY ‚Üí milestone_questions(id), NOT NULL | - | C√¢u h·ªèi |
| `group_id` | INTEGER | FOREIGN KEY ‚Üí groups(id), NOT NULL | - | Nh√≥m |
| `user_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi tr·∫£ l·ªùi |
| `answer` | TEXT | NOT NULL | - | C√¢u tr·∫£ l·ªùi |
| `submitted_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y n·ªôp |

**Indexes:**
```sql
CREATE INDEX idx_milestone_answers_question_id ON milestone_answers(question_id);
CREATE INDEX idx_milestone_answers_group_id ON milestone_answers(group_id);
CREATE INDEX idx_milestone_answers_user_id ON milestone_answers(user_id);
CREATE UNIQUE INDEX idx_milestone_answers_unique ON milestone_answers(question_id, group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (question_id) REFERENCES milestone_questions(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 26: notifications

**Purpose**: Th√¥ng b√°o h·ªá th·ªëng

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Notification ID |
| `user_id` | INTEGER | FOREIGN KEY ‚Üí users(id), NOT NULL | - | Ng∆∞·ªùi nh·∫≠n |
| `type` | VARCHAR(50) | NOT NULL | - | Lo·∫°i (PROJECT_APPROVED, CHAT_MESSAGE...) |
| `title` | VARCHAR(255) | NOT NULL | - | Ti√™u ƒë·ªÅ |
| `content` | TEXT | NOT NULL | - | N·ªôi dung |
| `link` | TEXT | NULL | NULL | Link li√™n quan |
| `is_read` | BOOLEAN | NOT NULL | FALSE | ƒê√£ ƒë·ªçc ch∆∞a |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ng√†y t·∫°o |
| `read_at` | TIMESTAMP | NULL | NULL | Ng√†y ƒë·ªçc |

**Indexes:**
```sql
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_is_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Tables 27-28: Additional Tables (Optional)

#### Table 27: project_tags

**Purpose**: Tag cho project (AI-generated ho·∫∑c manual)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Tag ID |
| `project_id` | INTEGER | FOREIGN KEY ‚Üí projects | Project |
| `tag` | VARCHAR(50) | NOT NULL | Tag name |

#### Table 28: activity_logs

**Purpose**: Audit trail / activity logs

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Log ID |
| `user_id` | INTEGER | FOREIGN KEY ‚Üí users | User |
| `action` | VARCHAR(100) | NOT NULL | Action type |
| `entity_type` | VARCHAR(50) | NOT NULL | Entity affected |
| `entity_id` | INTEGER | NULL | Entity ID |
| `timestamp` | TIMESTAMP | NOT NULL | When |

---

## 4.2.5. DATABASE OPTIMIZATION

### Indexes Strategy

**1. Primary Key Indexes** (T·ª± ƒë·ªông):
- M·ªçi b·∫£ng ƒë·ªÅu c√≥ PK index tr√™n `id`

**2. Foreign Key Indexes** (B·∫Øt bu·ªôc):
```sql
-- Performance cho JOIN queries
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
-- ... (t·ªïng ~40 FK indexes)
```

**3. Composite Indexes** (T·ªëi ∆∞u queries th∆∞·ªùng d√πng):
```sql
-- Chat messages by group, sorted by time
CREATE INDEX idx_chat_messages_group_created 
ON chat_messages(group_id, created_at DESC);

-- Notifications by user, filtered by read status
CREATE INDEX idx_notifications_user_read 
ON notifications(user_id, is_read);

-- Peer reviews by reviewee and period
CREATE INDEX idx_peer_reviews_reviewee_period 
ON peer_reviews(reviewee_id, period);
```

**4. Unique Indexes** (Business rules):
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
```

### Query Optimization Examples

**Query 1: L·∫•y t·∫•t c·∫£ chat messages c·ªßa nh√≥m**
```sql
-- T·ªëi ∆∞u v·ªõi index idx_chat_messages_group_created
SELECT * FROM chat_messages 
WHERE group_id = 123 
ORDER BY created_at DESC 
LIMIT 50;

-- EXPLAIN: Index Scan on idx_chat_messages_group_created
```

**Query 2: L·∫•y notifications ch∆∞a ƒë·ªçc c·ªßa user**
```sql
-- T·ªëi ∆∞u v·ªõi index idx_notifications_user_read
SELECT * FROM notifications 
WHERE user_id = 456 AND is_read = FALSE 
ORDER BY created_at DESC;

-- EXPLAIN: Index Scan on idx_notifications_user_read
```

**Query 3: L·∫•y nh√≥m v√† th√†nh vi√™n**
```sql
-- S·ª≠ d·ª•ng JOIN v·ªõi FK indexes
SELECT g.*, u.full_name as leader_name 
FROM groups g 
JOIN users u ON g.leader_id = u.id 
WHERE g.class_id = 789;

-- EXPLAIN: Index Scan on idx_groups_class_id, Index Scan on users_pkey
```

### Connection Pooling

**SQLModel Configuration:**
```python
# app/database.py
from sqlmodel import create_engine, Session

DATABASE_URL = "postgresql://user:pass@localhost:5432/collabsphere_db"

# Connection pool settings
engine = create_engine(
    DATABASE_URL,
    echo=False,
    pool_size=10,        # Number of connections to keep open
    max_overflow=20,     # Max additional connections
    pool_timeout=30,     # Timeout for getting connection
    pool_pre_ping=True   # Test connection before use
)
```

---

## 4.2.6. DATABASE BACKUP & RECOVERY

### Backup Strategy

**1. Daily Automated Backup:**
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -h localhost -U collabsphere_user -d collabsphere_db \
  -F c -f /backups/collabsphere_backup_$DATE.dump

# Retention: Keep last 30 days
find /backups -name "collabsphere_backup_*.dump" -mtime +30 -delete
```

**2. Restore from Backup:**
```bash
pg_restore -h localhost -U collabsphere_user -d collabsphere_db \
  -c /backups/collabsphere_backup_20260104_120000.dump
```

### Recovery Time Objective (RTO)

- **Target RTO**: < 4 hours
- **Target RPO** (Recovery Point Objective): < 1 day (daily backup)

---

## 4.2.7. DATABASE MIGRATIONS (Alembic)

### Migration Files

**Location**: `collabsphere/backend/alembic/versions/`

**Example Migration:**
```python
"""create users table

Revision ID: 001_create_users
Revises: 
Create Date: 2026-01-04 10:00:00
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(100), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('full_name', sa.String(255), nullable=False),
        sa.Column('hashed_password', sa.String(255), nullable=False),
        sa.Column('role', sa.String(20), nullable=False, server_default='STUDENT'),
        sa.Column('avatar_url', sa.Text(), nullable=True),
        sa.Column('phone', sa.String(20), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=False, server_default='true'),
        sa.Column('created_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('updated_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('last_login', sa.TIMESTAMP(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_users_username', 'users', ['username'], unique=True)
    op.create_index('idx_users_email', 'users', ['email'], unique=True)

def downgrade():
    op.drop_index('idx_users_email')
    op.drop_index('idx_users_username')
    op.drop_table('users')
```

### Run Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Show migration history
alembic history

# Generate new migration
alembic revision --autogenerate -m "description"
```

---

## 4.2.8. DATABASE SECURITY

### Security Measures

1. **Password Security**:
   - Use environment variables for DB credentials
   - Never commit passwords to Git
   - Rotate passwords quarterly

2. **Access Control**:
   ```sql
   -- Create limited user for application
   CREATE USER collabsphere_app WITH PASSWORD 'secure_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_app;
   GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO collabsphere_app;
   
   -- Read-only user for reports
   CREATE USER collabsphere_readonly WITH PASSWORD 'readonly_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_readonly;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO collabsphere_readonly;
   ```

3. **Encryption**:
   - TLS/SSL for connections: `sslmode=require`
   - Encrypt backups
   - Encrypt sensitive columns (if needed)

4. **Audit Logging**:
   - Log all DDL operations
   - Log failed login attempts
   - Monitor suspicious queries

---

## 4.2.9. DATABASE MONITORING

### Metrics to Monitor

1. **Performance Metrics**:
   - Query execution time
   - Connection pool usage
   - Cache hit ratio
   - Index usage statistics

2. **Capacity Metrics**:
   - Database size growth
   - Table sizes
   - Index sizes

3. **Health Metrics**:
   - Active connections
   - Long-running queries
   - Deadlocks

### Monitoring Queries

```sql
-- Check database size
SELECT pg_size_pretty(pg_database_size('collabsphere_db'));

-- Check table sizes
SELECT schemaname, tablename, 
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Check active connections
SELECT count(*) FROM pg_stat_activity 
WHERE datname = 'collabsphere_db';

-- Find slow queries
SELECT pid, now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - query_start > interval '5 seconds';
```

---

**[‚Üê Back to 4.1 System Design](4.1-SystemDesign.md)** | **[Next: 4.3 Detailed Design ‚Üí](4.3-DetailedDesign.md)**
