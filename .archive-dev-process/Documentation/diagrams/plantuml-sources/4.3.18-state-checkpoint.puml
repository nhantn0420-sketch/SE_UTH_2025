@startuml 4.3.18-state-checkpoint
!theme plain

' ============================================
' STYLING
' ============================================
skinparam stateFontSize 11
skinparam stateFontName Arial
skinparam backgroundColor #FAFAFA
skinparam roundcorner 5
skinparam shadowing false

skinparam state {
    BackgroundColor #FFFFFF
    BorderColor #1976D2
    BorderThickness 2
    FontStyle bold
    FontSize 11
    AttributeFontSize 9
}

skinparam arrow {
    Color #424242
    Thickness 2
    FontSize 9
}

title <size:16><b>Checkpoint Submission - State Machine Diagram</b></size>\n<size:11>UML 2.5 State Machine for Checkpoint Entity</size>

' ============================================
' STATE MACHINE
' ============================================

[*] --> NotStarted : createCheckpoint() / initDeadline()

state NotStarted <<state>> {
  NotStarted : entry / setDeadline(date)
  NotStarted : do / waitForGroupToStart()
  NotStarted : exit / recordStartTime()
}

NotStarted --> InProgress : startWork() [beforeDeadline() && isGroupLeader()]
NotStarted --> Missed : [deadlinePassed() && !hasSubmission()]

state InProgress <<composite state>> {
  InProgress : entry / trackWorkTime()
  InProgress : do / enableAutoSave()
  InProgress : exit / validateAllFiles()
  
  [*] --> Working
  
  state Working <<substate>> {
    Working : do / editContent()
    Working : do / collaborateWithTeam()
  }
  
  state UploadingFiles <<substate>> {
    UploadingFiles : do / uploadToCloudinary()
    UploadingFiles : do / validateFileTypes()
  }
  
  Working --> UploadingFiles : attachFiles() [hasFilesToUpload()]
  UploadingFiles --> Working : addMoreContent() [needsMoreWork()]
}

InProgress --> Submitted : submit() [beforeDeadline() && allFilesAttached()]
InProgress --> Late : submit() [afterDeadline() && withinGracePeriod()]
InProgress --> NotStarted : cancel() [isGroupLeader()]

state Submitted <<state>> {
  Submitted : entry / lockSubmission()
  Submitted : do / notifyLecturer()
  Submitted : do / runPlagiarismCheck()
  Submitted : exit / prepareForGrading()
}

Submitted --> UnderReview : startReview() [lecturer.canGrade()]

state Late <<state>> {
  Late : entry / calculateLatePenalty()
  Late : do / lockSubmission()
  Late : exit / applyPenaltyToGrade()
}

Late --> UnderReview : startReview() [latePenaltyApplied()]

state UnderReview <<state>> {
  UnderReview : entry / assignToLecturer()
  UnderReview : do / lecturerEvaluates()
  UnderReview : exit / recordGradeAndFeedback()
}

UnderReview --> Graded : completeEvaluation() [gradeEntered()]
UnderReview --> Resubmission : requestRevision() [needsImprovement()]

state Resubmission <<state>> {
  Resubmission : entry / notifyGroup(reason)
  Resubmission : do / waitForResubmission()
  Resubmission : exit / validateChanges()
}

Resubmission --> Submitted : resubmit() [withinGracePeriod() && changesValid()]
Resubmission --> Failed : [gracePeriodExpired() && !resubmitted()]

state Graded <<state>> {
  Graded : entry / lockGrade()
  Graded : do / notifyAllGroupMembers()
  Graded : exit / updateOverallGrade()
}

Graded --> Appealed : submitAppeal() [withinAppealWindow() && hasValidReason()]
Graded --> Final : [appealDeadlinePassed() || acceptGrade()]

state Appealed <<state>> {
  Appealed : entry / notifyDepartmentHead()
  Appealed : do / headReviewsAppeal()
  Appealed : exit / recordAppealDecision()
}

Appealed --> Graded : rejectAppeal() [!appealValid() || gradeCorrect()]
Appealed --> Regraded : acceptAppeal() [appealValid() && needsRegrade()]

state Regraded <<state>> {
  Regraded : entry / assignToDifferentLecturer()
  Regraded : do / reevaluateWork()
  Regraded : exit / lockNewGrade()
}

Regraded --> Final : finalize() [newGradeConfirmed()]

state Missed <<state>> {
  Missed : entry / recordAbsence()
  Missed : do / applyZeroGrade()
  Missed : exit / notifyGroupAndLecturer()
}

Missed --> Late : lateSubmit() [gracePeriodActive() && daysLate <= 3]
Missed --> Failed : [gracePeriodExpired() || !submitted()]

state Failed <<state>> {
  Failed : entry / recordFailure()
  Failed : do / calculateImpactOnFinalGrade()
  Failed : exit / lockAsFailed()
}

Failed --> Final : finalize() [gradeCalculated()]

state Final <<final state>> {
  Final : entry / archiveSubmission()
  Final : do / enableReadOnlyAccess()
  Final : exit / includeInFinalReport()
}

Final --> [*] : [reportGenerated()]

note right of NotStarted
  <b><<state>> NotStarted</b>
  <b>Invariants:</b>
  • hasDeadline == true
  • canSubmit == false
  • status == "PENDING_START"
  
  <b>Automatic Notifications:</b>
  • remind(group) @ deadline - 3 days
  • remind(group) @ deadline - 1 day
  • remind(group) @ deadline - 2 hours
end note

note right of Submitted
  <b><<state>> Submitted</b>
  <b>Invariants:</b>
  • isImmutable == true
  • hasTimestamp == true
  • filesLocked == true
  
  <b>Automatic Actions:</b>
  • runPlagiarismCheck() via Turnitin API
  • notifyLecturer() via email + in-app
  • recordTimestamp() in database
end note

note right of Late
  <b><<state>> Late</b>
  <b>Late Penalty Formula:</b>
  penalty = min(daysLate * 10%, 30%)
  finalGrade = rawGrade * (1 - penalty/100)
  
  <b>Examples:</b>
  • 1 day late: -10% (85 × 0.9 = 76.5)
  • 2 days late: -20% (85 × 0.8 = 68)
  • 3 days late: -30% (85 × 0.7 = 59.5)
  • >3 days: auto-fail (0 points)
  
  <b>Override:</b>
  Lecturer can waive penalty with justification
end note

note bottom
  <b>UML 2.5 State Machine Specification</b>
  
  <b>Business Rules (OCL Constraints):</b>
  
  context Checkpoint::submit()
    pre: self.status == InProgress
    pre: self.hasAllRequiredFiles()
    pre: self.isGroupLeader(user)
    post: self.status in [Submitted, Late]
    post: self.submissionTime != null
  
  context Lecturer::grade(checkpoint, score)
    pre: checkpoint.status == UnderReview
    pre: score >= 0 && score <= 10
    pre: self.canGrade(checkpoint)
    post: checkpoint.status == Graded
    post: checkpoint.grade == score
  
  context Student::appeal(checkpoint, reason)
    pre: checkpoint.status == Graded
    pre: currentDate - checkpoint.gradedDate <= 3 days
    pre: reason.length >= 50 chars
    post: checkpoint.status == Appealed
  
  <b>State Invariants:</b>
  • InProgress: canEdit == true
  • Submitted|Late: canEdit == false
  • Final: canView == true && canEdit == false
  
  <b>Grading Scale:</b>
  • 9.0-10.0: Excellent (A)
  • 8.0-8.9: Very Good (B+)
  • 7.0-7.9: Good (B)
  • 6.0-6.9: Satisfactory (C+)
  • 5.0-5.9: Pass (C)
  • 0-4.9: Fail (F)
  
  <b>Weight in Final Grade:</b>
  • CP1: 5%, CP2: 10%, CP3: 15%, CP4: 20%
  • Total Checkpoints: 50% of final grade
  
  <b>Time Constraints:</b>
  • Submission deadline: as configured
  • Grace period: 3 days (with penalty)
  • Grading deadline: 7 days after submission
  • Appeal window: 3 days after grade release
  • Regrade turnaround: 3 days
  • Resubmission window: 24 hours
  
  <b>Typical Scenarios:</b>
  1. On-time: NotStarted → InProgress → Submitted → UnderReview → Graded → Final
  2. Late: NotStarted → InProgress → Late → UnderReview → Graded → Final
  3. Appeal: Graded → Appealed → Regraded → Final
  4. Missed: NotStarted → Missed → Failed → Final
  5. Revision: UnderReview → Resubmission → Submitted → UnderReview → Graded
end note

@enduml
