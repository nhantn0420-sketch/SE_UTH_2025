@startuml Peer Review Flow
!define PRIMARY_COLOR #E3F2FD
!define SECONDARY_COLOR #FFF3E0
!define SUCCESS_COLOR #E8F5E9
!define ERROR_COLOR #FFEBEE

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam defaultFontSize 11

title Peer Review Flow (UC041)

actor "Student" as student #E3F2FD
participant "Frontend\n(React)" as frontend #FFF3E0
participant "Backend\n(FastAPI)" as backend #E8F5E9
database "Database\n(PostgreSQL)" as db #F3E5F5

== Peer Review Period Starts ==

student -> frontend: Receive notification:\n"Peer Review Available\nfor Milestone X"
activate frontend

note right of frontend
  Trigger: Milestone completed
  or specific review period set
  by lecturer
end note

frontend --> student: Show notification\nwith "Start Review" link
deactivate frontend

== Navigate to Peer Review ==

student -> frontend: Click "Start Review"\nor navigate to Peer Reviews
activate frontend

frontend -> backend: GET /api/peer-reviews/available
activate backend

backend -> backend: Verify student\nis in team

backend -> db: SELECT group_members\nWHERE group_id IN\n(SELECT group_id FROM group_members\nWHERE user_id = ?)\nAND user_id != ?\nAND is_active = true
activate db

note right of db
  Get all team members
  except the reviewer (self)
end note

db --> backend: Team members to review
deactivate db

backend -> db: SELECT existing peer_reviews\nWHERE reviewer_id = ?\nAND milestone_id = ?
activate db
db --> backend: Already submitted reviews
deactivate db

backend --> frontend: 200 OK\n{members_to_review: [...],\nexisting_reviews: [...]}
deactivate backend

frontend --> student: Display review form\nfor each team member:\n- Member name, avatar\n- 4 score sliders\n- Comment box
deactivate frontend

== Fill Review Scores ==

student -> frontend: For each team member:\nRate on 1-5 scale:
activate frontend

student -> frontend: 1. Cooperation Score\n(teamwork, helpfulness)
student -> frontend: 2. Contribution Score\n(work output, effort)
student -> frontend: 3. Communication Score\n(responsiveness, clarity)
student -> frontend: 4. Technical Skills\n(code quality, problem-solving)

student -> frontend: Enter comments (optional):\n- Strengths\n- Areas for improvement

frontend -> frontend: Validate:\n- All scores filled (1-5)\n- At least 2-3 team members reviewed\n- Comments < 500 chars

frontend --> student: Show validation\nerrors if any
deactivate frontend

== Submit Peer Reviews ==

student -> frontend: Click "Submit All Reviews"
activate frontend

frontend --> student: Show confirmation:\n"Once submitted,\nyou cannot edit reviews.\nContinue?"

student -> frontend: Confirm

frontend -> backend: POST /api/peer-reviews\n{milestone_id,\nreviewer_id,\nreviews: [\n  {reviewee_id,\n   cooperation_score,\n   contribution_score,\n   communication_score,\n   technical_score,\n   comments},\n  ...\n]}
activate backend

backend -> backend: Validate:\n- All reviewees in same team\n- Not reviewing self\n- Review period active\n- Scores in range 1-5

backend -> db: BEGIN TRANSACTION
activate db

loop For each review
    backend -> db: INSERT INTO peer_reviews\n(reviewer_id, reviewee_id,\nmilestone_id, group_id,\ncooperation_score,\ncontribution_score,\ncommunication_score,\ntechnical_score,\ncomments, reviewed_at)
    db --> backend: review_id
end

backend -> db: UPDATE user_milestone_reviews\nSET completed = true\nWHERE user_id = ?\nAND milestone_id = ?
db --> backend: Success

backend -> db: COMMIT TRANSACTION
db --> backend: Success
deactivate db

backend --> frontend: 201 Created\n{reviews_submitted: count}
deactivate backend

frontend --> student: Show success:\n"Thank you for your feedback!\nReviews submitted."
frontend -> frontend: Disable review form
deactivate frontend

== View Own Received Reviews (After Period) ==

alt Review Period Ended
    student -> frontend: Navigate to\n"My Evaluations"
    activate frontend
    
    frontend -> backend: GET /api/peer-reviews/received
    activate backend
    
    backend -> db: SELECT AVG(cooperation_score),\nAVG(contribution_score),\nAVG(communication_score),\nAVG(technical_score)\nFROM peer_reviews\nWHERE reviewee_id = ?\nAND milestone_id = ?\nGROUP BY milestone_id
    activate db
    db --> backend: Aggregated scores
    deactivate db
    
    backend -> db: SELECT comments\nFROM peer_reviews\nWHERE reviewee_id = ?\n(Anonymous - no reviewer names)
    activate db
    db --> backend: Anonymous comments
    deactivate db
    
    backend --> frontend: 200 OK\n{avg_scores: {...},\nanonymous_comments: [...]}
    deactivate backend
    
    frontend --> student: Display:\n- Average scores (radar chart)\n- Anonymous feedback\n- Strengths/weaknesses
    deactivate frontend
end

== Error Scenarios ==

alt Review Period Not Active
    backend --> frontend: 403 Forbidden\n{error: "Review period not active"}
    frontend --> student: "Peer review not available yet"
end

alt Already Submitted
    backend --> frontend: 409 Conflict\n{error: "Reviews already submitted"}
    frontend --> student: Show existing reviews\n(read-only)
end

alt Trying to Review Self
    backend --> frontend: 400 Bad Request\n{error: "Cannot review yourself"}
    frontend --> student: Remove self from list
end

alt Invalid Score Range
    frontend -> frontend: Client-side validation\nerror
    frontend --> student: "Scores must be 1-5"
end

note right of backend
  Business Rules:
  - Peer review triggered per milestone
  - Anonymous to reviewee (no names shown)
  - Required for all team members
  - Scores aggregated (average)
  - Comments visible but anonymous
  - Cannot edit after submission
  - Review period time-limited
  
  Scoring Dimensions (1-5 scale):
  1. Cooperation: Teamwork, support
  2. Contribution: Work output, effort
  3. Communication: Clarity, responsiveness
  4. Technical: Skills, quality
  
  Used by lecturer for:
  - Individual grading adjustments
  - Identifying team conflicts
  - Fair contribution assessment
end note

@enduml
