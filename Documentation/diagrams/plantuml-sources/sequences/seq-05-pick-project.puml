@startuml Student Picks Project
!define PRIMARY_COLOR #E3F2FD
!define SECONDARY_COLOR #FFF3E0
!define SUCCESS_COLOR #E8F5E9
!define ERROR_COLOR #FFEBEE

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam defaultFontSize 11

title Student Picks Project for Team (UC010)

actor "Student\n(Team Leader)" as student #E3F2FD
participant "Frontend\n(React)" as frontend #FFF3E0
participant "Backend\n(FastAPI)" as backend #E8F5E9
database "Database\n(PostgreSQL)" as db #F3E5F5

== View Available Projects ==

student -> frontend: Navigate to\nTeam Workspace
activate frontend

frontend -> backend: GET /api/groups/{group_id}/\navailable-projects
activate backend

backend -> backend: Verify student\nis team member

backend -> db: SELECT projects\nWHERE class_id = ?\nAND status = 'approved'\nAND id NOT IN\n(SELECT project_id FROM groups\nWHERE project_id IS NOT NULL\nAND class_id = ?)
activate db

note right of db
  Query filters:
  1. Projects approved for this class
  2. Projects not yet picked by any team
  in the same class
end note

db --> backend: Available projects list
deactivate db

backend --> frontend: 200 OK\n{projects: [...]}
deactivate backend

frontend --> student: Display project cards:\n- Title, Description\n- Milestones preview\n- Difficulty level
deactivate frontend

== Browse and Select Project ==

student -> frontend: Browse projects,\nread details
activate frontend

student -> frontend: Click on project\nfor full details
frontend --> student: Show project modal:\n- Full description\n- All milestones\n- Requirements
deactivate frontend

student -> frontend: Click "Pick This Project"
activate frontend

frontend --> student: Show confirmation:\n"This will assign project\nto your entire team.\nContinue?"
deactivate frontend

== Confirm and Pick ==

student -> frontend: Confirm selection
activate frontend

frontend -> backend: POST /api/groups/{group_id}/\npick-project\n{project_id}
activate backend

backend -> backend: Validate:\n- Student is team member\n- Student has leader role\n- Team has no project yet

backend -> db: BEGIN TRANSACTION
activate db

backend -> db: SELECT project_id\nFROM groups\nWHERE id = ?\nFOR UPDATE
db --> backend: current_project_id

alt Team Has No Project
    backend -> db: SELECT project_id\n FROM groups\nWHERE project_id = ?\nAND class_id = ?\nLIMIT 1
    db --> backend: Check if project available
    
    alt Project Still Available
        backend -> db: UPDATE groups\nSET project_id = ?,\nproject_picked_at = NOW()\nWHERE id = ?
        db --> backend: Success
        
        backend -> db: INSERT INTO group_milestones\n(group_id, milestone_id, status)\nSELECT ?, id, 'not_started'\nFROM project_milestones\nWHERE project_id = ?
        db --> backend: milestone_ids
        
        note right of backend
          Clone project milestones
          to group context so teams
          can track progress independently
        end note
        
        backend -> db: INSERT INTO notifications\n(user_id, type: 'project_picked')\nFOR EACH team member
        db --> backend: Success
        
        backend -> db: COMMIT TRANSACTION
        db --> backend: Success
        deactivate db
        
        backend --> frontend: 200 OK\n{group with project}
        deactivate backend
        
        frontend --> student: Show success:\n"Project assigned to team!"\nRedirect to workspace
        deactivate frontend
        
    else Project Taken (Race Condition)
        backend -> db: ROLLBACK TRANSACTION
        deactivate db
        
        backend --> frontend: 409 Conflict\n{error: "Project already picked\nby another team"}
        deactivate backend
        
        frontend --> student: Show error,\nrefresh project list
        deactivate frontend
    end
    
else Team Already Has Project
    backend -> db: ROLLBACK TRANSACTION
    deactivate db
    
    backend --> frontend: 400 Bad Request\n{error: "Team already has a project"}
    deactivate backend
    
    frontend --> student: Show error message
    deactivate frontend
end

== Error Scenarios ==

alt Student Not Leader
    backend --> frontend: 403 Forbidden\n{error: "Only team leader can pick project"}
    frontend --> student: Show error
end

alt Student Not In Team
    backend --> frontend: 403 Forbidden\n{error: "You are not a team member"}
    frontend --> student: Show error
end

note right of backend
  Business Rules:
  - Only team leader can pick project
  - Team can only have 1 project
  - Project can be picked by multiple teams
    IF project.max_teams > 1
  - Race condition handled with SELECT FOR UPDATE
  
  Transaction:
  - Atomic: project assignment + milestone cloning
  - Rollback if project taken between check and update
  
  Notifications:
  - All team members notified
  - WebSocket + Email
end note

@enduml
