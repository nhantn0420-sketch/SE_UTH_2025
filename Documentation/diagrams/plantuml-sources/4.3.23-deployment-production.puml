@startuml Production Deployment Diagram
!theme plain
skinparam componentStyle uml2

title CollabSphere - Production Deployment Architecture

' Client Layer
node "Client Tier" <<Browser>> as client {
  component [Web Browser] as browser
  component [React SPA\n(JavaScript)] as reactApp
  
  browser --> reactApp : runs
}

' CDN Layer
cloud "CDN" <<Cloudflare>> as cdn {
  component [Static Assets\nCache] as staticCache
  component [Image Cache] as imageCache
  
  note right of cdn
    **CDN Configuration:**
    - Global edge locations
    - HTTPS/TLS 1.3
    - Auto-minification
    - Brotli compression
    - 30-day cache TTL
  end note
}

' Load Balancer
node "Load Balancer" <<AWS ELB>> as lb {
  component [Application\nLoad Balancer] as alb
  component [Health Check\nMonitor] as healthCheck
  
  note right of lb
    **Load Balancer Config:**
    - Round-robin algorithm
    - Session stickiness enabled
    - SSL termination
    - Health check: /health
    - Interval: 30s
  end note
}

' Frontend Servers
node "Frontend Server 1" <<EC2 t3.medium>> as web1 {
  component [Nginx 1.24] as nginx1
  component [Static Files] as static1
  
  note bottom of web1
    **Instance Config:**
    - OS: Ubuntu 22.04 LTS
    - CPU: 2 vCPU
    - RAM: 4 GB
    - Storage: 20 GB SSD
    - Docker Engine 24.0
  end note
}

node "Frontend Server 2" <<EC2 t3.medium>> as web2 {
  component [Nginx 1.24] as nginx2
  component [Static Files] as static2
}

' Backend Servers
node "Backend Server 1" <<EC2 t3.large>> as app1 {
  component [FastAPI 0.104\n(Uvicorn)] as api1
  component [Python 3.11] as python1
  component [Alembic\nMigrations] as alembic1
  
  note bottom of app1
    **Instance Config:**
    - OS: Ubuntu 22.04 LTS
    - CPU: 2 vCPU
    - RAM: 8 GB
    - Storage: 40 GB SSD
    - Docker Engine 24.0
    - Workers: 4
  end note
}

node "Backend Server 2" <<EC2 t3.large>> as app2 {
  component [FastAPI 0.104\n(Uvicorn)] as api2
  component [Python 3.11] as python2
  component [Alembic\nMigrations] as alembic2
}

' Database Cluster
database "Database Cluster" <<AWS RDS PostgreSQL>> as dbCluster {
  database [PostgreSQL 15\nPrimary] as dbMaster
  database [PostgreSQL 15\nRead Replica 1] as dbReplica1
  database [PostgreSQL 15\nRead Replica 2] as dbReplica2
  
  note right of dbCluster
    **Database Config:**
    - Instance: db.r6g.xlarge
    - CPU: 4 vCPU
    - RAM: 32 GB
    - Storage: 500 GB GP3 SSD
    - IOPS: 12000
    - Multi-AZ: Enabled
    - Auto backup: Daily
    - Retention: 7 days
    - Encryption: AES-256
  end note
  
  dbMaster --> dbReplica1 : async replication
  dbMaster --> dbReplica2 : async replication
}

' Cache Cluster
database "Cache Cluster" <<AWS ElastiCache Redis>> as cacheCluster {
  database [Redis 7.0\nMaster] as redisMaster
  database [Redis 7.0\nReplica 1] as redisReplica1
  database [Redis 7.0\nReplica 2] as redisReplica2
  
  note right of cacheCluster
    **Cache Config:**
    - Instance: cache.r6g.large
    - CPU: 2 vCPU
    - RAM: 13.07 GB
    - Cluster mode: Disabled
    - Replication: Enabled
    - Auto-failover: Enabled
    - Backup: Daily snapshot
    - Eviction: allkeys-lru
  end note
  
  redisMaster --> redisReplica1 : sync replication
  redisMaster --> redisReplica2 : sync replication
}

' File Storage
storage "Object Storage" <<AWS S3>> as s3 {
  folder [User Uploads\nBucket] as uploadsBucket
  folder [Static Assets\nBucket] as assetsBucket
  folder [Backups\nBucket] as backupsBucket
  
  note right of s3
    **S3 Configuration:**
    - Versioning: Enabled
    - Encryption: SSE-S3
    - Lifecycle: 90 days to Glacier
    - CORS: Configured
    - Public access: Blocked
    - CDN integration: CloudFront
  end note
}

' External Services
cloud "External Services" as external {
  component [AWS Bedrock\n(Claude Sonnet)] as ai
  component [AWS SES\n(Email)] as email
  component [AWS SNS\n(SMS)] as sms
  component [Cloudinary\n(Image/Video)] as cloudinary
  component [GitHub OAuth] as github
  component [Google OAuth] as google
}

' Monitoring & Logging
node "Monitoring Stack" <<EC2 t3.small>> as monitoring {
  component [Prometheus] as prometheus
  component [Grafana] as grafana
  component [AlertManager] as alertmanager
  
  note bottom of monitoring
    **Monitoring Config:**
    - Metrics retention: 15 days
    - Scrape interval: 15s
    - Alerts: Email, Slack
    - Dashboards: 12
  end note
}

storage "Logging Stack" <<AWS CloudWatch>> as logging {
  folder [Application Logs] as appLogs
  folder [Access Logs] as accessLogs
  folder [Error Logs] as errorLogs
  
  note right of logging
    **CloudWatch Config:**
    - Log retention: 30 days
    - Log groups: 8
    - Metric filters: 15
    - Alarms: 25
  end note
}

' Backup System
node "Backup Server" <<EC2 t3.small>> as backup {
  component [Backup Script\n(Cron)] as backupScript
  component [Snapshot Manager] as snapshotMgr
}

' Security
node "Security Layer" as security {
  component [AWS WAF] as waf
  component [AWS Shield] as shield
  component [SSL/TLS\nCertificates] as ssl
  
  note bottom of security
    **Security Config:**
    - WAF rules: OWASP Top 10
    - DDoS protection: Standard
    - SSL/TLS: 1.3
    - Certificates: Let's Encrypt
    - Auto-renewal: Enabled
  end note
}

' Network Configuration
package "Virtual Private Cloud (VPC)" as vpc {
  package "Public Subnet 1\n(10.0.1.0/24)" as pubSub1 {
    web1
    lb
  }
  
  package "Public Subnet 2\n(10.0.2.0/24)" as pubSub2 {
    web2
  }
  
  package "Private Subnet 1\n(10.0.11.0/24)" as privSub1 {
    app1
  }
  
  package "Private Subnet 2\n(10.0.12.0/24)" as privSub2 {
    app2
  }
  
  package "Data Subnet 1\n(10.0.21.0/24)" as dataSub1 {
    dbMaster
    redisMaster
  }
  
  package "Data Subnet 2\n(10.0.22.0/24)" as dataSub2 {
    dbReplica1
    redisReplica1
  }
  
  package "Data Subnet 3\n(10.0.23.0/24)" as dataSub3 {
    dbReplica2
    redisReplica2
  }
}

' Connections - Client to CDN
browser --> cdn : HTTPS/443
cdn --> staticCache : cache hit
cdn --> lb : cache miss

' Connections - CDN to Load Balancer
lb --> nginx1 : HTTP/80
lb --> nginx2 : HTTP/80

' Connections - Frontend to Backend
nginx1 --> alb : proxy_pass
nginx2 --> alb : proxy_pass
alb --> api1 : HTTP/8000
alb --> api2 : HTTP/8000

' Connections - Backend to Database
api1 --> dbMaster : write\npsycopg2\nTCP/5432
api2 --> dbMaster : write\npsycopg2\nTCP/5432
api1 --> dbReplica1 : read\npsycopg2\nTCP/5432
api2 --> dbReplica2 : read\npsycopg2\nTCP/5432

' Connections - Backend to Cache
api1 --> redisMaster : redis-py\nTCP/6379
api2 --> redisMaster : redis-py\nTCP/6379

' Connections - Backend to Storage
api1 --> s3 : boto3\nHTTPS/443
api2 --> s3 : boto3\nHTTPS/443
api1 --> cloudinary : cloudinary-py\nHTTPS/443
api2 --> cloudinary : cloudinary-py\nHTTPS/443

' Connections - Backend to External Services
api1 --> ai : bedrock\nHTTPS/443
api2 --> ai : bedrock\nHTTPS/443
api1 --> email : boto3\nHTTPS/443
api2 --> email : boto3\nHTTPS/443
api1 --> github : OAuth2\nHTTPS/443
api2 --> google : OAuth2\nHTTPS/443

' Connections - Monitoring
prometheus --> api1 : scrape\n/metrics\nHTTP/8000
prometheus --> api2 : scrape\n/metrics\nHTTP/8000
prometheus --> dbMaster : pg_exporter\nTCP/9187
prometheus --> redisMaster : redis_exporter\nTCP/9121
grafana --> prometheus : query\nHTTP/9090
alertmanager --> email : alerts\nSMTP/587

' Connections - Logging
api1 --> logging : CloudWatch\nAgent
api2 --> logging : CloudWatch\nAgent
nginx1 --> logging : Logs
nginx2 --> logging : Logs

' Connections - Backup
backupScript --> dbMaster : pg_dump
backupScript --> s3 : upload
snapshotMgr --> dbMaster : snapshot
snapshotMgr --> backupsBucket : store

' Security Connections
browser --> waf : HTTP/HTTPS
waf --> lb : filtered traffic
shield --> lb : DDoS protection
ssl --> nginx1 : certificates
ssl --> nginx2 : certificates

legend right
  **Network Ports:**
  | Service | Port | Protocol |
  | HTTP | 80 | TCP |
  | HTTPS | 443 | TCP |
  | FastAPI | 8000 | TCP |
  | PostgreSQL | 5432 | TCP |
  | Redis | 6379 | TCP |
  | Prometheus | 9090 | TCP |
  | Grafana | 3000 | TCP |
  
  **Security Groups:**
  - Web SG: Allow 80, 443 from 0.0.0.0/0
  - App SG: Allow 8000 from Web SG
  - DB SG: Allow 5432 from App SG
  - Cache SG: Allow 6379 from App SG
  - Monitoring SG: Allow 9090, 3000 from VPC
  
  **Availability:**
  - Multi-AZ deployment
  - Auto-scaling enabled
  - Min instances: 2
  - Max instances: 10
  - Target CPU: 70%
  - Health check grace: 300s
  
  **Disaster Recovery:**
  - RTO: 4 hours
  - RPO: 1 hour
  - Backup frequency: Daily
  - Cross-region replication: Enabled
end legend

@enduml
