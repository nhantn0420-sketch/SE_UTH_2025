# 4.3. DETAILED DESIGN (Thiết kế Chi tiết)

**API Design, Business Logic, Security - CollabSphere**

---

## 4.3.1. API DESIGN OVERVIEW

### API Architecture

**Base URL**: `/api/v1`  
**Protocol**: HTTP/HTTPS  
**Data Format**: JSON  
**Authentication**: JWT Bearer Token  
**API Style**: RESTful

### API Versioning

```
/api/v1/*  - Current version (v1)
/api/v2/*  - Future version (backward compatible)
```

### Standard Response Format

**Success Response:**
```json
{
  "data": { ... },
  "message": "Operation successful",
  "timestamp": "2026-01-04T10:30:00Z"
}
```

**Error Response:**
```json
{
  "detail": "Error message",
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2026-01-04T10:30:00Z",
  "path": "/api/v1/users",
  "method": "POST"
}
```

### HTTP Methods

| Method | Usage | Idempotent |
|--------|-------|------------|
| **GET** | Retrieve resources | ✅ Yes |
| **POST** | Create new resources | ❌ No |
| **PUT** | Full update | ✅ Yes |
| **PATCH** | Partial update | ❌ No |
| **DELETE** | Delete resources | ✅ Yes |

---

## 4.3.2. API ENDPOINTS CATALOG

### Module A: Authentication (`/api/v1/auth`)

#### **POST /auth/register**

**Purpose**: Register new user account (Student only)

**Authentication**: ❌ Not required

**Request Body:**
```json
{
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "password": "Secure123!",
  "full_name": "John Smith",
  "phone": "0123456789",
  "role": "STUDENT"
}
```

**Response (201 Created):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 123,
    "username": "john.student",
    "email": "john@student.fpt.edu.vn",
    "full_name": "John Smith",
    "role": "STUDENT",
    "is_active": true
  }
}
```

**Business Rules:**
- BR-01: Email must be unique
- BR-02: Password minimum 6 characters (8+ recommended)
- BR-04: Only STUDENT role can register publicly
- BR-07: Password must contain uppercase, lowercase, number

---

#### **POST /auth/login**

**Purpose**: User login

**Authentication**: ❌ Not required

**Request Body (OAuth2 Password Flow):**
```json
{
  "username": "john@student.fpt.edu.vn",
  "password": "Secure123!"
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 123,
    "username": "john.student",
    "email": "john@student.fpt.edu.vn",
    "full_name": "John Smith",
    "role": "STUDENT",
    "avatar_url": "https://cloudinary.com/...",
    "last_login": "2026-01-04T10:30:00Z"
  }
}
```

**Error Responses:**
- 401 Unauthorized: Incorrect credentials
- 403 Forbidden: Account deactivated

**Business Logic:**
1. Accept username OR email
2. Verify password with bcrypt
3. Check `is_active` status
4. Update `last_login` timestamp
5. Generate JWT tokens (24h expiry)

---

#### **POST /auth/refresh**

**Purpose**: Refresh access token

**Authentication**: ❌ Not required (refresh token in body)

**Request Body:**
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

---

#### **GET /auth/me**

**Purpose**: Get current user profile

**Authentication**: ✅ Required

**Request Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "full_name": "John Smith",
  "role": "STUDENT",
  "avatar_url": "https://cloudinary.com/...",
  "phone": "0123456789",
  "is_active": true,
  "created_at": "2025-09-01T08:00:00Z",
  "last_login": "2026-01-04T10:30:00Z"
}
```

---

#### **PUT /auth/change-password**

**Purpose**: Change password

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "current_password": "OldPassword123!",
  "new_password": "NewPassword456!"
}
```

**Response (200 OK):**
```json
{
  "message": "Password changed successfully"
}
```

**Business Rules:**
- BR-08: Must verify current password
- BR-02: New password validation

---

### Module B: Users Management (`/api/v1/users`)

#### **GET /users**

**Purpose**: List all users (Admin only)

**Authentication**: ✅ Required (Admin)

**Query Parameters:**
- `role` (optional): Filter by role
- `is_active` (optional): Filter active/inactive
- `skip` (optional): Pagination offset
- `limit` (optional): Items per page (max 100)

**Request:**
```
GET /api/v1/users?role=STUDENT&is_active=true&skip=0&limit=20
```

**Response (200 OK):**
```json
{
  "total": 150,
  "items": [
    {
      "id": 1,
      "username": "john.student",
      "email": "john@student.fpt.edu.vn",
      "full_name": "John Smith",
      "role": "STUDENT",
      "is_active": true,
      "created_at": "2025-09-01T08:00:00Z"
    },
    // ... more users
  ],
  "skip": 0,
  "limit": 20
}
```

**Authorization:**
- Admin: View all users
- Others: 403 Forbidden

---

#### **GET /users/{user_id}**

**Purpose**: Get user by ID

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "full_name": "John Smith",
  "role": "STUDENT",
  "avatar_url": "https://cloudinary.com/...",
  "phone": "0123456789",
  "is_active": true,
  "created_at": "2025-09-01T08:00:00Z"
}
```

**Authorization:**
- Admin: View any user
- Others: View own profile only

---

#### **PUT /users/{user_id}**

**Purpose**: Update user profile

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "full_name": "John Smith Updated",
  "phone": "0987654321",
  "avatar_url": "https://cloudinary.com/new-avatar.jpg"
}
```

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "full_name": "John Smith Updated",
  "phone": "0987654321",
  "avatar_url": "https://cloudinary.com/new-avatar.jpg",
  "updated_at": "2026-01-04T11:00:00Z"
}
```

**Authorization:**
- Admin: Update any user
- Others: Update own profile only

**Business Rules:**
- BR-05: Cannot change own role
- BR-09: Admin cannot deactivate themselves

---

#### **POST /users (Admin only)**

**Purpose**: Create new user by Admin

**Authentication**: ✅ Required (Admin)

**Request Body:**
```json
{
  "username": "jane.lecturer",
  "email": "jane@fpt.edu.vn",
  "password": "TempPassword123!",
  "full_name": "Jane Doe",
  "role": "LECTURER"
}
```

**Response (201 Created):**
```json
{
  "id": 124,
  "username": "jane.lecturer",
  "email": "jane@fpt.edu.vn",
  "full_name": "Jane Doe",
  "role": "LECTURER",
  "is_active": true
}
```

---

### Module C: Subjects & Curricula (`/api/v1/subjects`)

#### **POST /subjects**

**Purpose**: Create new subject (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "code": "SE401",
  "name": "Capstone Project",
  "credits": 6,
  "description": "Final year capstone project"
}
```

**Response (201 Created):**
```json
{
  "id": 10,
  "code": "SE401",
  "name": "Capstone Project",
  "credits": 6,
  "description": "Final year capstone project",
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-16: Subject code must be unique
- BR-18: Subject code is immutable after creation

---

#### **GET /subjects**

**Purpose**: List all subjects

**Authentication**: ✅ Required

**Query Parameters:**
- `skip`, `limit`: Pagination

**Response (200 OK):**
```json
{
  "total": 50,
  "items": [
    {
      "id": 10,
      "code": "SE401",
      "name": "Capstone Project",
      "credits": 6,
      "description": "Final year capstone project"
    },
    // ... more subjects
  ]
}
```

---

#### **POST /subjects/{subject_id}/curricula**

**Purpose**: Add curriculum content (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "week_number": 1,
  "content": "Introduction to Software Engineering principles",
  "learning_outcomes": "Understand SDLC, Agile methodologies"
}
```

**Response (201 Created):**
```json
{
  "id": 101,
  "subject_id": 10,
  "week_number": 1,
  "content": "Introduction to Software Engineering principles",
  "learning_outcomes": "Understand SDLC, Agile methodologies",
  "created_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /subjects/{subject_id}/curricula**

**Purpose**: Get curriculum for subject

**Authentication**: ✅ Required

**Response (200 OK):**
```json
[
  {
    "id": 101,
    "subject_id": 10,
    "week_number": 1,
    "content": "Introduction to Software Engineering",
    "learning_outcomes": "..."
  },
  {
    "id": 102,
    "week_number": 2,
    "content": "Requirements Engineering",
    "learning_outcomes": "..."
  }
]
```

---

### Module D: Classes (`/api/v1/classes`)

#### **POST /classes**

**Purpose**: Create new class (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "code": "SE1701",
  "name": "Software Engineering - Class 01",
  "subject_id": 10,
  "lecturer_id": 124,
  "semester": "Spring2025",
  "academic_year": "2024-2025",
  "max_students": 40
}
```

**Response (201 Created):**
```json
{
  "id": 50,
  "code": "SE1701",
  "name": "Software Engineering - Class 01",
  "subject_id": 10,
  "lecturer_id": 124,
  "lecturer_name": "Jane Doe",
  "semester": "Spring2025",
  "status": "ACTIVE",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

#### **GET /classes**

**Purpose**: List classes

**Authentication**: ✅ Required

**Query Parameters:**
- `lecturer_id` (optional): Filter by lecturer
- `semester` (optional): Filter by semester
- `status` (optional): Filter by status

**Response (200 OK):**
```json
{
  "total": 20,
  "items": [
    {
      "id": 50,
      "code": "SE1701",
      "name": "Software Engineering - Class 01",
      "subject": {
        "id": 10,
        "code": "SE401",
        "name": "Capstone Project"
      },
      "lecturer": {
        "id": 124,
        "full_name": "Jane Doe"
      },
      "semester": "Spring2025",
      "student_count": 35,
      "max_students": 40,
      "status": "ACTIVE"
    }
  ]
}
```

**Authorization:**
- Admin/Staff: View all classes
- Lecturer: View own classes only
- Student: View enrolled classes only

---

#### **POST /classes/{class_id}/members**

**Purpose**: Add student to class (Staff/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "student_id": 123,
  "role": "MEMBER"
}
```

**Response (201 Created):**
```json
{
  "id": 201,
  "class_id": 50,
  "student_id": 123,
  "student_name": "John Smith",
  "role": "MEMBER",
  "joined_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /classes/{class_id}/members**

**Purpose**: List students in class

**Authentication**: ✅ Required

**Response (200 OK):**
```json
[
  {
    "id": 201,
    "student_id": 123,
    "student": {
      "id": 123,
      "username": "john.student",
      "full_name": "John Smith",
      "email": "john@student.fpt.edu.vn",
      "avatar_url": "..."
    },
    "role": "MEMBER",
    "joined_at": "2026-01-04T10:30:00Z"
  }
]
```

---

### Module E: Projects (`/api/v1/projects`)

#### **POST /projects**

**Purpose**: Create new project (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "title": "E-commerce Web Application",
  "description": "Build a full-stack e-commerce platform...",
  "objectives": "Learn full-stack development, database design...",
  "scope": "Frontend (React), Backend (FastAPI), Database (PostgreSQL)",
  "expected_outcomes": "Working web application with authentication, shopping cart..."
}
```

**Response (201 Created):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "description": "Build a full-stack e-commerce platform...",
  "created_by": 124,
  "creator_name": "Jane Doe",
  "status": "PENDING",
  "approval_status": null,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-21: Initial status = PENDING

---

#### **POST /projects/{project_id}/submit**

**Purpose**: Submit project for approval (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Response (200 OK):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "status": "SUBMITTED",
  "approval_status": "PENDING_REVIEW",
  "submitted_at": "2026-01-04T11:00:00Z"
}
```

---

#### **POST /projects/{project_id}/approve**

**Purpose**: Approve project (Head only)

**Authentication**: ✅ Required (Head/Admin)

**Response (200 OK):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "status": "APPROVED",
  "approval_status": "APPROVED",
  "approved_by": 125,
  "approved_at": "2026-01-04T12:00:00Z"
}
```

**Business Rules:**
- BR-20: Head can view all projects
- BR-23: Approved projects are immutable (unless Head updates)

---

#### **POST /projects/{project_id}/reject**

**Purpose**: Reject project (Head only)

**Authentication**: ✅ Required (Head/Admin)

**Request Body:**
```json
{
  "rejection_reason": "Scope too large for one semester. Please narrow down to 3-4 main features."
}
```

**Response (200 OK):**
```json
{
  "id": 301,
  "status": "REJECTED",
  "approval_status": "REJECTED",
  "rejection_reason": "Scope too large for one semester...",
  "rejected_at": "2026-01-04T12:00:00Z"
}
```

**Business Rules:**
- BR-22: Rejection reason is required

---

#### **GET /projects**

**Purpose**: List projects

**Authentication**: ✅ Required

**Query Parameters:**
- `status`: Filter by status
- `approval_status`: Filter by approval status
- `created_by`: Filter by creator (lecturer)

**Response (200 OK):**
```json
{
  "total": 50,
  "items": [
    {
      "id": 301,
      "title": "E-commerce Web Application",
      "description": "Build a full-stack...",
      "creator": {
        "id": 124,
        "full_name": "Jane Doe"
      },
      "status": "APPROVED",
      "approval_status": "APPROVED",
      "milestone_count": 5,
      "created_at": "2026-01-04T10:00:00Z"
    }
  ]
}
```

**Authorization:**
- Admin/Head: View all projects
- Lecturer: View own projects only
- Student: View approved + assigned projects only

---

#### **POST /projects/{project_id}/milestones**

**Purpose**: Add milestone to project (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS and database design",
  "order_index": 1,
  "duration_weeks": 2
}
```

**Response (201 Created):**
```json
{
  "id": 401,
  "project_id": 301,
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS and database design",
  "order_index": 1,
  "duration_weeks": 2,
  "created_at": "2026-01-04T10:30:00Z"
}
```

---

#### **POST /projects/{project_id}/milestones/generate-ai**

**Purpose**: Auto-generate milestones using AI (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "project_description": "Build e-commerce platform with React and FastAPI",
  "duration_weeks": 16
}
```

**Response (200 OK):**
```json
{
  "milestones": [
    {
      "title": "Milestone 1: Requirements Analysis",
      "description": "Define requirements, create SRS document",
      "order_index": 1,
      "duration_weeks": 2
    },
    {
      "title": "Milestone 2: System Design",
      "description": "Database design, architecture design",
      "order_index": 2,
      "duration_weeks": 2
    },
    // ... more milestones (AI generated)
  ],
  "generated_by": "AWS Bedrock Claude"
}
```

**Business Rules:**
- BR-51: AI-generated content must be reviewed by user
- BR-52: AI requests limited to 50/day/user

---

### Module F: Groups & Workspaces (`/api/v1/groups`)

#### **POST /groups**

**Purpose**: Create group (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "name": "Team Alpha",
  "class_id": 50,
  "project_id": 301,
  "leader_id": 123,
  "description": "Group working on e-commerce project"
}
```

**Response (201 Created):**
```json
{
  "id": 501,
  "name": "Team Alpha",
  "class_id": 50,
  "project_id": 301,
  "leader": {
    "id": 123,
    "full_name": "John Smith"
  },
  "status": "ACTIVE",
  "member_count": 1,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-33: Team must have 3-5 members
- BR-34: Exactly one team leader
- BR-35: Student can only be in one team per class

---

#### **POST /groups/{group_id}/members**

**Purpose**: Add member to group (Lecturer/Leader)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "student_id": 126,
  "role": "MEMBER"
}
```

**Response (201 Created):**
```json
{
  "id": 601,
  "group_id": 501,
  "student": {
    "id": 126,
    "full_name": "Alice Johnson"
  },
  "role": "MEMBER",
  "contribution_score": 0.0,
  "joined_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /groups/{group_id}**

**Purpose**: Get group details

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 501,
  "name": "Team Alpha",
  "class": {
    "id": 50,
    "code": "SE1701",
    "name": "Software Engineering - Class 01"
  },
  "project": {
    "id": 301,
    "title": "E-commerce Web Application"
  },
  "leader": {
    "id": 123,
    "full_name": "John Smith"
  },
  "members": [
    {
      "id": 601,
      "student": {
        "id": 123,
        "full_name": "John Smith",
        "avatar_url": "..."
      },
      "role": "LEADER",
      "contribution_score": 0.0
    },
    {
      "id": 602,
      "student": {
        "id": 126,
        "full_name": "Alice Johnson"
      },
      "role": "MEMBER",
      "contribution_score": 0.0
    }
  ],
  "milestones": [
    {
      "id": 701,
      "title": "Milestone 1: Requirements",
      "deadline": "2026-01-20T23:59:59Z",
      "status": "PENDING",
      "is_completed": false
    }
  ],
  "status": "ACTIVE",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

#### **POST /groups/{group_id}/milestones**

**Purpose**: Create milestone for group (Lecturer)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS document",
  "deadline": "2026-01-20T23:59:59Z"
}
```

**Response (201 Created):**
```json
{
  "id": 701,
  "group_id": 501,
  "title": "Milestone 1: Requirements & Design",
  "deadline": "2026-01-20T23:59:59Z",
  "status": "PENDING",
  "is_completed": false
}
```

---

#### **PUT /groups/{group_id}/milestones/{milestone_id}/complete**

**Purpose**: Mark milestone as complete (Leader only)

**Authentication**: ✅ Required (Group Leader)

**Response (200 OK):**
```json
{
  "id": 701,
  "title": "Milestone 1: Requirements & Design",
  "status": "COMPLETED",
  "is_completed": true,
  "completed_at": "2026-01-20T10:00:00Z"
}
```

**Business Rules:**
- BR-40: Only team leader can mark milestones complete

---

#### **POST /groups/{group_id}/checkpoints**

**Purpose**: Create checkpoint (Leader/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "title": "Submit ERD Diagram",
  "description": "Database design document",
  "deadline": "2026-01-15T23:59:59Z",
  "assigned_members": [123, 126]
}
```

**Response (201 Created):**
```json
{
  "id": 801,
  "group_id": 501,
  "title": "Submit ERD Diagram",
  "deadline": "2026-01-15T23:59:59Z",
  "assigned_members": [123, 126],
  "status": "PENDING"
}
```

---

#### **POST /groups/{group_id}/checkpoints/{checkpoint_id}/submit**

**Purpose**: Submit checkpoint (Student)

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "submission_url": "https://drive.google.com/file/d/..."
}
```

**Response (200 OK):**
```json
{
  "id": 801,
  "title": "Submit ERD Diagram",
  "submission_url": "https://drive.google.com/file/d/...",
  "status": "SUBMITTED",
  "submitted_at": "2026-01-15T20:00:00Z"
}
```

---

#### **GET /groups/{group_id}/tasks**

**Purpose**: Get tasks (Kanban board)

**Authentication**: ✅ Required (Group Member)

**Query Parameters:**
- `status`: Filter by status (TODO/IN_PROGRESS/DONE)
- `assigned_to`: Filter by assignee

**Response (200 OK):**
```json
[
  {
    "id": 901,
    "group_id": 501,
    "title": "Create database schema",
    "description": "Design PostgreSQL schema",
    "assigned_to": {
      "id": 123,
      "full_name": "John Smith"
    },
    "status": "IN_PROGRESS",
    "priority": "HIGH",
    "due_date": "2026-01-12T23:59:59Z",
    "created_at": "2026-01-04T10:00:00Z"
  }
]
```

**Business Rules:**
- BR-36: Card can contain multiple tasks
- BR-37: Task can have multiple subtasks
- BR-38: Maximum 3 levels (Card → Task → Subtask)

---

#### **POST /groups/{group_id}/tasks**

**Purpose**: Create task (Group Member)

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "title": "Implement user authentication",
  "description": "JWT authentication with bcrypt",
  "assigned_to": 123,
  "status": "TODO",
  "priority": "HIGH",
  "due_date": "2026-01-12T23:59:59Z"
}
```

**Response (201 Created):**
```json
{
  "id": 902,
  "group_id": 501,
  "title": "Implement user authentication",
  "assigned_to": {
    "id": 123,
    "full_name": "John Smith"
  },
  "status": "TODO",
  "priority": "HIGH",
  "due_date": "2026-01-12T23:59:59Z",
  "created_at": "2026-01-04T11:00:00Z"
}
```

---

### Module G: Evaluations (`/api/v1/evaluations`)

#### **POST /evaluations/groups/{group_id}**

**Purpose**: Evaluate group (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "evaluation_type": "PROGRESS",
  "score": 8.5,
  "feedback": "Good progress on requirements. Need to improve database design.",
  "criteria": {
    "requirements": 9.0,
    "design": 8.0,
    "implementation": 8.5,
    "documentation": 8.0
  }
}
```

**Response (201 Created):**
```json
{
  "id": 1001,
  "group_id": 501,
  "evaluator": {
    "id": 124,
    "full_name": "Jane Doe"
  },
  "evaluation_type": "PROGRESS",
  "score": 8.5,
  "feedback": "Good progress...",
  "created_at": "2026-01-20T10:00:00Z"
}
```

---

#### **POST /evaluations/members/{member_id}**

**Purpose**: Evaluate member (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "score": 9.0,
  "feedback": "Excellent contribution to database design",
  "evaluation_type": "INDIVIDUAL"
}
```

**Response (201 Created):**
```json
{
  "id": 1002,
  "group_member_id": 601,
  "student": {
    "id": 123,
    "full_name": "John Smith"
  },
  "score": 9.0,
  "feedback": "Excellent contribution...",
  "created_at": "2026-01-20T10:00:00Z"
}
```

---

#### **POST /evaluations/peer-review**

**Purpose**: Submit peer review (Student)

**Authentication**: ✅ Required (Student, Group Member)

**Request Body:**
```json
{
  "reviewee_id": 126,
  "group_id": 501,
  "period": "MIDTERM",
  "rating": 4,
  "comments": "Always on time, great teamwork skills",
  "criteria": {
    "communication": 5,
    "technical_skills": 4,
    "teamwork": 5,
    "time_management": 4
  }
}
```

**Response (201 Created):**
```json
{
  "id": 1003,
  "reviewer_id": 123,
  "reviewee_id": 126,
  "group_id": 501,
  "period": "MIDTERM",
  "rating": 4,
  "is_anonymous": true,
  "created_at": "2026-01-20T10:00:00Z"
}
```

**Business Rules:**
- BR-46: Peer reviews anonymous to students
- BR-47: Lecturer can see who submitted
- BR-48: One review per teammate per period

---

#### **GET /evaluations/me**

**Purpose**: Get own evaluations (Student)

**Authentication**: ✅ Required (Student)

**Response (200 OK):**
```json
{
  "group_evaluations": [
    {
      "id": 1001,
      "evaluation_type": "PROGRESS",
      "score": 8.5,
      "feedback": "Good progress...",
      "created_at": "2026-01-20T10:00:00Z"
    }
  ],
  "individual_evaluations": [
    {
      "id": 1002,
      "score": 9.0,
      "feedback": "Excellent contribution...",
      "created_at": "2026-01-20T10:00:00Z"
    }
  ],
  "peer_reviews_received": [
    {
      "period": "MIDTERM",
      "average_rating": 4.2,
      "review_count": 3,
      "anonymous_comments": [
        "Great teamwork",
        "Good technical skills",
        "Could improve communication"
      ]
    }
  ]
}
```

**Business Rules:**
- BR-50: Students see evaluations only after lecturer releases them

---

### Module H: Chat & Meetings (`/api/v1/chat`, `/api/v1/meetings`)

#### **GET /chat/groups/{group_id}/messages**

**Purpose**: Get chat messages

**Authentication**: ✅ Required (Group Member)

**Query Parameters:**
- `skip`, `limit`: Pagination
- `before`: Messages before timestamp

**Response (200 OK):**
```json
{
  "total": 150,
  "items": [
    {
      "id": 1101,
      "sender": {
        "id": 123,
        "full_name": "John Smith",
        "avatar_url": "..."
      },
      "message": "Hey team, let's discuss the database schema",
      "message_type": "TEXT",
      "is_read": true,
      "created_at": "2026-01-04T10:30:00Z"
    },
    {
      "id": 1102,
      "sender": {
        "id": 126,
        "full_name": "Alice Johnson"
      },
      "message": "Sure! I uploaded the ERD diagram",
      "message_type": "TEXT",
      "file_url": "https://cloudinary.com/...",
      "created_at": "2026-01-04T10:31:00Z"
    }
  ]
}
```

---

#### **POST /chat/groups/{group_id}/messages**

**Purpose**: Send chat message

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "message": "Here's my feedback on the design",
  "message_type": "TEXT",
  "file_url": null
}
```

**Response (201 Created):**
```json
{
  "id": 1103,
  "group_id": 501,
  "sender": {
    "id": 123,
    "full_name": "John Smith"
  },
  "message": "Here's my feedback on the design",
  "message_type": "TEXT",
  "created_at": "2026-01-04T11:00:00Z"
}
```

**Real-time**: Also broadcast via WebSocket to online members

**Business Rules:**
- BR-24: Messages can't be edited after 5 minutes
- BR-25: Only sender can delete own messages
- BR-26: Chat history retained for 1 year

---

#### **POST /meetings**

**Purpose**: Create meeting (Group Member/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "title": "Sprint Planning Meeting",
  "description": "Plan next 2 weeks of development",
  "group_id": 501,
  "scheduled_at": "2026-01-05T14:00:00Z",
  "duration": 60,
  "meeting_url": "https://meet.google.com/abc-defg-hij"
}
```

**Response (201 Created):**
```json
{
  "id": 1201,
  "title": "Sprint Planning Meeting",
  "group_id": 501,
  "created_by": {
    "id": 123,
    "full_name": "John Smith"
  },
  "scheduled_at": "2026-01-05T14:00:00Z",
  "duration": 60,
  "meeting_url": "https://meet.google.com/abc-defg-hij",
  "status": "SCHEDULED",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

### Module I: Resources (`/api/v1/resources`)

#### **POST /resources**

**Purpose**: Upload resource file

**Authentication**: ✅ Required

**Request Body (multipart/form-data):**
```
file: <binary>
title: "Database Design Document"
description: "ERD and schema"
group_id: 501
```

**Response (201 Created):**
```json
{
  "id": 1301,
  "title": "Database Design Document",
  "description": "ERD and schema",
  "file_url": "https://cloudinary.com/collabsphere/erd-diagram.pdf",
  "file_type": "PDF",
  "file_size": 2048576,
  "uploaded_by": {
    "id": 123,
    "full_name": "John Smith"
  },
  "group_id": 501,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-41: Max file size 100MB
- BR-42: Allowed types: PDF, DOCX, XLSX, PPTX, PNG, JPG, MP4
- BR-45: Immediately available to authorized users

---

#### **GET /resources**

**Purpose**: List resources

**Authentication**: ✅ Required

**Query Parameters:**
- `group_id`: Filter by group
- `class_id`: Filter by class
- `uploaded_by`: Filter by uploader

**Response (200 OK):**
```json
{
  "total": 25,
  "items": [
    {
      "id": 1301,
      "title": "Database Design Document",
      "file_url": "https://cloudinary.com/...",
      "file_type": "PDF",
      "file_size": 2048576,
      "uploaded_by": {
        "id": 123,
        "full_name": "John Smith"
      },
      "created_at": "2026-01-04T10:00:00Z"
    }
  ]
}
```

---

### Module J: AI Assistant (`/api/v1/ai`)

#### **POST /ai/chat**

**Purpose**: Chat with AI assistant

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "message": "How do I implement JWT authentication in FastAPI?",
  "context": {
    "project_id": 301,
    "group_id": 501
  }
}
```

**Response (200 OK):**
```json
{
  "response": "To implement JWT authentication in FastAPI, you need to:\n1. Install python-jose and bcrypt\n2. Create utility functions for token generation...",
  "model": "claude-3-sonnet",
  "tokens_used": 250
}
```

**Business Rules:**
- BR-52: Limited to 50 requests/day/user
- BR-53: Responses stored for training (with consent)
- BR-54: Graceful degradation if AI unavailable

---

#### **POST /ai/projects/{project_id}/generate-milestones**

**Purpose**: AI generate milestones

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "duration_weeks": 16
}
```

**Response (200 OK):**
```json
{
  "milestones": [
    {
      "title": "Milestone 1: Requirements Analysis",
      "description": "Complete SRS, use cases, requirements gathering",
      "order_index": 1,
      "duration_weeks": 2
    },
    // ... 5-7 more milestones
  ]
}
```

---

### Module K: Notifications (`/api/v1/notifications`)

#### **GET /notifications**

**Purpose**: Get user notifications

**Authentication**: ✅ Required

**Query Parameters:**
- `is_read`: Filter read/unread
- `type`: Filter by notification type
- `skip`, `limit`: Pagination

**Response (200 OK):**
```json
{
  "total": 50,
  "unread_count": 12,
  "items": [
    {
      "id": 1401,
      "type": "PROJECT_APPROVED",
      "title": "Project Approved",
      "content": "Your project 'E-commerce Web Application' has been approved by Head",
      "link": "/projects/301",
      "is_read": false,
      "created_at": "2026-01-04T12:00:00Z"
    },
    {
      "id": 1402,
      "type": "CHAT_MESSAGE",
      "title": "New message in Team Alpha",
      "content": "John Smith: Hey team, let's discuss...",
      "link": "/groups/501/chat",
      "is_read": true,
      "created_at": "2026-01-04T10:30:00Z"
    }
  ]
}
```

---

#### **PUT /notifications/{notification_id}/read**

**Purpose**: Mark notification as read

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 1401,
  "is_read": true,
  "read_at": "2026-01-04T13:00:00Z"
}
```

---

#### **PUT /notifications/read-all**

**Purpose**: Mark all notifications as read

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "message": "All notifications marked as read",
  "count": 12
}
```

**Business Rules:**
- BR-31: User can mark all as read in one action
- BR-30: Notifications auto-deleted after 30 days

---

## 4.3.3. BUSINESS LOGIC FLOWS

### Flow 1: User Registration & Login

```
1. User submits registration form
   └─> Validate email format
   └─> Check email uniqueness
   └─> Check username uniqueness
   └─> Hash password (bcrypt, rounds=12)
   └─> Create user record
   └─> Generate JWT access token (24h expiry)
   └─> Generate refresh token (7d expiry)
   └─> Return tokens + user info

2. User logs in
   └─> Find user by username OR email
   └─> Verify password with bcrypt
   └─> Check is_active status
   └─> Update last_login timestamp
   └─> Generate new JWT tokens
   └─> Return tokens + user info
```

---

### Flow 2: Project Approval Workflow

```
1. Lecturer creates project (Status: PENDING)
   ├─> Validate title, description
   ├─> Set created_by = current_user.id
   ├─> Set status = PENDING
   └─> Save to database

2. Lecturer submits for approval
   ├─> Check project ownership
   ├─> Set status = SUBMITTED
   ├─> Set approval_status = PENDING_REVIEW
   ├─> Send notification to Head
   └─> Return updated project

3. Head reviews project
   ├─> Check role = HEAD
   ├─> Review project details
   └─> Decide: Approve or Reject

4a. If APPROVED:
   ├─> Set status = APPROVED
   ├─> Set approval_status = APPROVED
   ├─> Set approved_by = head.id
   ├─> Set approved_at = now()
   ├─> Send notification to Lecturer
   └─> Project available for assignment

4b. If REJECTED:
   ├─> Set status = REJECTED
   ├─> Set approval_status = REJECTED
   ├─> Set rejection_reason (REQUIRED)
   ├─> Send notification to Lecturer with reason
   └─> Lecturer can revise and resubmit
```

---

### Flow 3: Group Milestone Tracking

```
1. Lecturer creates milestones for group
   ├─> Copy from project_milestones template
   ├─> Set deadline for each milestone
   ├─> Set status = PENDING
   └─> Notify group members

2. Group works on milestone
   ├─> Team leader assigns tasks
   ├─> Members update task status (TODO → IN_PROGRESS → DONE)
   ├─> Members submit checkpoints
   └─> Lecturer evaluates checkpoints

3. Team leader marks milestone complete
   ├─> Check role = LEADER
   ├─> Set is_completed = TRUE
   ├─> Set completed_at = now()
   ├─> Send notification to Lecturer
   └─> Unlock next milestone (if sequential)

4. Lecturer reviews completion
   ├─> View submission history
   ├─> Evaluate milestone
   ├─> Provide feedback
   └─> Approve or request revision
```

---

### Flow 4: Peer Review Process

```
1. Lecturer opens peer review period
   ├─> Set period (MIDTERM or FINAL)
   ├─> Set deadline
   ├─> Notify all students in class
   └─> Students can submit reviews

2. Student submits peer review
   ├─> Check: Student is in same group as reviewee
   ├─> Check: Not reviewing themselves
   ├─> Check: One review per teammate per period
   ├─> Set is_anonymous = TRUE
   ├─> Calculate average rating
   └─> Save review

3. After deadline passes
   ├─> Aggregate all peer reviews
   ├─> Calculate average ratings
   ├─> Generate anonymous summary for each student
   ├─> Lecturer views full details (including names)
   └─> Students see only anonymous summary

4. Lecturer uses peer review data
   ├─> Factor into individual evaluation
   ├─> Identify team conflicts
   ├─> Adjust contribution scores
   └─> Provide targeted feedback
```

---

### Flow 5: Real-time Chat with WebSocket

```
1. User opens chat window
   ├─> Frontend connects to Socket.IO server
   ├─> Authenticate via JWT token
   ├─> Join group room: socket.join(`group_${group_id}`)
   └─> Load recent messages (REST API)

2. User sends message
   ├─> POST /api/v1/chat/groups/{group_id}/messages
   ├─> Save message to database
   ├─> Emit WebSocket event to group room:
   │   socket.to(`group_${group_id}`).emit('new_message', message_data)
   └─> Return saved message

3. Other users receive message
   ├─> WebSocket client receives 'new_message' event
   ├─> Update chat UI in real-time
   └─> Play notification sound (if enabled)

4. User disconnects
   ├─> socket.disconnect()
   ├─> Leave group room
   └─> Update online status
```

---

## 4.3.4. SECURITY DESIGN

### Authentication Flow

```
┌─────────┐                 ┌─────────┐                ┌──────────┐
│ Client  │                 │ Backend │                │ Database │
└────┬────┘                 └────┬────┘                └────┬─────┘
     │                           │                           │
     │ 1. POST /auth/login       │                           │
     ├───────────────────────────>                           │
     │ {username, password}      │                           │
     │                           │ 2. Query user             │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 3. Return user + hash     │
     │                           <──────────────────────────┤
     │                           │                           │
     │                           │ 4. bcrypt.check(password) │
     │                           │                           │
     │ 5. Return JWT tokens      │                           │
     <───────────────────────────┤                           │
     │ {access_token, ...}       │                           │
     │                           │                           │
     │ 6. Subsequent requests    │                           │
     │ Authorization: Bearer ... │                           │
     ├───────────────────────────>                           │
     │                           │ 7. Verify JWT             │
     │                           │ jwt.decode(token)         │
     │                           │                           │
     │                           │ 8. Check permissions      │
     │                           │ (RBAC)                    │
     │                           │                           │
     │ 9. Return data            │                           │
     <───────────────────────────┤                           │
```

### Role-Based Authorization Matrix

| Endpoint | Admin | Staff | Head | Lecturer | Student |
|----------|-------|-------|------|----------|---------|
| **POST /users** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **GET /users** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **POST /subjects** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **POST /classes** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **GET /classes** | ✅ | ✅ | ✅ | ✅ (own) | ✅ (enrolled) |
| **POST /projects** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **POST /projects/.../approve** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **POST /groups** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **GET /groups/{id}** | ✅ | ❌ | ❌ | ✅ (own) | ✅ (member) |
| **POST /groups/.../tasks** | ✅ | ❌ | ❌ | ✅ | ✅ (member) |
| **POST /evaluations/groups** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **POST /evaluations/peer-review** | ✅ | ❌ | ❌ | ❌ | ✅ (member) |
| **GET /chat/groups/{id}/messages** | ✅ | ❌ | ❌ | ✅ (class) | ✅ (member) |
| **POST /resources** | ✅ | ✅ | ❌ | ✅ | ✅ (member) |
| **POST /ai/chat** | ✅ | ✅ | ✅ | ✅ | ✅ |

### Input Validation

**Pydantic Schemas:**
```python
from pydantic import BaseModel, EmailStr, Field, validator

class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50, regex="^[a-zA-Z0-9_-]+$")
    email: EmailStr  # Validates email format
    password: str = Field(..., min_length=6)
    full_name: str = Field(..., min_length=1, max_length=100)
    
    @validator('password')
    def validate_password_strength(cls, v):
        if not any(c.isupper() for c in v):
            raise ValueError('Password must contain uppercase letter')
        if not any(c.islower() for c in v):
            raise ValueError('Password must contain lowercase letter')
        if not any(c.isdigit() for c in v):
            raise ValueError('Password must contain digit')
        return v
```

### SQL Injection Prevention

**SQLModel ORM (Safe):**
```python
# SAFE - Parameterized query
user = session.exec(
    select(User).where(User.username == username)
).first()

# UNSAFE - String concatenation (NEVER DO THIS)
# query = f"SELECT * FROM users WHERE username = '{username}'"
```

### XSS Prevention

**Frontend:**
- React automatically escapes JSX content
- Use `dangerouslySetInnerHTML` only when necessary
- Sanitize user input with DOMPurify

**Backend:**
- Return plain text in JSON
- No HTML rendering on backend

### CSRF Protection

- Not needed for JWT-based API (stateless)
- CORS configured to allow specific origins only

---

## 4.3.5. CLASS DESIGN

### Class Diagram Overview

CollabSphere system được thiết kế với 6 module classes chính, mỗi module quản lý một domain logic riêng biệt. Tất cả class diagrams sử dụng UML notation chuẩn với đầy đủ attributes, methods, và relationships.

---

### 4.3.5.1. User & Authentication Module

![Figure 4.3.1: User & Authentication Module Class Diagram](diagrams/4.3.1-class-user-module.png)

*Figure 4.3.1: **User & Authentication Module Class Diagram** - Module core cho authentication và authorization với 6 entities chính: User (main entity với 12 attributes + 15 methods bao gồm verify_password, generate_token, role checks), UserRole enum (5 roles: ADMIN, DEPARTMENT_HEAD, ACADEMIC_STAFF, LECTURER, STUDENT), Session (JWT token management với access token 15 phút + refresh token 7 ngày), ActivityLog (audit trail cho login/logout/password_change), PasswordResetToken (password recovery workflow), và EmailVerificationToken (email verification với one-time tokens). Relationships: User 1→1 UserRole, User 1→0..* Sessions (multiple sessions per user), User 1→0..* ActivityLogs (audit trail), User 1→0..* PasswordResetTokens, User 1→0..1 EmailVerificationToken. Authentication sử dụng JWT với bcrypt password hashing, RBAC permissions theo từng role.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **User** | Main user entity | id, username, email, hashed_password, full_name, role, is_active | verify_password(), set_password(), generate_token(), is_admin(), is_lecturer(), is_student(), can_approve_projects() |
| **UserRole** | Role enumeration | ADMIN, DEPARTMENT_HEAD, ACADEMIC_STAFF, LECTURER, STUDENT | N/A (enum) |
| **Session** | Token management | id, user_id, access_token, refresh_token, expires_at, ip_address | is_valid(), revoke() |
| **ActivityLog** | Audit trail | id, user_id, action, details, ip_address, created_at | log(user_id, action, details) |
| **PasswordResetToken** | Password recovery | id, user_id, token, expires_at, used | generate(user), verify(token), mark_as_used() |
| **EmailVerificationToken** | Email verification | id, user_id, token, expires_at, verified | generate(user), verify(token) |

**Business Rules:**
- BR-01: Email and username must be unique
- BR-02: Password minimum 6 characters (hashed with bcrypt)
- BR-03: JWT tokens: Access token 15 min, Refresh token 7 days
- BR-04: Only STUDENT role can self-register, other roles created by ADMIN
- BR-05: Email verification required before full access
- BR-06: Activity logs are immutable (audit trail)
- BR-07: Password reset tokens are single-use and expire in 1 hour

**Design Patterns:**
- **Entity Pattern**: User is rich domain model with behavior
- **Value Object**: UserRole is immutable enumeration
- **Token Pattern**: Separate tokens for different purposes (access, refresh, reset, verify)
- **Audit Log Pattern**: Immutable activity logs for compliance

---

### 4.3.5.2. Academic Module

![Figure 4.3.2: Academic Module Class Diagram](diagrams/4.3.2-class-academic-module.png)

*Figure 4.3.2: **Academic Module Class Diagram** - Module quản lý cấu trúc học thuật với 4 entities chính: Subject (môn học với code + name, ví dụ: SE107 Software Project Management), Curriculum (chương trình đào tạo liên kết nhiều môn học, có start_date/end_date, status ACTIVE/INACTIVE), Class (lớp học cụ thể với class_code, semester, academic_year, giới hạn 10-60 students, 1 lecturer), và ClassMember (quan hệ N-N giữa Class và Students với enrollment_status: ENROLLED/DROPPED/COMPLETED và enrollment_date). Relationships: Subject 1→1..* Curriculum (một môn có thể thuộc nhiều chương trình), Curriculum 1→0..* Class (mỗi lớp phải có curriculum ACTIVE), Class 1→0..* ClassMember, Class 1→1 Lecturer. Workflow: Academic Staff creates Subjects → tạo Curriculum liên kết Subjects → Lecturer creates Class từ Curriculum → Students enroll via ClassMember.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **Subject** | Course definition | id, code, name, credits, description, prerequisites | get_active_curricula() |
| **Curriculum** | Program structure | id, name, description, start_date, end_date, status | is_active(), get_subjects(), add_subject() |
| **Class** | Class instance | id, class_code, curriculum_id, lecturer_id, semester, academic_year, max_students, status | enroll_student(), drop_student(), is_full(), can_enroll() |
| **ClassMember** | Student enrollment | id, class_id, student_id, enrollment_status, enrollment_date, completion_date | mark_completed(), drop() |

**Business Rules:**
- BR-10: Class size must be 10-60 students (configurable)
- BR-11: Each class has exactly 1 lecturer (no co-teaching)
- BR-12: Classes must have ACTIVE curriculum to accept enrollments
- BR-13: Students can drop class before milestone 1 deadline
- BR-14: Prerequisite subjects must be checked before enrollment

---

### 4.3.5.3. Project Module

![Figure 4.3.3: Project Module Class Diagram](diagrams/4.3.3-class-project-module.png)

*Figure 4.3.3: **Project Module Class Diagram** - Module quản lý project lifecycle với AI milestone generation. 4 entities chính: Project (title, description, objectives, scope, expected_outcomes, status: PENDING/APPROVED/DENIED/ACTIVE/COMPLETED), ProjectMilestone (AI-generated milestones với research questions, submission requirements, auto-cloned sang GroupMilestone khi group chọn project), MilestoneQuestion (research questions cho từng milestone), và ClassProject (junction table cho multi-class availability). Workflow: Lecturer creates Project (status=PENDING) → AWS Bedrock Claude 3 Sonnet auto-generates 5-10 milestones với research questions → Department Head approves (status=APPROVED) or denies (status=DENIED với rejection_reason) → Approved projects added to Classes via ClassProject → Groups select projects (race condition handled by SELECT FOR UPDATE) → ProjectMilestones cloned to GroupMilestones. Two-stage approval: Lecturer creates → Head approves.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **Project** | Main project entity | id, title, description, objectives, scope, expected_outcomes, created_by, status, approval_status, approved_by, rejection_reason | approve(), deny(reason), add_to_class(class_id), generate_milestones_ai() |
| **ProjectMilestone** | Project phases | id, project_id, milestone_number, title, description, submission_requirements, start_date, end_date | clone_to_group(group_id) |
| **MilestoneQuestion** | Research questions | id, milestone_id, question_text, question_order | N/A |
| **ClassProject** | Multi-class linking | id, class_id, project_id, added_at, max_groups | is_available(), get_remaining_slots() |

**Business Rules:**
- BR-20: Only APPROVED projects can be added to classes
- BR-21: Each class can have maximum 10 projects (configurable)
- BR-22: AI generates 5-10 milestones automatically using AWS Bedrock
- BR-23: Projects must have at least 3 milestones to be approved
- BR-24: Race condition when groups select projects handled with database locks (SELECT FOR UPDATE)
- BR-25: ProjectMilestones are immutable after approval (changes require Head re-approval)

---

### 4.3.5.4. Group Module

![Figure 4.3.4: Group Module Class Diagram](diagrams/4.3.4-class-group-module.png)

*Figure 4.3.4: **Group Module Class Diagram** - Module phức tạp nhất với 8 entities quản lý group collaboration. Group (3-5 members với 1 leader, status: FORMING→PROJECT_SELECTED→WORKING→COMPLETED), GroupMember (roles: LEADER/MEMBER với contribution_percentage tracking), GroupMilestone (cloned từ ProjectMilestone khi group chọn project), Checkpoint (submission deadlines với status: PENDING→SUBMITTED→EVALUATED→GRADED, late_penalty -10%/day, max_file_size 100MB via Cloudinary), CheckpointSubmission (file uploads với submission_date, is_late flag), CheckpointAssignment (per-member contribution breakdown với contribution_notes), Task (Kanban board với 4 statuses: TODO/IN_PROGRESS/REVIEW/DONE, assignee, priority, due_date), và WorkspaceCard (optional whiteboard cards linked to tasks). Relationships: Group 1→3..5 GroupMembers, Group 1→0..* GroupMilestones, GroupMilestone 1→0..* Checkpoints, Checkpoint 1→1 CheckpointSubmission, Checkpoint 1→0..* CheckpointAssignments (per member), Group 1→0..* Tasks, Task 0..1→0..1 WorkspaceCard.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **Group** | Main group entity | id, name, class_id, project_id, leader_id, status | add_member(), remove_member(), select_project(), can_select_project() |
| **GroupMember** | Member tracking | id, group_id, student_id, role, joined_at, contribution_percentage | promote_to_leader(), update_contribution() |
| **GroupMilestone** | Cloned milestones | id, group_id, milestone_number, title, description, start_date, end_date, status | create_checkpoint(deadline), mark_completed() |
| **Checkpoint** | Submission deadlines | id, group_milestone_id, title, deadline, status, grade, feedback | submit(files), evaluate(feedback), calculate_late_penalty() |
| **CheckpointSubmission** | File uploads | id, checkpoint_id, submitted_by, submission_date, file_url, is_late | upload_to_cloudinary() |
| **CheckpointAssignment** | Member contributions | id, checkpoint_id, member_id, contribution_percentage, contribution_notes | N/A |
| **Task** | Kanban tasks | id, group_id, title, description, assignee_id, status, priority, due_date | assign(member), move_to_status(status), link_to_card(card_id) |
| **WorkspaceCard** | Whiteboard cards | id, group_id, card_data (JSON), position_x, position_y | N/A |

**Business Rules:**
- BR-30: Group must have 3-5 members with exactly 1 leader
- BR-31: Leader can be changed only by current leader or lecturer
- BR-32: ProjectMilestones are cloned to GroupMilestones when project selected
- BR-33: Each GroupMilestone can have multiple checkpoints (submission deadlines)
- BR-40: Late submission penalty: -10% per day (maximum -50%)
- BR-41: Maximum file size 100MB per submission via Cloudinary CDN
- BR-42: Checkpoint grade 0-10, calculated: base_grade × (1 - late_penalty) × (1 - quality_penalty)
- BR-43: CheckpointAssignment tracks individual contributions (sum must equal 100% per checkpoint)
- BR-44: Tasks can be created/assigned within group, status transitions: TODO→IN_PROGRESS→REVIEW→DONE
- BR-45: Kanban board synchronized real-time via Socket.IO

---

### 4.3.5.5. Collaboration Module

![Figure 4.3.5: Collaboration Module Class Diagram](diagrams/4.3.5-class-collaboration-module.png)

*Figure 4.3.5: **Collaboration Module Class Diagram** - Module hỗ trợ real-time collaboration với 6 entities. Meeting (WebRTC video calls với meeting_code, start_time, end_time, recording_url, max 10 participants P2P), MeetingParticipant (roles: HOST/CO_HOST/PARTICIPANT, joined_at, left_at, attendance duration), ChatMessage (message_type: TEXT/FILE/IMAGE/MENTION/SYSTEM, reply threading, edit within 5 minutes, @mentions with notifications, synchronized via Socket.IO), Resource (file sharing với file_url, file_type, file_size max 100MB, Cloudinary storage, uploaded_by tracking), WhiteboardSession (collaborative drawing canvas saved as JSON with session_data, active_participants real-time tracking), và DocumentSession (real-time markdown editor với Operational Transform conflict resolution, version_number tracking, last_edit_by). Tất cả features synchronized real-time across group members qua Socket.IO với room-based broadcasting.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **Meeting** | Video calls | id, group_id, meeting_code, start_time, end_time, recording_url, host_id | start(), end(), generate_code(), record() |
| **MeetingParticipant** | Attendance tracking | id, meeting_id, user_id, role, joined_at, left_at | join(), leave(), calculate_duration() |
| **ChatMessage** | Group chat | id, group_id, sender_id, message_type, content, reply_to_id, edited_at, mentioned_user_ids | send(), edit(), delete(), mention_users() |
| **Resource** | File sharing | id, group_id, file_url, file_name, file_type, file_size, uploaded_by, uploaded_at | upload_to_cloudinary(), delete_from_cloudinary() |
| **WhiteboardSession** | Collaborative canvas | id, group_id, session_data (JSON), created_by, active_participants | save_canvas(), load_canvas(), broadcast_changes() |
| **DocumentSession** | Real-time markdown | id, group_id, document_content, version_number, last_edit_by, last_edit_at | apply_operation(), resolve_conflicts(), save_version() |

**Technologies:**
- **WebRTC**: Peer-to-peer video calls (up to 10 participants, mesh topology)
- **Socket.IO**: Real-time synchronization for chat, whiteboard, document editing
- **Cloudinary**: CDN for file storage (images, documents, recordings)
- **Operational Transform**: Conflict resolution algorithm for collaborative editing
- **Message Types**: TEXT (normal chat), FILE (attachments), IMAGE (embedded images), MENTION (@username notifications), SYSTEM (bot messages like "User joined")

**Business Rules:**
- BR-60: Maximum 10 participants per video call (WebRTC P2P limit)
- BR-61: Chat messages can be edited within 5 minutes, deleted within 10 minutes
- BR-62: @Mentions trigger notifications to mentioned users
- BR-63: File uploads maximum 100MB via Cloudinary CDN
- BR-64: Whiteboard canvas saved every 30 seconds (auto-save)
- BR-65: Document changes synchronized with <100ms latency via Socket.IO
- BR-66: Meeting recordings stored in Cloudinary with 30-day retention

---

### 4.3.5.6. Evaluation Module

![Figure 4.3.6: Evaluation Module Class Diagram](diagrams/4.3.6-class-evaluation-module.png)

*Figure 4.3.6: **Evaluation Module Class Diagram** - Module đánh giá toàn diện với 5 entities. PeerReview (anonymous peer review với 4-dimension scoring: cooperation_score, contribution_score, communication_score, technical_score - mỗi chiều 0-10 points, tổng 0-40, comment text feedback, anonymized để tránh bias), GroupEvaluation (overall assessment từ lecturer với overall_score, presentation_score, report_score, teamwork_score, strengths/weaknesses/suggestions text), MemberEvaluation (individual grade calculation theo formula: group_base_score 50% + peer_review_average 25% + checkpoint_contribution 15% + attendance_percentage 10%, attendance_penalty -10% nếu <80%, peer_review_penalty -15% nếu <20/40, late_submission_penalty -5%/day, final_grade 0-10), CheckpointEvaluation (grading cho từng checkpoint submission với grade 0-10, feedback text, optional feedback_file_url, draft mode trước khi publish), và MilestoneAnswer (group responses to research questions với answer_text, submitted_at, reviewed_by). Final grade formula: (group_base × 0.5 + peer_avg × 0.25 + contribution × 0.15 + attendance × 0.1) - penalties.*

**Key Components:**

| **Entity** | **Purpose** | **Key Attributes** | **Key Methods** |
|------------|-------------|-------------------|-----------------|
| **PeerReview** | Anonymous peer scoring | id, reviewer_id, reviewed_member_id, cooperation_score, contribution_score, communication_score, technical_score, comment, is_anonymous | calculate_total_score(), anonymize() |
| **GroupEvaluation** | Overall group assessment | id, group_id, evaluator_id, overall_score, presentation_score, report_score, teamwork_score, strengths, weaknesses, suggestions | calculate_average_score() |
| **MemberEvaluation** | Individual final grades | id, member_id, group_base_score, peer_review_average, checkpoint_contribution, attendance_percentage, late_submission_penalty, attendance_penalty, peer_review_penalty, final_grade | calculate_final_grade() |
| **CheckpointEvaluation** | Checkpoint grading | id, checkpoint_id, evaluator_id, grade, feedback, feedback_file_url, is_draft | publish(), save_draft() |
| **MilestoneAnswer** | Research question responses | id, milestone_id, group_id, question_id, answer_text, submitted_at, reviewed_by | submit(), review() |

**Grading Formula:**
```
final_grade = (group_base_score × 0.5 + 
               peer_review_average × 0.25 + 
               checkpoint_contribution × 0.15 + 
               attendance_percentage × 0.1) - penalties

where:
- group_base_score: GroupEvaluation.overall_score (0-10)
- peer_review_average: avg(PeerReview.total_score) / 4 (normalized to 0-10)
- checkpoint_contribution: avg(CheckpointAssignment.contribution_percentage) × 10
- attendance_percentage: (attended_meetings / total_meetings) × 10

penalties:
- late_submission_penalty: -5% per day (max -25%)
- attendance_penalty: -10% if attendance < 80%
- peer_review_penalty: -15% if peer_review_average < 5/10
```

**Business Rules:**
- BR-50: Each student must review ALL group members (excluding self)
- BR-51: Self-reviews are not allowed (enforced at API level)
- BR-52: Peer reviews due within 3 days after project completion deadline
- BR-53: Peer reviews are anonymous (reviewer_id hidden from reviewed_member)
- BR-54: 4 scoring dimensions: Cooperation, Contribution, Communication, Technical (each 0-10)
- BR-55: Checkpoint evaluations can be saved as draft before publishing
- BR-56: Published grades cannot be edited (only via Head override with reason)
- BR-57: Final grade calculation uses weighted formula with penalties
- BR-58: Attendance penalty applied if <80% meeting attendance
- BR-59: MilestoneAnswers reviewed by lecturer with optional feedback

---

### Backend Class Structure

**Complete class diagrams available in**: [`diagrams/02-CLASS-GUIDE.md`](../../diagrams/02-CLASS-GUIDE.md) (766 lines)

**Key Classes:**

#### 1. User Model (`app/models/user.py`)
```python
class User(SQLModel, table=True):
    __tablename__ = "users"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(unique=True, index=True, max_length=50)
    email: str = Field(unique=True, index=True, max_length=100)
    hashed_password: str
    full_name: str = Field(max_length=100)
    role: UserRole = Field(default=UserRole.STUDENT)
    avatar_url: Optional[str] = None
    phone: Optional[str] = Field(default=None, max_length=20)
    is_active: bool = Field(default=True)
    last_login: Optional[datetime] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    created_projects: List["Project"] = Relationship(back_populates="creator")
    group_memberships: List["GroupMember"] = Relationship(back_populates="student")
```

#### 2. Project Model (`app/models/project.py`)
```python
class Project(SQLModel, table=True):
    __tablename__ = "projects"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    title: str = Field(max_length=200)
    description: str
    objectives: Optional[str] = None
    scope: Optional[str] = None
    expected_outcomes: Optional[str] = None
    created_by: int = Field(foreign_key="users.id")
    status: ProjectStatus = Field(default=ProjectStatus.PENDING)
    approval_status: Optional[ApprovalStatus] = None
    approved_by: Optional[int] = Field(default=None, foreign_key="users.id")
    rejection_reason: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    creator: Optional[User] = Relationship(back_populates="created_projects")
    milestones: List["ProjectMilestone"] = Relationship(back_populates="project")
    class_projects: List["ClassProject"] = Relationship(back_populates="project")
```

#### 3. Group Model (`app/models/group.py`)
```python
class Group(SQLModel, table=True):
    __tablename__ = "groups"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(max_length=100)
    class_id: int = Field(foreign_key="classes.id")
    project_id: Optional[int] = Field(default=None, foreign_key="projects.id")
    leader_id: int = Field(foreign_key="users.id")
    description: Optional[str] = None
    status: GroupStatus = Field(default=GroupStatus.ACTIVE)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    class_obj: Optional["Class"] = Relationship(back_populates="groups")
    project: Optional["Project"] = Relationship()
    leader: Optional[User] = Relationship()
    members: List["GroupMember"] = Relationship(back_populates="group")
    chat_messages: List["ChatMessage"] = Relationship(back_populates="group")
```

### Frontend Component Structure

**Main Components:**

#### 1. Authentication Components (`src/components/Auth/`)
```javascript
// LoginForm.jsx
export const LoginForm = () => {
  const [credentials, setCredentials] = useState({ username: '', password: '' });
  const { login } = useAuth();
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    await login(credentials);
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <TextField label="Username" value={credentials.username} />
      <TextField type="password" label="Password" value={credentials.password} />
      <Button type="submit">Login</Button>
    </form>
  );
};
```

#### 2. Project Components (`src/components/Project/`)
```javascript
// ProjectCard.jsx
export const ProjectCard = ({ project }) => {
  const statusColor = {
    PENDING: 'warning',
    APPROVED: 'success',
    REJECTED: 'error'
  };
  
  return (
    <Card>
      <CardContent>
        <Typography variant="h6">{project.title}</Typography>
        <Chip label={project.status} color={statusColor[project.status]} />
        <Typography>{project.description}</Typography>
      </CardContent>
      <CardActions>
        <Button onClick={() => navigate(`/projects/${project.id}`)}>View Details</Button>
      </CardActions>
    </Card>
  );
};
```

#### 3. Group Workspace Components (`src/components/Group/`)
```javascript
// GroupWorkspace.jsx
export const GroupWorkspace = ({ groupId }) => {
  const [activeTab, setActiveTab] = useState('tasks');
  
  return (
    <Container>
      <Tabs value={activeTab} onChange={(e, v) => setActiveTab(v)}>
        <Tab label="Tasks" value="tasks" />
        <Tab label="Chat" value="chat" />
        <Tab label="Resources" value="resources" />
        <Tab label="Meetings" value="meetings" />
      </Tabs>
      
      {activeTab === 'tasks' && <KanbanBoard groupId={groupId} />}
      {activeTab === 'chat' && <ChatWindow groupId={groupId} />}
      {activeTab === 'resources' && <ResourceList groupId={groupId} />}
      {activeTab === 'meetings' && <MeetingList groupId={groupId} />}
    </Container>
  );
};
```

---

## 4.3.6. SEQUENCE DIAGRAMS

**Complete sequence diagrams guide**: [`diagrams/guides/04-SEQUENCE-DIAGRAMS-GUIDE.md`](diagrams/guides/04-SEQUENCE-DIAGRAMS-GUIDE.md)

This section presents 10 key sequence diagrams that illustrate critical user interactions and system flows in CollabSphere. Each diagram shows the communication between actors, frontend, backend, database, and external services.

---

### 1. User Authentication Flow

![Figure 4.3.7: Authentication Flow](diagrams/4.3.7-seq-authentication.png)

*Figure 4.3.7: User login sequence showing credential validation, JWT token generation with bcrypt password verification, and localStorage token storage. Includes error handling for invalid credentials and account status validation.*

**Key Steps:**
1. User enters email and password in login form
2. Frontend validates input and sends POST /api/auth/login
3. Backend queries user from database by email
4. Backend verifies password using bcrypt.compare()
5. Backend generates JWT access token (expires 24h) and refresh token
6. Backend updates last_login timestamp
7. Frontend stores tokens in localStorage
8. Frontend redirects to dashboard

**Alternative Flows:**
- Invalid credentials → 401 Unauthorized error
- Account deactivated → 403 Forbidden error
- Server error → 500 Internal Server Error with retry logic

---

### 2. Create Project with AI Milestone Generation

![Figure 4.3.8: Create Project Flow](diagrams/4.3.8-seq-create-project.png)

*Figure 4.3.8: Lecturer creates project with optional AI-powered milestone generation using AWS Bedrock (Claude). Shows form validation, AI integration, milestone editing, and atomic transaction with database.*

**Key Steps:**
1. Lecturer fills project form (title, description, subject, duration)
2. Lecturer optionally clicks "Generate Milestones with AI"
3. Frontend sends project description to Backend AI endpoint
4. Backend forwards request to AWS Bedrock (Claude API)
5. AI returns suggested milestones in JSON format
6. Frontend displays editable milestone suggestions
7. Lecturer reviews/modifies milestones
8. Frontend submits complete project data
9. Backend validates and saves project + milestones in transaction
10. Backend returns project_id with status "pending"

**AI Integration:**
- Service: AWS Bedrock with Claude model
- Input: Project description + duration weeks
- Output: Array of milestones with title, description, week_number
- Fallback: Manual milestone entry if AI unavailable

---

### 3. Approve Project Flow

![Figure 4.3.9: Approve Project Flow](diagrams/4.3.9-seq-approve-project.png)

*Figure 4.3.9: Head of Department reviews and approves/denies project submissions. Includes authorization check, status transition validation, notification system integration, and asynchronous email delivery.*

**Key Steps:**
1. Head views list of pending projects for their department
2. Head clicks on project to review details
3. Frontend displays project with milestones and lecturer info
4. Head clicks "Approve" (or "Deny" with reason)
5. Backend validates Head role and department permission
6. Backend updates project status to "approved" with timestamp
7. Backend creates notification record for lecturer
8. Backend queues email notification (async)
9. Notification service sends email to lecturer
10. Frontend shows success message and updates UI

**Authorization:**
- Only Head of Department can approve
- Must be same department as project's lecturer
- Once approved, cannot be denied (immutable)

**Alternative Flow - Deny:**
- Head enters denial reason (required)
- Status set to "denied" with reason stored
- Lecturer can edit and resubmit project

---

### 4. Create Team and Add Members

![Figure 4.3.10: Create Team Flow](diagrams/4.3.10-seq-create-team.png)

*Figure 4.3.10: Lecturer creates team and adds 3-5 student members with role assignment (1 leader, 2-4 members). Shows business rule validation (team size, uniqueness, student availability) and batch member insertion.*

**Key Steps:**
1. Lecturer navigates to class Teams tab
2. Lecturer clicks "Create Team" and enters name
3. Backend validates team name uniqueness within class
4. Backend creates group record and returns group_id
5. Lecturer clicks "Add Members"
6. Backend queries available students (not in other teams)
7. Frontend displays student selection with role dropdown
8. Lecturer selects 3-5 students and assigns roles
9. Backend validates team size and leader count
10. Backend batch inserts members into group_members table
11. Backend creates notifications for all added students

**Business Rules (BR-08, BR-09, BR-10):**
- Team must have 3-5 members
- Exactly 1 leader required
- Student can only be in 1 team per class
- Team name unique within class

---

### 5. Student Picks Project for Team

![Figure 4.3.11: Student Picks Project](diagrams/4.3.11-seq-pick-project.png)

*Figure 4.3.11: Student (team leader) selects approved project for their team. Includes race condition handling with SELECT FOR UPDATE, milestone cloning to group context, and team-wide notifications.*

**Key Steps:**
1. Student navigates to team workspace
2. Backend returns available approved projects (not yet picked)
3. Student browses projects and reads details
4. Student clicks "Pick This Project" and confirms
5. Backend validates student is team leader
6. Backend uses SELECT FOR UPDATE to prevent race condition
7. Backend updates group.project_id atomically
8. Backend clones project_milestones to group_milestones
9. Backend marks project as "picked" if single-team project
10. Backend creates notifications for all team members
11. Frontend redirects to workspace with project milestones

**Race Condition Handling:**
- Use SELECT FOR UPDATE for atomic check-and-update
- If project picked by another team between check and update → 409 Conflict
- Transaction rollback if any step fails

---

### 6. Submit Checkpoint with Files

![Figure 4.3.12: Submit Checkpoint](diagrams/4.3.12-seq-submit-checkpoint.png)

*Figure 4.3.12: Student submits checkpoint deliverable with multiple file uploads to Cloudinary CDN. Shows client-side validation, external storage integration, late submission handling, and lecturer notification.*

**Key Steps:**
1. Student opens checkpoint submission form
2. Student enters submission text and selects files
3. Frontend validates file types (PDF, DOCX, PNG, etc.) and sizes
4. For each file, Frontend uploads directly to Cloudinary
5. Cloudinary returns secure file URLs
6. Frontend collects all file URLs
7. Frontend sends POST /api/checkpoint-submissions with text + URLs
8. Backend validates student is team member and deadline
9. Backend marks submission as "late" if past due_date
10. Backend inserts checkpoint_submission record
11. Backend updates checkpoint status to "submitted"
12. Backend creates notification for lecturer
13. Frontend shows success (with late warning if applicable)

**File Upload:**
- Storage: Cloudinary CDN
- Max size: 10MB per file, 100MB total
- Allowed types: PDF, DOCX, XLSX, PPTX, PNG, JPG, ZIP, MP4
- Security: Signed URLs with expiry
- Retry: 3 attempts if upload fails

---

### 7. Evaluate Checkpoint Submission

![Figure 4.3.13: Evaluate Checkpoint](diagrams/4.3.13-seq-evaluate-checkpoint.png)

*Figure 4.3.13: Lecturer reviews checkpoint submission and provides grade (0-10) with feedback. Includes file download from Cloudinary, evaluation record creation, and student notification via WebSocket + email.*

**Key Steps:**
1. Lecturer views team's submitted checkpoints
2. Lecturer clicks on submitted checkpoint
3. Backend returns full submission with file URLs
4. Frontend displays submission text and download links
5. Lecturer reviews work and downloads files from Cloudinary
6. Lecturer enters grade (0-10) and feedback text
7. Lecturer clicks "Submit Evaluation"
8. Backend validates lecturer owns class and grade range
9. Backend creates checkpoint_evaluation record
10. Backend updates submission.is_evaluated = TRUE
11. Backend creates notification for student who submitted
12. Notification service sends email with grade and feedback
13. Frontend updates UI to show "evaluated" status

**Re-evaluation:**
- Lecturer can re-evaluate with confirmation
- Updates existing evaluation record
- Student receives "evaluation updated" notification

**Draft Mode:**
- Lecturer can save draft (not visible to student)
- Allows partial grading and continue later

---

### 8. Peer Review Process

![Figure 4.3.14: Peer Review Flow](diagrams/4.3.14-seq-peer-review.png)

*Figure 4.3.14: Student evaluates team members at milestone completion using 4-dimensional scoring system (cooperation, contribution, communication, technical skills). Reviews are anonymous to reviewees and aggregated for lecturer.*

**Key Steps:**
1. System triggers peer review period (milestone completed)
2. Student receives notification "Peer Review Available"
3. Student navigates to Peer Reviews page
4. Backend returns team members to review (excluding self)
5. Student fills review form for each member:
   - Cooperation score (1-5)
   - Contribution score (1-5)
   - Communication score (1-5)
   - Technical skills score (1-5)
   - Optional comments
6. Student submits all reviews in batch
7. Backend validates scores in range and no self-review
8. Backend batch inserts peer_review records
9. Backend marks reviews as completed for this student
10. Frontend shows "Thank you" confirmation

**Anonymity:**
- Reviewee cannot see who reviewed them
- Only aggregated scores and anonymous comments visible
- Lecturer sees all reviews including reviewer names

**After Review Period:**
- Student can view their received reviews (aggregated)
- Average scores displayed in radar chart
- Anonymous feedback comments shown

---

### 9. Real-time Chat with WebSocket

![Figure 4.3.15: Real-time Chat](diagrams/4.3.15-seq-chat-message.png)

*Figure 4.3.15: Bidirectional real-time chat using WebSocket (Socket.IO) for team communication. Shows connection establishment, room joining, message broadcasting, @mention notifications, and message editing within 5-minute window.*

**Key Steps:**
1. User opens team workspace
2. Frontend establishes WebSocket connection with JWT
3. Frontend emits "join_room" event with team_id
4. Socket.IO server adds user to team room
5. Frontend loads recent chat history (REST API)
6. Backend returns last 50 messages
7. User types message and clicks Send
8. Frontend emits "send_message" event via WebSocket
9. Socket.IO validates user in team
10. Socket.IO saves message to database
11. Socket.IO broadcasts "new_message" to all room members
12. All connected clients receive and display message instantly

**Features:**
- Real-time updates (< 500ms latency)
- Persistent chat history with pagination
- @Mention notifications (email + WebSocket)
- Edit message within 5 minutes
- Delete own messages
- File attachments via URL (uploaded to Cloudinary first)
- Typing indicators (optional)
- Automatic reconnection on disconnect

**WebSocket Events:**
- `join_room`: Subscribe to team chat
- `send_message`: Broadcast new message
- `edit_message`: Update existing message
- `delete_message`: Remove message
- `new_message`: Receive message from others
- `message_edited`: Notification of edit
- `user_typing`: Typing indicator (optional)

---

### 10. Video Call with WebRTC

![Figure 4.3.16: Video Call Flow](diagrams/4.3.16-seq-video-call.png)

*Figure 4.3.16: Peer-to-peer video conferencing using WebRTC with Socket.IO signaling server. Shows SDP offer/answer exchange, ICE candidate gathering via STUN/TURN servers, media stream establishment, and graceful disconnection.*

**Key Steps:**

**Initiate Call:**
1. User A clicks "Start Video Call"
2. Frontend creates meeting record in database
3. Frontend requests camera/microphone permissions
4. Browser prompts user for media access
5. Frontend gets local media stream (video + audio)
6. Frontend displays local video preview
7. Frontend emits "call_initiated" via Socket.IO
8. Socket.IO broadcasts to all team members

**Receive Call:**
9. User B receives "incoming_call" event
10. Frontend shows call notification modal
11. User B clicks "Join"
12. Frontend B requests media permissions
13. Frontend B gets local media stream

**WebRTC Handshake:**
14. Frontend A creates RTCPeerConnection with STUN config
15. Frontend A adds local media tracks
16. Frontend A creates SDP offer
17. Frontend A emits "webrtc_offer" to User B
18. Frontend B receives offer and creates RTCPeerConnection
19. Frontend B sets remote description (offer)
20. Frontend B creates SDP answer
21. Frontend B emits "webrtc_answer" to User A
22. Frontend A receives answer and sets remote description

**ICE Candidate Exchange:**
23. Both sides discover public IPs via STUN servers
24. Frontend A emits ICE candidates to Frontend B
25. Frontend B emits ICE candidates to Frontend A
26. Both sides add received ICE candidates
27. ICE negotiation completes, connection state = "connected"

**Media Streaming:**
28. P2P connection established (media flows directly)
29. Both users see each other's video/audio
30. Users can toggle mute, camera, share screen

**End Call:**
31. User clicks "Leave Call"
32. Frontend closes RTCPeerConnection
33. Frontend stops local media tracks
34. Frontend emits "leave_call" event
35. Other participants receive "user_left" notification
36. Backend updates meeting record with end time

**STUN/TURN Servers:**
- STUN: Discover public IP behind NAT
- TURN: Relay media when P2P fails (firewall/NAT restrictions)
- Configured per RTCPeerConnection
- Fallback to TURN if ICE state = "failed"

**Features:**
- Low latency P2P streaming
- Audio/video/screen sharing
- Adaptive bitrate (quality adjustment)
- Echo cancellation & noise suppression
- Multiple participants (mesh topology)
- Meeting record for attendance tracking

---

## 4.3.7. INTERACTION SUMMARIES

### Key Interaction Flows (Text Summary)
```
Student                 Frontend              Backend               Database
  |                        |                      |                     |
  |--1. Enter credentials->|                      |                     |
  |                        |--2. POST /auth/login-|                     |
  |                        |                      |--3. Query user----->|
  |                        |                      |<-4. Return user-----|
  |                        |                      |--5. Verify password-|
  |                        |                      |--6. Generate JWT----|
  |                        |<-7. Return tokens----|                     |
  |<-8. Redirect to home---|                      |                     |
  |                        |--9. Store in localStorage                   |
```

#### 2. Project Approval Workflow
```
Lecturer    Frontend     Backend    Database    Notification    Head
  |            |            |           |             |           |
  |--Create--->|            |           |             |           |
  |            |--POST----->|           |             |           |
  |            |            |--Save---->|             |           |
  |            |<--201------|           |             |           |
  |<--Show-----|            |           |             |           |
  |            |            |           |             |           |
  |--Submit--->|            |           |             |           |
  |            |--PATCH---->|           |             |           |
  |            |            |--Update-->|             |           |
  |            |            |--Notify---------------->|--Notify-->|
  |            |<--200------|           |             |           |
  |<--Show-----|            |           |             |           |
  |            |            |           |             |           |
  |            |            |           |             |<--Review--|
  |            |            |<--PATCH---|             |           |
  |            |            |--Update-->|             |           |
  |<--Notify---|<--Emit WS--|--Notify-->|------------>|           |
```

#### 3. Real-time Chat Sequence
```
User A       Frontend A    Socket.IO    Backend    Database    Frontend B    User B
  |              |             |           |           |            |           |
  |--Type msg--->|             |           |           |            |           |
  |              |--emit------>|           |           |            |           |
  |              |             |--save---->|           |            |           |
  |              |             |           |--INSERT-->|            |           |
  |              |<--ack-------|           |           |            |           |
  |              |             |--broadcast---------->|----------->|--Show---->|
  |              |             |           |           |            |           |
```

#### 4. Peer Review Submission
```
Student      Frontend      Backend       Database      Lecturer
  |             |              |              |             |
  |--Fill form->|              |              |             |
  |             |--POST------->|              |             |
  |             |              |--Validate--->|             |
  |             |              |  (same group)|             |
  |             |              |--Insert----->|             |
  |             |              |  (anonymous) |             |
  |             |<--201--------|              |             |
  |<--Confirm---|              |              |             |
  |             |              |--Aggregate-->|             |
  |             |              |--Notify--------------------->|
```

#### 5. AI Milestone Generation
```
Lecturer     Frontend      Backend      AWS Bedrock     Database
  |             |              |              |             |
  |--Request--->|              |              |             |
  |  (project) |--POST-------->|              |             |
  |             |              |--Prepare---->|             |
  |             |              |  prompt      |             |
  |             |              |<--Stream-----|             |
  |             |              |  response    |             |
  |             |<--SSE--------|              |             |
  |  (preview)  |              |              |             |
  |             |              |              |             |
  |--Approve--->|              |              |             |
  |             |--POST-------->|              |             |
  |             |              |--Batch------->|             |
  |             |              |  insert       |             |
  |             |<--201--------|              |             |
  |<--Show------|              |              |             |
```

---

## 4.3.7. COMPONENT INTERACTION DESIGN

### Frontend State Management

**Context Providers:**
```javascript
// AuthContext.jsx
export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const token = localStorage.getItem('access_token');
    if (token) {
      authService.getMe().then(setUser).finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);
  
  const login = async (credentials) => {
    const response = await authService.login(credentials);
    localStorage.setItem('access_token', response.access_token);
    localStorage.setItem('refresh_token', response.refresh_token);
    setUser(response.user);
  };
  
  const logout = () => {
    localStorage.clear();
    setUser(null);
  };
  
  return (
    <AuthContext.Provider value={{ user, loading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### Service Layer (API Calls)

```javascript
// services/authService.js
import axios from 'axios';
import { API_BASE_URL } from '../config';

const api = axios.create({
  baseURL: API_BASE_URL,
});

// Request interceptor - Add JWT token
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Response interceptor - Handle token refresh
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const refreshToken = localStorage.getItem('refresh_token');
      if (refreshToken) {
        try {
          const response = await axios.post(`${API_BASE_URL}/auth/refresh`, {
            refresh_token: refreshToken
          });
          localStorage.setItem('access_token', response.data.access_token);
          error.config.headers.Authorization = `Bearer ${response.data.access_token}`;
          return api(error.config);
        } catch (refreshError) {
          localStorage.clear();
          window.location.href = '/login';
        }
      }
    }
    return Promise.reject(error);
  }
);

export const authService = {
  login: (credentials) => api.post('/auth/login', credentials).then(r => r.data),
  register: (data) => api.post('/auth/register', data).then(r => r.data),
  getMe: () => api.get('/auth/me').then(r => r.data),
  changePassword: (data) => api.put('/auth/change-password', data).then(r => r.data),
};
```

---

## 4.3.8. ERROR HANDLING STRATEGY

### Backend Exception Handling

```python
# app/utils/exceptions.py
from fastapi import HTTPException, status

class CollabSphereException(HTTPException):
    """Base exception for CollabSphere"""
    pass

class UnauthorizedException(CollabSphereException):
    def __init__(self, detail: str = "Unauthorized"):
        super().__init__(status_code=status.HTTP_401_UNAUTHORIZED, detail=detail)

class ForbiddenException(CollabSphereException):
    def __init__(self, detail: str = "Forbidden"):
        super().__init__(status_code=status.HTTP_403_FORBIDDEN, detail=detail)

class NotFoundException(CollabSphereException):
    def __init__(self, resource: str, id: int):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"{resource} with id {id} not found"
        )

class ValidationException(CollabSphereException):
    def __init__(self, detail: str):
        super().__init__(status_code=status.HTTP_400_BAD_REQUEST, detail=detail)

# Usage in routers
from app.utils.exceptions import NotFoundException, ForbiddenException

@router.get("/projects/{project_id}")
def get_project(project_id: int, current_user: User = Depends(get_current_user)):
    project = session.get(Project, project_id)
    if not project:
        raise NotFoundException("Project", project_id)
    
    if not can_view_project(current_user, project):
        raise ForbiddenException("You don't have permission to view this project")
    
    return project
```

### Frontend Error Handling

```javascript
// utils/errorHandler.js
export const handleApiError = (error) => {
  if (error.response) {
    // Server responded with error status
    const status = error.response.status;
    const message = error.response.data?.detail || 'An error occurred';
    
    switch (status) {
      case 400:
        toast.error(`Validation Error: ${message}`);
        break;
      case 401:
        toast.error('Session expired. Please login again.');
        localStorage.clear();
        window.location.href = '/login';
        break;
      case 403:
        toast.error('You do not have permission to perform this action.');
        break;
      case 404:
        toast.error('Resource not found.');
        break;
      case 500:
        toast.error('Server error. Please try again later.');
        break;
      default:
        toast.error(message);
    }
  } else if (error.request) {
    // Request made but no response
    toast.error('Network error. Please check your connection.');
  } else {
    // Something else happened
    toast.error('An unexpected error occurred.');
  }
};

// Usage in components
try {
  await projectService.createProject(data);
  toast.success('Project created successfully!');
} catch (error) {
  handleApiError(error);
}
```

---

## 4.3.9. PERFORMANCE OPTIMIZATION

### Backend Optimization

**1. Database Query Optimization**
```python
# BAD - N+1 query problem
groups = session.exec(select(Group)).all()
for group in groups:
    print(group.leader.full_name)  # Triggers separate query for each group

# GOOD - Eager loading with joinedload
from sqlalchemy.orm import selectinload

groups = session.exec(
    select(Group)
    .options(selectinload(Group.leader))
    .options(selectinload(Group.members))
).all()
```

**2. Caching Strategy**
```python
from functools import lru_cache
from fastapi_cache import FastAPICache
from fastapi_cache.decorator import cache

@router.get("/subjects")
@cache(expire=3600)  # Cache for 1 hour
async def get_subjects():
    return session.exec(select(Subject)).all()
```

**3. Pagination**
```python
@router.get("/users")
def list_users(skip: int = 0, limit: int = 20):
    if limit > 100:
        limit = 100  # Max limit
    
    total = session.exec(select(func.count(User.id))).one()
    users = session.exec(select(User).offset(skip).limit(limit)).all()
    
    return {"total": total, "items": users, "skip": skip, "limit": limit}
```

### Frontend Optimization

**1. Code Splitting**
```javascript
// Lazy load routes
import { lazy, Suspense } from 'react';

const ProjectPage = lazy(() => import('./pages/ProjectPage'));
const GroupWorkspace = lazy(() => import('./pages/GroupWorkspace'));

function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/projects/:id" element={<ProjectPage />} />
        <Route path="/groups/:id" element={<GroupWorkspace />} />
      </Routes>
    </Suspense>
  );
}
```

**2. React Query for Data Fetching**
```javascript
import { useQuery, useMutation, useQueryClient } from 'react-query';

export const useProjects = () => {
  return useQuery('projects', () => projectService.getProjects(), {
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
  });
};

export const useCreateProject = () => {
  const queryClient = useQueryClient();
  
  return useMutation(
    (data) => projectService.createProject(data),
    {
      onSuccess: () => {
        queryClient.invalidateQueries('projects');
        toast.success('Project created!');
      },
    }
  );
};
```

**3. Virtualization for Large Lists**
```javascript
import { FixedSizeList } from 'react-window';

export const ProjectList = ({ projects }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      <ProjectCard project={projects[index]} />
    </div>
  );
  
  return (
    <FixedSizeList
      height={600}
      itemCount={projects.length}
      itemSize={120}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
};
```

---

## 4.3.10. TESTING CONSIDERATIONS

### Backend Unit Tests
```python
# tests/test_auth.py
import pytest
from fastapi.testclient import TestClient

def test_register_success(client: TestClient):
    response = client.post("/api/v1/auth/register", json={
        "username": "testuser",
        "email": "test@student.fpt.edu.vn",
        "password": "Test123!",
        "full_name": "Test User"
    })
    assert response.status_code == 201
    assert "access_token" in response.json()

def test_register_duplicate_email(client: TestClient, test_user):
    response = client.post("/api/v1/auth/register", json={
        "username": "newuser",
        "email": test_user.email,  # Duplicate email
        "password": "Test123!",
        "full_name": "New User"
    })
    assert response.status_code == 400
    assert "already exists" in response.json()["detail"]
```

### Frontend Component Tests
```javascript
// ProjectCard.test.jsx
import { render, screen, fireEvent } from '@testing-library/react';
import { ProjectCard } from './ProjectCard';

describe('ProjectCard', () => {
  const mockProject = {
    id: 1,
    title: 'Test Project',
    status: 'APPROVED',
    description: 'Test description'
  };
  
  it('renders project title', () => {
    render(<ProjectCard project={mockProject} />);
    expect(screen.getByText('Test Project')).toBeInTheDocument();
  });
  
  it('shows correct status chip color', () => {
    render(<ProjectCard project={mockProject} />);
    const chip = screen.getByText('APPROVED');
    expect(chip).toHaveClass('MuiChip-colorSuccess');
  });
});
```

---

## 4.3.11. DEPLOYMENT CONFIGURATION

### Docker Compose (Development)
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/collabsphere_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    depends_on:
      - db
    volumes:
      - ./backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --reload

  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=collabsphere_db
      - POSTGRES_USER=collabsphere
      - POSTGRES_PASSWORD=secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### Environment Variables
```bash
# .env.production
DATABASE_URL=postgresql://user:pass@prod-db:5432/collabsphere
JWT_SECRET_KEY=super-secret-key-min-32-characters
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

AWS_REGION=ap-southeast-1
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...

CLOUDINARY_CLOUD_NAME=collabsphere
CLOUDINARY_API_KEY=...
CLOUDINARY_API_SECRET=...

CORS_ORIGINS=https://collabsphere.com,https://www.collabsphere.com
```

---

## 4.3.12. REFERENCES

### Documentation Links
- **System Architecture**: [04-ARCHITECTURE-GUIDE.md](../../diagrams/04-ARCHITECTURE-GUIDE.md)
- **Class Diagrams**: [02-CLASS-GUIDE.md](../../diagrams/02-CLASS-GUIDE.md)
- **Sequence Diagrams**: [03-SEQUENCE-GUIDE.md](../../diagrams/03-SEQUENCE-GUIDE.md)
- **Use Cases**: [01-USE-CASE-GUIDE.md](../../diagrams/01-USE-CASE-GUIDE.md)
- **ERD Database**: [ERD_DATABASE_DESIGN_COLLABSPHERE.md](../../ERD_DATABASE_DESIGN_COLLABSPHERE.md)

### Technology Documentation
- **FastAPI**: https://fastapi.tiangolo.com/
- **SQLModel**: https://sqlmodel.tiangolo.com/
- **React**: https://react.dev/
- **Material-UI**: https://mui.com/
- **PostgreSQL**: https://www.postgresql.org/docs/
- **Docker**: https://docs.docker.com/

### API Standards
- **REST API Design**: https://restfulapi.net/
- **HTTP Status Codes**: https://httpstatuses.com/
- **JWT**: https://jwt.io/introduction
- **OpenAPI**: https://swagger.io/specification/

---

**[← Back to 4.2 Database Design](4.2-DatabaseDesign.md)** | **[↑ Back to 04-SDD.md](../04-SDD.md)** | **[Next: Section V - Testing →](../05-Testing.md)**
