# 4.3. DETAILED DESIGN (Thiết kế Chi tiết)

**API Design, Business Logic, Security - CollabSphere**

---

## 4.3.1. API DESIGN OVERVIEW

### API Architecture

**Base URL**: `/api/v1`  
**Protocol**: HTTP/HTTPS  
**Data Format**: JSON  
**Authentication**: JWT Bearer Token  
**API Style**: RESTful

### API Versioning

```
/api/v1/*  - Current version (v1)
/api/v2/*  - Future version (backward compatible)
```

### Standard Response Format

**Success Response:**
```json
{
  "data": { ... },
  "message": "Operation successful",
  "timestamp": "2026-01-04T10:30:00Z"
}
```

**Error Response:**
```json
{
  "detail": "Error message",
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2026-01-04T10:30:00Z",
  "path": "/api/v1/users",
  "method": "POST"
}
```

### HTTP Methods

| Method | Usage | Idempotent |
|--------|-------|------------|
| **GET** | Retrieve resources | ✅ Yes |
| **POST** | Create new resources | ❌ No |
| **PUT** | Full update | ✅ Yes |
| **PATCH** | Partial update | ❌ No |
| **DELETE** | Delete resources | ✅ Yes |

---

## 4.3.2. API ENDPOINTS CATALOG

### Module A: Authentication (`/api/v1/auth`)

#### **POST /auth/register**

**Purpose**: Register new user account (Student only)

**Authentication**: ❌ Not required

**Request Body:**
```json
{
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "password": "Secure123!",
  "full_name": "John Smith",
  "phone": "0123456789",
  "role": "STUDENT"
}
```

**Response (201 Created):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 123,
    "username": "john.student",
    "email": "john@student.fpt.edu.vn",
    "full_name": "John Smith",
    "role": "STUDENT",
    "is_active": true
  }
}
```

**Business Rules:**
- BR-01: Email must be unique
- BR-02: Password minimum 6 characters (8+ recommended)
- BR-04: Only STUDENT role can register publicly
- BR-07: Password must contain uppercase, lowercase, number

---

#### **POST /auth/login**

**Purpose**: User login

**Authentication**: ❌ Not required

**Request Body (OAuth2 Password Flow):**
```json
{
  "username": "john@student.fpt.edu.vn",
  "password": "Secure123!"
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 123,
    "username": "john.student",
    "email": "john@student.fpt.edu.vn",
    "full_name": "John Smith",
    "role": "STUDENT",
    "avatar_url": "https://cloudinary.com/...",
    "last_login": "2026-01-04T10:30:00Z"
  }
}
```

**Error Responses:**
- 401 Unauthorized: Incorrect credentials
- 403 Forbidden: Account deactivated

**Business Logic:**
1. Accept username OR email
2. Verify password with bcrypt
3. Check `is_active` status
4. Update `last_login` timestamp
5. Generate JWT tokens (24h expiry)

---

#### **POST /auth/refresh**

**Purpose**: Refresh access token

**Authentication**: ❌ Not required (refresh token in body)

**Request Body:**
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

---

#### **GET /auth/me**

**Purpose**: Get current user profile

**Authentication**: ✅ Required

**Request Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "full_name": "John Smith",
  "role": "STUDENT",
  "avatar_url": "https://cloudinary.com/...",
  "phone": "0123456789",
  "is_active": true,
  "created_at": "2025-09-01T08:00:00Z",
  "last_login": "2026-01-04T10:30:00Z"
}
```

---

#### **PUT /auth/change-password**

**Purpose**: Change password

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "current_password": "OldPassword123!",
  "new_password": "NewPassword456!"
}
```

**Response (200 OK):**
```json
{
  "message": "Password changed successfully"
}
```

**Business Rules:**
- BR-08: Must verify current password
- BR-02: New password validation

---

### Module B: Users Management (`/api/v1/users`)

#### **GET /users**

**Purpose**: List all users (Admin only)

**Authentication**: ✅ Required (Admin)

**Query Parameters:**
- `role` (optional): Filter by role
- `is_active` (optional): Filter active/inactive
- `skip` (optional): Pagination offset
- `limit` (optional): Items per page (max 100)

**Request:**
```
GET /api/v1/users?role=STUDENT&is_active=true&skip=0&limit=20
```

**Response (200 OK):**
```json
{
  "total": 150,
  "items": [
    {
      "id": 1,
      "username": "john.student",
      "email": "john@student.fpt.edu.vn",
      "full_name": "John Smith",
      "role": "STUDENT",
      "is_active": true,
      "created_at": "2025-09-01T08:00:00Z"
    },
    // ... more users
  ],
  "skip": 0,
  "limit": 20
}
```

**Authorization:**
- Admin: View all users
- Others: 403 Forbidden

---

#### **GET /users/{user_id}**

**Purpose**: Get user by ID

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "email": "john@student.fpt.edu.vn",
  "full_name": "John Smith",
  "role": "STUDENT",
  "avatar_url": "https://cloudinary.com/...",
  "phone": "0123456789",
  "is_active": true,
  "created_at": "2025-09-01T08:00:00Z"
}
```

**Authorization:**
- Admin: View any user
- Others: View own profile only

---

#### **PUT /users/{user_id}**

**Purpose**: Update user profile

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "full_name": "John Smith Updated",
  "phone": "0987654321",
  "avatar_url": "https://cloudinary.com/new-avatar.jpg"
}
```

**Response (200 OK):**
```json
{
  "id": 123,
  "username": "john.student",
  "full_name": "John Smith Updated",
  "phone": "0987654321",
  "avatar_url": "https://cloudinary.com/new-avatar.jpg",
  "updated_at": "2026-01-04T11:00:00Z"
}
```

**Authorization:**
- Admin: Update any user
- Others: Update own profile only

**Business Rules:**
- BR-05: Cannot change own role
- BR-09: Admin cannot deactivate themselves

---

#### **POST /users (Admin only)**

**Purpose**: Create new user by Admin

**Authentication**: ✅ Required (Admin)

**Request Body:**
```json
{
  "username": "jane.lecturer",
  "email": "jane@fpt.edu.vn",
  "password": "TempPassword123!",
  "full_name": "Jane Doe",
  "role": "LECTURER"
}
```

**Response (201 Created):**
```json
{
  "id": 124,
  "username": "jane.lecturer",
  "email": "jane@fpt.edu.vn",
  "full_name": "Jane Doe",
  "role": "LECTURER",
  "is_active": true
}
```

---

### Module C: Subjects & Curricula (`/api/v1/subjects`)

#### **POST /subjects**

**Purpose**: Create new subject (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "code": "SE401",
  "name": "Capstone Project",
  "credits": 6,
  "description": "Final year capstone project"
}
```

**Response (201 Created):**
```json
{
  "id": 10,
  "code": "SE401",
  "name": "Capstone Project",
  "credits": 6,
  "description": "Final year capstone project",
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-16: Subject code must be unique
- BR-18: Subject code is immutable after creation

---

#### **GET /subjects**

**Purpose**: List all subjects

**Authentication**: ✅ Required

**Query Parameters:**
- `skip`, `limit`: Pagination

**Response (200 OK):**
```json
{
  "total": 50,
  "items": [
    {
      "id": 10,
      "code": "SE401",
      "name": "Capstone Project",
      "credits": 6,
      "description": "Final year capstone project"
    },
    // ... more subjects
  ]
}
```

---

#### **POST /subjects/{subject_id}/curricula**

**Purpose**: Add curriculum content (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "week_number": 1,
  "content": "Introduction to Software Engineering principles",
  "learning_outcomes": "Understand SDLC, Agile methodologies"
}
```

**Response (201 Created):**
```json
{
  "id": 101,
  "subject_id": 10,
  "week_number": 1,
  "content": "Introduction to Software Engineering principles",
  "learning_outcomes": "Understand SDLC, Agile methodologies",
  "created_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /subjects/{subject_id}/curricula**

**Purpose**: Get curriculum for subject

**Authentication**: ✅ Required

**Response (200 OK):**
```json
[
  {
    "id": 101,
    "subject_id": 10,
    "week_number": 1,
    "content": "Introduction to Software Engineering",
    "learning_outcomes": "..."
  },
  {
    "id": 102,
    "week_number": 2,
    "content": "Requirements Engineering",
    "learning_outcomes": "..."
  }
]
```

---

### Module D: Classes (`/api/v1/classes`)

#### **POST /classes**

**Purpose**: Create new class (Staff only)

**Authentication**: ✅ Required (Staff/Admin)

**Request Body:**
```json
{
  "code": "SE1701",
  "name": "Software Engineering - Class 01",
  "subject_id": 10,
  "lecturer_id": 124,
  "semester": "Spring2025",
  "academic_year": "2024-2025",
  "max_students": 40
}
```

**Response (201 Created):**
```json
{
  "id": 50,
  "code": "SE1701",
  "name": "Software Engineering - Class 01",
  "subject_id": 10,
  "lecturer_id": 124,
  "lecturer_name": "Jane Doe",
  "semester": "Spring2025",
  "status": "ACTIVE",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

#### **GET /classes**

**Purpose**: List classes

**Authentication**: ✅ Required

**Query Parameters:**
- `lecturer_id` (optional): Filter by lecturer
- `semester` (optional): Filter by semester
- `status` (optional): Filter by status

**Response (200 OK):**
```json
{
  "total": 20,
  "items": [
    {
      "id": 50,
      "code": "SE1701",
      "name": "Software Engineering - Class 01",
      "subject": {
        "id": 10,
        "code": "SE401",
        "name": "Capstone Project"
      },
      "lecturer": {
        "id": 124,
        "full_name": "Jane Doe"
      },
      "semester": "Spring2025",
      "student_count": 35,
      "max_students": 40,
      "status": "ACTIVE"
    }
  ]
}
```

**Authorization:**
- Admin/Staff: View all classes
- Lecturer: View own classes only
- Student: View enrolled classes only

---

#### **POST /classes/{class_id}/members**

**Purpose**: Add student to class (Staff/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "student_id": 123,
  "role": "MEMBER"
}
```

**Response (201 Created):**
```json
{
  "id": 201,
  "class_id": 50,
  "student_id": 123,
  "student_name": "John Smith",
  "role": "MEMBER",
  "joined_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /classes/{class_id}/members**

**Purpose**: List students in class

**Authentication**: ✅ Required

**Response (200 OK):**
```json
[
  {
    "id": 201,
    "student_id": 123,
    "student": {
      "id": 123,
      "username": "john.student",
      "full_name": "John Smith",
      "email": "john@student.fpt.edu.vn",
      "avatar_url": "..."
    },
    "role": "MEMBER",
    "joined_at": "2026-01-04T10:30:00Z"
  }
]
```

---

### Module E: Projects (`/api/v1/projects`)

#### **POST /projects**

**Purpose**: Create new project (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "title": "E-commerce Web Application",
  "description": "Build a full-stack e-commerce platform...",
  "objectives": "Learn full-stack development, database design...",
  "scope": "Frontend (React), Backend (FastAPI), Database (PostgreSQL)",
  "expected_outcomes": "Working web application with authentication, shopping cart..."
}
```

**Response (201 Created):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "description": "Build a full-stack e-commerce platform...",
  "created_by": 124,
  "creator_name": "Jane Doe",
  "status": "PENDING",
  "approval_status": null,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-21: Initial status = PENDING

---

#### **POST /projects/{project_id}/submit**

**Purpose**: Submit project for approval (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Response (200 OK):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "status": "SUBMITTED",
  "approval_status": "PENDING_REVIEW",
  "submitted_at": "2026-01-04T11:00:00Z"
}
```

---

#### **POST /projects/{project_id}/approve**

**Purpose**: Approve project (Head only)

**Authentication**: ✅ Required (Head/Admin)

**Response (200 OK):**
```json
{
  "id": 301,
  "title": "E-commerce Web Application",
  "status": "APPROVED",
  "approval_status": "APPROVED",
  "approved_by": 125,
  "approved_at": "2026-01-04T12:00:00Z"
}
```

**Business Rules:**
- BR-20: Head can view all projects
- BR-23: Approved projects are immutable (unless Head updates)

---

#### **POST /projects/{project_id}/reject**

**Purpose**: Reject project (Head only)

**Authentication**: ✅ Required (Head/Admin)

**Request Body:**
```json
{
  "rejection_reason": "Scope too large for one semester. Please narrow down to 3-4 main features."
}
```

**Response (200 OK):**
```json
{
  "id": 301,
  "status": "REJECTED",
  "approval_status": "REJECTED",
  "rejection_reason": "Scope too large for one semester...",
  "rejected_at": "2026-01-04T12:00:00Z"
}
```

**Business Rules:**
- BR-22: Rejection reason is required

---

#### **GET /projects**

**Purpose**: List projects

**Authentication**: ✅ Required

**Query Parameters:**
- `status`: Filter by status
- `approval_status`: Filter by approval status
- `created_by`: Filter by creator (lecturer)

**Response (200 OK):**
```json
{
  "total": 50,
  "items": [
    {
      "id": 301,
      "title": "E-commerce Web Application",
      "description": "Build a full-stack...",
      "creator": {
        "id": 124,
        "full_name": "Jane Doe"
      },
      "status": "APPROVED",
      "approval_status": "APPROVED",
      "milestone_count": 5,
      "created_at": "2026-01-04T10:00:00Z"
    }
  ]
}
```

**Authorization:**
- Admin/Head: View all projects
- Lecturer: View own projects only
- Student: View approved + assigned projects only

---

#### **POST /projects/{project_id}/milestones**

**Purpose**: Add milestone to project (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS and database design",
  "order_index": 1,
  "duration_weeks": 2
}
```

**Response (201 Created):**
```json
{
  "id": 401,
  "project_id": 301,
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS and database design",
  "order_index": 1,
  "duration_weeks": 2,
  "created_at": "2026-01-04T10:30:00Z"
}
```

---

#### **POST /projects/{project_id}/milestones/generate-ai**

**Purpose**: Auto-generate milestones using AI (Lecturer)

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "project_description": "Build e-commerce platform with React and FastAPI",
  "duration_weeks": 16
}
```

**Response (200 OK):**
```json
{
  "milestones": [
    {
      "title": "Milestone 1: Requirements Analysis",
      "description": "Define requirements, create SRS document",
      "order_index": 1,
      "duration_weeks": 2
    },
    {
      "title": "Milestone 2: System Design",
      "description": "Database design, architecture design",
      "order_index": 2,
      "duration_weeks": 2
    },
    // ... more milestones (AI generated)
  ],
  "generated_by": "AWS Bedrock Claude"
}
```

**Business Rules:**
- BR-51: AI-generated content must be reviewed by user
- BR-52: AI requests limited to 50/day/user

---

### Module F: Groups & Workspaces (`/api/v1/groups`)

#### **POST /groups**

**Purpose**: Create group (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "name": "Team Alpha",
  "class_id": 50,
  "project_id": 301,
  "leader_id": 123,
  "description": "Group working on e-commerce project"
}
```

**Response (201 Created):**
```json
{
  "id": 501,
  "name": "Team Alpha",
  "class_id": 50,
  "project_id": 301,
  "leader": {
    "id": 123,
    "full_name": "John Smith"
  },
  "status": "ACTIVE",
  "member_count": 1,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-33: Team must have 3-5 members
- BR-34: Exactly one team leader
- BR-35: Student can only be in one team per class

---

#### **POST /groups/{group_id}/members**

**Purpose**: Add member to group (Lecturer/Leader)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "student_id": 126,
  "role": "MEMBER"
}
```

**Response (201 Created):**
```json
{
  "id": 601,
  "group_id": 501,
  "student": {
    "id": 126,
    "full_name": "Alice Johnson"
  },
  "role": "MEMBER",
  "contribution_score": 0.0,
  "joined_at": "2026-01-04T10:30:00Z"
}
```

---

#### **GET /groups/{group_id}**

**Purpose**: Get group details

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 501,
  "name": "Team Alpha",
  "class": {
    "id": 50,
    "code": "SE1701",
    "name": "Software Engineering - Class 01"
  },
  "project": {
    "id": 301,
    "title": "E-commerce Web Application"
  },
  "leader": {
    "id": 123,
    "full_name": "John Smith"
  },
  "members": [
    {
      "id": 601,
      "student": {
        "id": 123,
        "full_name": "John Smith",
        "avatar_url": "..."
      },
      "role": "LEADER",
      "contribution_score": 0.0
    },
    {
      "id": 602,
      "student": {
        "id": 126,
        "full_name": "Alice Johnson"
      },
      "role": "MEMBER",
      "contribution_score": 0.0
    }
  ],
  "milestones": [
    {
      "id": 701,
      "title": "Milestone 1: Requirements",
      "deadline": "2026-01-20T23:59:59Z",
      "status": "PENDING",
      "is_completed": false
    }
  ],
  "status": "ACTIVE",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

#### **POST /groups/{group_id}/milestones**

**Purpose**: Create milestone for group (Lecturer)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "title": "Milestone 1: Requirements & Design",
  "description": "Complete SRS document",
  "deadline": "2026-01-20T23:59:59Z"
}
```

**Response (201 Created):**
```json
{
  "id": 701,
  "group_id": 501,
  "title": "Milestone 1: Requirements & Design",
  "deadline": "2026-01-20T23:59:59Z",
  "status": "PENDING",
  "is_completed": false
}
```

---

#### **PUT /groups/{group_id}/milestones/{milestone_id}/complete**

**Purpose**: Mark milestone as complete (Leader only)

**Authentication**: ✅ Required (Group Leader)

**Response (200 OK):**
```json
{
  "id": 701,
  "title": "Milestone 1: Requirements & Design",
  "status": "COMPLETED",
  "is_completed": true,
  "completed_at": "2026-01-20T10:00:00Z"
}
```

**Business Rules:**
- BR-40: Only team leader can mark milestones complete

---

#### **POST /groups/{group_id}/checkpoints**

**Purpose**: Create checkpoint (Leader/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "title": "Submit ERD Diagram",
  "description": "Database design document",
  "deadline": "2026-01-15T23:59:59Z",
  "assigned_members": [123, 126]
}
```

**Response (201 Created):**
```json
{
  "id": 801,
  "group_id": 501,
  "title": "Submit ERD Diagram",
  "deadline": "2026-01-15T23:59:59Z",
  "assigned_members": [123, 126],
  "status": "PENDING"
}
```

---

#### **POST /groups/{group_id}/checkpoints/{checkpoint_id}/submit**

**Purpose**: Submit checkpoint (Student)

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "submission_url": "https://drive.google.com/file/d/..."
}
```

**Response (200 OK):**
```json
{
  "id": 801,
  "title": "Submit ERD Diagram",
  "submission_url": "https://drive.google.com/file/d/...",
  "status": "SUBMITTED",
  "submitted_at": "2026-01-15T20:00:00Z"
}
```

---

#### **GET /groups/{group_id}/tasks**

**Purpose**: Get tasks (Kanban board)

**Authentication**: ✅ Required (Group Member)

**Query Parameters:**
- `status`: Filter by status (TODO/IN_PROGRESS/DONE)
- `assigned_to`: Filter by assignee

**Response (200 OK):**
```json
[
  {
    "id": 901,
    "group_id": 501,
    "title": "Create database schema",
    "description": "Design PostgreSQL schema",
    "assigned_to": {
      "id": 123,
      "full_name": "John Smith"
    },
    "status": "IN_PROGRESS",
    "priority": "HIGH",
    "due_date": "2026-01-12T23:59:59Z",
    "created_at": "2026-01-04T10:00:00Z"
  }
]
```

**Business Rules:**
- BR-36: Card can contain multiple tasks
- BR-37: Task can have multiple subtasks
- BR-38: Maximum 3 levels (Card → Task → Subtask)

---

#### **POST /groups/{group_id}/tasks**

**Purpose**: Create task (Group Member)

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "title": "Implement user authentication",
  "description": "JWT authentication with bcrypt",
  "assigned_to": 123,
  "status": "TODO",
  "priority": "HIGH",
  "due_date": "2026-01-12T23:59:59Z"
}
```

**Response (201 Created):**
```json
{
  "id": 902,
  "group_id": 501,
  "title": "Implement user authentication",
  "assigned_to": {
    "id": 123,
    "full_name": "John Smith"
  },
  "status": "TODO",
  "priority": "HIGH",
  "due_date": "2026-01-12T23:59:59Z",
  "created_at": "2026-01-04T11:00:00Z"
}
```

---

### Module G: Evaluations (`/api/v1/evaluations`)

#### **POST /evaluations/groups/{group_id}**

**Purpose**: Evaluate group (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "evaluation_type": "PROGRESS",
  "score": 8.5,
  "feedback": "Good progress on requirements. Need to improve database design.",
  "criteria": {
    "requirements": 9.0,
    "design": 8.0,
    "implementation": 8.5,
    "documentation": 8.0
  }
}
```

**Response (201 Created):**
```json
{
  "id": 1001,
  "group_id": 501,
  "evaluator": {
    "id": 124,
    "full_name": "Jane Doe"
  },
  "evaluation_type": "PROGRESS",
  "score": 8.5,
  "feedback": "Good progress...",
  "created_at": "2026-01-20T10:00:00Z"
}
```

---

#### **POST /evaluations/members/{member_id}**

**Purpose**: Evaluate member (Lecturer only)

**Authentication**: ✅ Required (Lecturer)

**Request Body:**
```json
{
  "score": 9.0,
  "feedback": "Excellent contribution to database design",
  "evaluation_type": "INDIVIDUAL"
}
```

**Response (201 Created):**
```json
{
  "id": 1002,
  "group_member_id": 601,
  "student": {
    "id": 123,
    "full_name": "John Smith"
  },
  "score": 9.0,
  "feedback": "Excellent contribution...",
  "created_at": "2026-01-20T10:00:00Z"
}
```

---

#### **POST /evaluations/peer-review**

**Purpose**: Submit peer review (Student)

**Authentication**: ✅ Required (Student, Group Member)

**Request Body:**
```json
{
  "reviewee_id": 126,
  "group_id": 501,
  "period": "MIDTERM",
  "rating": 4,
  "comments": "Always on time, great teamwork skills",
  "criteria": {
    "communication": 5,
    "technical_skills": 4,
    "teamwork": 5,
    "time_management": 4
  }
}
```

**Response (201 Created):**
```json
{
  "id": 1003,
  "reviewer_id": 123,
  "reviewee_id": 126,
  "group_id": 501,
  "period": "MIDTERM",
  "rating": 4,
  "is_anonymous": true,
  "created_at": "2026-01-20T10:00:00Z"
}
```

**Business Rules:**
- BR-46: Peer reviews anonymous to students
- BR-47: Lecturer can see who submitted
- BR-48: One review per teammate per period

---

#### **GET /evaluations/me**

**Purpose**: Get own evaluations (Student)

**Authentication**: ✅ Required (Student)

**Response (200 OK):**
```json
{
  "group_evaluations": [
    {
      "id": 1001,
      "evaluation_type": "PROGRESS",
      "score": 8.5,
      "feedback": "Good progress...",
      "created_at": "2026-01-20T10:00:00Z"
    }
  ],
  "individual_evaluations": [
    {
      "id": 1002,
      "score": 9.0,
      "feedback": "Excellent contribution...",
      "created_at": "2026-01-20T10:00:00Z"
    }
  ],
  "peer_reviews_received": [
    {
      "period": "MIDTERM",
      "average_rating": 4.2,
      "review_count": 3,
      "anonymous_comments": [
        "Great teamwork",
        "Good technical skills",
        "Could improve communication"
      ]
    }
  ]
}
```

**Business Rules:**
- BR-50: Students see evaluations only after lecturer releases them

---

### Module H: Chat & Meetings (`/api/v1/chat`, `/api/v1/meetings`)

#### **GET /chat/groups/{group_id}/messages**

**Purpose**: Get chat messages

**Authentication**: ✅ Required (Group Member)

**Query Parameters:**
- `skip`, `limit`: Pagination
- `before`: Messages before timestamp

**Response (200 OK):**
```json
{
  "total": 150,
  "items": [
    {
      "id": 1101,
      "sender": {
        "id": 123,
        "full_name": "John Smith",
        "avatar_url": "..."
      },
      "message": "Hey team, let's discuss the database schema",
      "message_type": "TEXT",
      "is_read": true,
      "created_at": "2026-01-04T10:30:00Z"
    },
    {
      "id": 1102,
      "sender": {
        "id": 126,
        "full_name": "Alice Johnson"
      },
      "message": "Sure! I uploaded the ERD diagram",
      "message_type": "TEXT",
      "file_url": "https://cloudinary.com/...",
      "created_at": "2026-01-04T10:31:00Z"
    }
  ]
}
```

---

#### **POST /chat/groups/{group_id}/messages**

**Purpose**: Send chat message

**Authentication**: ✅ Required (Group Member)

**Request Body:**
```json
{
  "message": "Here's my feedback on the design",
  "message_type": "TEXT",
  "file_url": null
}
```

**Response (201 Created):**
```json
{
  "id": 1103,
  "group_id": 501,
  "sender": {
    "id": 123,
    "full_name": "John Smith"
  },
  "message": "Here's my feedback on the design",
  "message_type": "TEXT",
  "created_at": "2026-01-04T11:00:00Z"
}
```

**Real-time**: Also broadcast via WebSocket to online members

**Business Rules:**
- BR-24: Messages can't be edited after 5 minutes
- BR-25: Only sender can delete own messages
- BR-26: Chat history retained for 1 year

---

#### **POST /meetings**

**Purpose**: Create meeting (Group Member/Lecturer)

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "title": "Sprint Planning Meeting",
  "description": "Plan next 2 weeks of development",
  "group_id": 501,
  "scheduled_at": "2026-01-05T14:00:00Z",
  "duration": 60,
  "meeting_url": "https://meet.google.com/abc-defg-hij"
}
```

**Response (201 Created):**
```json
{
  "id": 1201,
  "title": "Sprint Planning Meeting",
  "group_id": 501,
  "created_by": {
    "id": 123,
    "full_name": "John Smith"
  },
  "scheduled_at": "2026-01-05T14:00:00Z",
  "duration": 60,
  "meeting_url": "https://meet.google.com/abc-defg-hij",
  "status": "SCHEDULED",
  "created_at": "2026-01-04T10:00:00Z"
}
```

---

### Module I: Resources (`/api/v1/resources`)

#### **POST /resources**

**Purpose**: Upload resource file

**Authentication**: ✅ Required

**Request Body (multipart/form-data):**
```
file: <binary>
title: "Database Design Document"
description: "ERD and schema"
group_id: 501
```

**Response (201 Created):**
```json
{
  "id": 1301,
  "title": "Database Design Document",
  "description": "ERD and schema",
  "file_url": "https://cloudinary.com/collabsphere/erd-diagram.pdf",
  "file_type": "PDF",
  "file_size": 2048576,
  "uploaded_by": {
    "id": 123,
    "full_name": "John Smith"
  },
  "group_id": 501,
  "created_at": "2026-01-04T10:00:00Z"
}
```

**Business Rules:**
- BR-41: Max file size 100MB
- BR-42: Allowed types: PDF, DOCX, XLSX, PPTX, PNG, JPG, MP4
- BR-45: Immediately available to authorized users

---

#### **GET /resources**

**Purpose**: List resources

**Authentication**: ✅ Required

**Query Parameters:**
- `group_id`: Filter by group
- `class_id`: Filter by class
- `uploaded_by`: Filter by uploader

**Response (200 OK):**
```json
{
  "total": 25,
  "items": [
    {
      "id": 1301,
      "title": "Database Design Document",
      "file_url": "https://cloudinary.com/...",
      "file_type": "PDF",
      "file_size": 2048576,
      "uploaded_by": {
        "id": 123,
        "full_name": "John Smith"
      },
      "created_at": "2026-01-04T10:00:00Z"
    }
  ]
}
```

---

### Module J: AI Assistant (`/api/v1/ai`)

#### **POST /ai/chat**

**Purpose**: Chat with AI assistant

**Authentication**: ✅ Required

**Request Body:**
```json
{
  "message": "How do I implement JWT authentication in FastAPI?",
  "context": {
    "project_id": 301,
    "group_id": 501
  }
}
```

**Response (200 OK):**
```json
{
  "response": "To implement JWT authentication in FastAPI, you need to:\n1. Install python-jose and bcrypt\n2. Create utility functions for token generation...",
  "model": "claude-3-sonnet",
  "tokens_used": 250
}
```

**Business Rules:**
- BR-52: Limited to 50 requests/day/user
- BR-53: Responses stored for training (with consent)
- BR-54: Graceful degradation if AI unavailable

---

#### **POST /ai/projects/{project_id}/generate-milestones**

**Purpose**: AI generate milestones

**Authentication**: ✅ Required (Lecturer, Owner)

**Request Body:**
```json
{
  "duration_weeks": 16
}
```

**Response (200 OK):**
```json
{
  "milestones": [
    {
      "title": "Milestone 1: Requirements Analysis",
      "description": "Complete SRS, use cases, requirements gathering",
      "order_index": 1,
      "duration_weeks": 2
    },
    // ... 5-7 more milestones
  ]
}
```

---

### Module K: Notifications (`/api/v1/notifications`)

#### **GET /notifications**

**Purpose**: Get user notifications

**Authentication**: ✅ Required

**Query Parameters:**
- `is_read`: Filter read/unread
- `type`: Filter by notification type
- `skip`, `limit`: Pagination

**Response (200 OK):**
```json
{
  "total": 50,
  "unread_count": 12,
  "items": [
    {
      "id": 1401,
      "type": "PROJECT_APPROVED",
      "title": "Project Approved",
      "content": "Your project 'E-commerce Web Application' has been approved by Head",
      "link": "/projects/301",
      "is_read": false,
      "created_at": "2026-01-04T12:00:00Z"
    },
    {
      "id": 1402,
      "type": "CHAT_MESSAGE",
      "title": "New message in Team Alpha",
      "content": "John Smith: Hey team, let's discuss...",
      "link": "/groups/501/chat",
      "is_read": true,
      "created_at": "2026-01-04T10:30:00Z"
    }
  ]
}
```

---

#### **PUT /notifications/{notification_id}/read**

**Purpose**: Mark notification as read

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "id": 1401,
  "is_read": true,
  "read_at": "2026-01-04T13:00:00Z"
}
```

---

#### **PUT /notifications/read-all**

**Purpose**: Mark all notifications as read

**Authentication**: ✅ Required

**Response (200 OK):**
```json
{
  "message": "All notifications marked as read",
  "count": 12
}
```

**Business Rules:**
- BR-31: User can mark all as read in one action
- BR-30: Notifications auto-deleted after 30 days

---

## 4.3.3. BUSINESS LOGIC FLOWS

### Flow 1: User Registration & Login

```
1. User submits registration form
   └─> Validate email format
   └─> Check email uniqueness
   └─> Check username uniqueness
   └─> Hash password (bcrypt, rounds=12)
   └─> Create user record
   └─> Generate JWT access token (24h expiry)
   └─> Generate refresh token (7d expiry)
   └─> Return tokens + user info

2. User logs in
   └─> Find user by username OR email
   └─> Verify password with bcrypt
   └─> Check is_active status
   └─> Update last_login timestamp
   └─> Generate new JWT tokens
   └─> Return tokens + user info
```

---

### Flow 2: Project Approval Workflow

```
1. Lecturer creates project (Status: PENDING)
   ├─> Validate title, description
   ├─> Set created_by = current_user.id
   ├─> Set status = PENDING
   └─> Save to database

2. Lecturer submits for approval
   ├─> Check project ownership
   ├─> Set status = SUBMITTED
   ├─> Set approval_status = PENDING_REVIEW
   ├─> Send notification to Head
   └─> Return updated project

3. Head reviews project
   ├─> Check role = HEAD
   ├─> Review project details
   └─> Decide: Approve or Reject

4a. If APPROVED:
   ├─> Set status = APPROVED
   ├─> Set approval_status = APPROVED
   ├─> Set approved_by = head.id
   ├─> Set approved_at = now()
   ├─> Send notification to Lecturer
   └─> Project available for assignment

4b. If REJECTED:
   ├─> Set status = REJECTED
   ├─> Set approval_status = REJECTED
   ├─> Set rejection_reason (REQUIRED)
   ├─> Send notification to Lecturer with reason
   └─> Lecturer can revise and resubmit
```

---

### Flow 3: Group Milestone Tracking

```
1. Lecturer creates milestones for group
   ├─> Copy from project_milestones template
   ├─> Set deadline for each milestone
   ├─> Set status = PENDING
   └─> Notify group members

2. Group works on milestone
   ├─> Team leader assigns tasks
   ├─> Members update task status (TODO → IN_PROGRESS → DONE)
   ├─> Members submit checkpoints
   └─> Lecturer evaluates checkpoints

3. Team leader marks milestone complete
   ├─> Check role = LEADER
   ├─> Set is_completed = TRUE
   ├─> Set completed_at = now()
   ├─> Send notification to Lecturer
   └─> Unlock next milestone (if sequential)

4. Lecturer reviews completion
   ├─> View submission history
   ├─> Evaluate milestone
   ├─> Provide feedback
   └─> Approve or request revision
```

---

### Flow 4: Peer Review Process

```
1. Lecturer opens peer review period
   ├─> Set period (MIDTERM or FINAL)
   ├─> Set deadline
   ├─> Notify all students in class
   └─> Students can submit reviews

2. Student submits peer review
   ├─> Check: Student is in same group as reviewee
   ├─> Check: Not reviewing themselves
   ├─> Check: One review per teammate per period
   ├─> Set is_anonymous = TRUE
   ├─> Calculate average rating
   └─> Save review

3. After deadline passes
   ├─> Aggregate all peer reviews
   ├─> Calculate average ratings
   ├─> Generate anonymous summary for each student
   ├─> Lecturer views full details (including names)
   └─> Students see only anonymous summary

4. Lecturer uses peer review data
   ├─> Factor into individual evaluation
   ├─> Identify team conflicts
   ├─> Adjust contribution scores
   └─> Provide targeted feedback
```

---

### Flow 5: Real-time Chat with WebSocket

```
1. User opens chat window
   ├─> Frontend connects to Socket.IO server
   ├─> Authenticate via JWT token
   ├─> Join group room: socket.join(`group_${group_id}`)
   └─> Load recent messages (REST API)

2. User sends message
   ├─> POST /api/v1/chat/groups/{group_id}/messages
   ├─> Save message to database
   ├─> Emit WebSocket event to group room:
   │   socket.to(`group_${group_id}`).emit('new_message', message_data)
   └─> Return saved message

3. Other users receive message
   ├─> WebSocket client receives 'new_message' event
   ├─> Update chat UI in real-time
   └─> Play notification sound (if enabled)

4. User disconnects
   ├─> socket.disconnect()
   ├─> Leave group room
   └─> Update online status
```

---

## 4.3.4. SECURITY DESIGN

### Authentication Flow

```
┌─────────┐                 ┌─────────┐                ┌──────────┐
│ Client  │                 │ Backend │                │ Database │
└────┬────┘                 └────┬────┘                └────┬─────┘
     │                           │                           │
     │ 1. POST /auth/login       │                           │
     ├───────────────────────────>                           │
     │ {username, password}      │                           │
     │                           │ 2. Query user             │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 3. Return user + hash     │
     │                           <──────────────────────────┤
     │                           │                           │
     │                           │ 4. bcrypt.check(password) │
     │                           │                           │
     │ 5. Return JWT tokens      │                           │
     <───────────────────────────┤                           │
     │ {access_token, ...}       │                           │
     │                           │                           │
     │ 6. Subsequent requests    │                           │
     │ Authorization: Bearer ... │                           │
     ├───────────────────────────>                           │
     │                           │ 7. Verify JWT             │
     │                           │ jwt.decode(token)         │
     │                           │                           │
     │                           │ 8. Check permissions      │
     │                           │ (RBAC)                    │
     │                           │                           │
     │ 9. Return data            │                           │
     <───────────────────────────┤                           │
```

### Role-Based Authorization Matrix

| Endpoint | Admin | Staff | Head | Lecturer | Student |
|----------|-------|-------|------|----------|---------|
| **POST /users** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **GET /users** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **POST /subjects** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **POST /classes** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **GET /classes** | ✅ | ✅ | ✅ | ✅ (own) | ✅ (enrolled) |
| **POST /projects** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **POST /projects/.../approve** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **POST /groups** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **GET /groups/{id}** | ✅ | ❌ | ❌ | ✅ (own) | ✅ (member) |
| **POST /groups/.../tasks** | ✅ | ❌ | ❌ | ✅ | ✅ (member) |
| **POST /evaluations/groups** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **POST /evaluations/peer-review** | ✅ | ❌ | ❌ | ❌ | ✅ (member) |
| **GET /chat/groups/{id}/messages** | ✅ | ❌ | ❌ | ✅ (class) | ✅ (member) |
| **POST /resources** | ✅ | ✅ | ❌ | ✅ | ✅ (member) |
| **POST /ai/chat** | ✅ | ✅ | ✅ | ✅ | ✅ |

### Input Validation

**Pydantic Schemas:**
```python
from pydantic import BaseModel, EmailStr, Field, validator

class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50, regex="^[a-zA-Z0-9_-]+$")
    email: EmailStr  # Validates email format
    password: str = Field(..., min_length=6)
    full_name: str = Field(..., min_length=1, max_length=100)
    
    @validator('password')
    def validate_password_strength(cls, v):
        if not any(c.isupper() for c in v):
            raise ValueError('Password must contain uppercase letter')
        if not any(c.islower() for c in v):
            raise ValueError('Password must contain lowercase letter')
        if not any(c.isdigit() for c in v):
            raise ValueError('Password must contain digit')
        return v
```

### SQL Injection Prevention

**SQLModel ORM (Safe):**
```python
# SAFE - Parameterized query
user = session.exec(
    select(User).where(User.username == username)
).first()

# UNSAFE - String concatenation (NEVER DO THIS)
# query = f"SELECT * FROM users WHERE username = '{username}'"
```

### XSS Prevention

**Frontend:**
- React automatically escapes JSX content
- Use `dangerouslySetInnerHTML` only when necessary
- Sanitize user input with DOMPurify

**Backend:**
- Return plain text in JSON
- No HTML rendering on backend

### CSRF Protection

- Not needed for JWT-based API (stateless)
- CORS configured to allow specific origins only

---

## 4.3.5. CLASS DESIGN

### Backend Class Structure

**Complete class diagrams available in**: [`diagrams/02-CLASS-GUIDE.md`](../../diagrams/02-CLASS-GUIDE.md) (766 lines)

**Key Classes:**

#### 1. User Model (`app/models/user.py`)
```python
class User(SQLModel, table=True):
    __tablename__ = "users"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    username: str = Field(unique=True, index=True, max_length=50)
    email: str = Field(unique=True, index=True, max_length=100)
    hashed_password: str
    full_name: str = Field(max_length=100)
    role: UserRole = Field(default=UserRole.STUDENT)
    avatar_url: Optional[str] = None
    phone: Optional[str] = Field(default=None, max_length=20)
    is_active: bool = Field(default=True)
    last_login: Optional[datetime] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    created_projects: List["Project"] = Relationship(back_populates="creator")
    group_memberships: List["GroupMember"] = Relationship(back_populates="student")
```

#### 2. Project Model (`app/models/project.py`)
```python
class Project(SQLModel, table=True):
    __tablename__ = "projects"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    title: str = Field(max_length=200)
    description: str
    objectives: Optional[str] = None
    scope: Optional[str] = None
    expected_outcomes: Optional[str] = None
    created_by: int = Field(foreign_key="users.id")
    status: ProjectStatus = Field(default=ProjectStatus.PENDING)
    approval_status: Optional[ApprovalStatus] = None
    approved_by: Optional[int] = Field(default=None, foreign_key="users.id")
    rejection_reason: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    creator: Optional[User] = Relationship(back_populates="created_projects")
    milestones: List["ProjectMilestone"] = Relationship(back_populates="project")
    class_projects: List["ClassProject"] = Relationship(back_populates="project")
```

#### 3. Group Model (`app/models/group.py`)
```python
class Group(SQLModel, table=True):
    __tablename__ = "groups"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(max_length=100)
    class_id: int = Field(foreign_key="classes.id")
    project_id: Optional[int] = Field(default=None, foreign_key="projects.id")
    leader_id: int = Field(foreign_key="users.id")
    description: Optional[str] = None
    status: GroupStatus = Field(default=GroupStatus.ACTIVE)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    # Relationships
    class_obj: Optional["Class"] = Relationship(back_populates="groups")
    project: Optional["Project"] = Relationship()
    leader: Optional[User] = Relationship()
    members: List["GroupMember"] = Relationship(back_populates="group")
    chat_messages: List["ChatMessage"] = Relationship(back_populates="group")
```

### Frontend Component Structure

**Main Components:**

#### 1. Authentication Components (`src/components/Auth/`)
```javascript
// LoginForm.jsx
export const LoginForm = () => {
  const [credentials, setCredentials] = useState({ username: '', password: '' });
  const { login } = useAuth();
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    await login(credentials);
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <TextField label="Username" value={credentials.username} />
      <TextField type="password" label="Password" value={credentials.password} />
      <Button type="submit">Login</Button>
    </form>
  );
};
```

#### 2. Project Components (`src/components/Project/`)
```javascript
// ProjectCard.jsx
export const ProjectCard = ({ project }) => {
  const statusColor = {
    PENDING: 'warning',
    APPROVED: 'success',
    REJECTED: 'error'
  };
  
  return (
    <Card>
      <CardContent>
        <Typography variant="h6">{project.title}</Typography>
        <Chip label={project.status} color={statusColor[project.status]} />
        <Typography>{project.description}</Typography>
      </CardContent>
      <CardActions>
        <Button onClick={() => navigate(`/projects/${project.id}`)}>View Details</Button>
      </CardActions>
    </Card>
  );
};
```

#### 3. Group Workspace Components (`src/components/Group/`)
```javascript
// GroupWorkspace.jsx
export const GroupWorkspace = ({ groupId }) => {
  const [activeTab, setActiveTab] = useState('tasks');
  
  return (
    <Container>
      <Tabs value={activeTab} onChange={(e, v) => setActiveTab(v)}>
        <Tab label="Tasks" value="tasks" />
        <Tab label="Chat" value="chat" />
        <Tab label="Resources" value="resources" />
        <Tab label="Meetings" value="meetings" />
      </Tabs>
      
      {activeTab === 'tasks' && <KanbanBoard groupId={groupId} />}
      {activeTab === 'chat' && <ChatWindow groupId={groupId} />}
      {activeTab === 'resources' && <ResourceList groupId={groupId} />}
      {activeTab === 'meetings' && <MeetingList groupId={groupId} />}
    </Container>
  );
};
```

---

## 4.3.6. SEQUENCE DIAGRAMS

**Complete sequence diagrams available in**: [`diagrams/03-SEQUENCE-GUIDE.md`](../../diagrams/03-SEQUENCE-GUIDE.md)

### Key Interaction Flows

#### 1. User Authentication Sequence
```
Student                 Frontend              Backend               Database
  |                        |                      |                     |
  |--1. Enter credentials->|                      |                     |
  |                        |--2. POST /auth/login-|                     |
  |                        |                      |--3. Query user----->|
  |                        |                      |<-4. Return user-----|
  |                        |                      |--5. Verify password-|
  |                        |                      |--6. Generate JWT----|
  |                        |<-7. Return tokens----|                     |
  |<-8. Redirect to home---|                      |                     |
  |                        |--9. Store in localStorage                   |
```

#### 2. Project Approval Workflow
```
Lecturer    Frontend     Backend    Database    Notification    Head
  |            |            |           |             |           |
  |--Create--->|            |           |             |           |
  |            |--POST----->|           |             |           |
  |            |            |--Save---->|             |           |
  |            |<--201------|           |             |           |
  |<--Show-----|            |           |             |           |
  |            |            |           |             |           |
  |--Submit--->|            |           |             |           |
  |            |--PATCH---->|           |             |           |
  |            |            |--Update-->|             |           |
  |            |            |--Notify---------------->|--Notify-->|
  |            |<--200------|           |             |           |
  |<--Show-----|            |           |             |           |
  |            |            |           |             |           |
  |            |            |           |             |<--Review--|
  |            |            |<--PATCH---|             |           |
  |            |            |--Update-->|             |           |
  |<--Notify---|<--Emit WS--|--Notify-->|------------>|           |
```

#### 3. Real-time Chat Sequence
```
User A       Frontend A    Socket.IO    Backend    Database    Frontend B    User B
  |              |             |           |           |            |           |
  |--Type msg--->|             |           |           |            |           |
  |              |--emit------>|           |           |            |           |
  |              |             |--save---->|           |            |           |
  |              |             |           |--INSERT-->|            |           |
  |              |<--ack-------|           |           |            |           |
  |              |             |--broadcast---------->|----------->|--Show---->|
  |              |             |           |           |            |           |
```

#### 4. Peer Review Submission
```
Student      Frontend      Backend       Database      Lecturer
  |             |              |              |             |
  |--Fill form->|              |              |             |
  |             |--POST------->|              |             |
  |             |              |--Validate--->|             |
  |             |              |  (same group)|             |
  |             |              |--Insert----->|             |
  |             |              |  (anonymous) |             |
  |             |<--201--------|              |             |
  |<--Confirm---|              |              |             |
  |             |              |--Aggregate-->|             |
  |             |              |--Notify--------------------->|
```

#### 5. AI Milestone Generation
```
Lecturer     Frontend      Backend      AWS Bedrock     Database
  |             |              |              |             |
  |--Request--->|              |              |             |
  |  (project) |--POST-------->|              |             |
  |             |              |--Prepare---->|             |
  |             |              |  prompt      |             |
  |             |              |<--Stream-----|             |
  |             |              |  response    |             |
  |             |<--SSE--------|              |             |
  |  (preview)  |              |              |             |
  |             |              |              |             |
  |--Approve--->|              |              |             |
  |             |--POST-------->|              |             |
  |             |              |--Batch------->|             |
  |             |              |  insert       |             |
  |             |<--201--------|              |             |
  |<--Show------|              |              |             |
```

---

## 4.3.7. COMPONENT INTERACTION DESIGN

### Frontend State Management

**Context Providers:**
```javascript
// AuthContext.jsx
export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const token = localStorage.getItem('access_token');
    if (token) {
      authService.getMe().then(setUser).finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);
  
  const login = async (credentials) => {
    const response = await authService.login(credentials);
    localStorage.setItem('access_token', response.access_token);
    localStorage.setItem('refresh_token', response.refresh_token);
    setUser(response.user);
  };
  
  const logout = () => {
    localStorage.clear();
    setUser(null);
  };
  
  return (
    <AuthContext.Provider value={{ user, loading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};
```

### Service Layer (API Calls)

```javascript
// services/authService.js
import axios from 'axios';
import { API_BASE_URL } from '../config';

const api = axios.create({
  baseURL: API_BASE_URL,
});

// Request interceptor - Add JWT token
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Response interceptor - Handle token refresh
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const refreshToken = localStorage.getItem('refresh_token');
      if (refreshToken) {
        try {
          const response = await axios.post(`${API_BASE_URL}/auth/refresh`, {
            refresh_token: refreshToken
          });
          localStorage.setItem('access_token', response.data.access_token);
          error.config.headers.Authorization = `Bearer ${response.data.access_token}`;
          return api(error.config);
        } catch (refreshError) {
          localStorage.clear();
          window.location.href = '/login';
        }
      }
    }
    return Promise.reject(error);
  }
);

export const authService = {
  login: (credentials) => api.post('/auth/login', credentials).then(r => r.data),
  register: (data) => api.post('/auth/register', data).then(r => r.data),
  getMe: () => api.get('/auth/me').then(r => r.data),
  changePassword: (data) => api.put('/auth/change-password', data).then(r => r.data),
};
```

---

## 4.3.8. ERROR HANDLING STRATEGY

### Backend Exception Handling

```python
# app/utils/exceptions.py
from fastapi import HTTPException, status

class CollabSphereException(HTTPException):
    """Base exception for CollabSphere"""
    pass

class UnauthorizedException(CollabSphereException):
    def __init__(self, detail: str = "Unauthorized"):
        super().__init__(status_code=status.HTTP_401_UNAUTHORIZED, detail=detail)

class ForbiddenException(CollabSphereException):
    def __init__(self, detail: str = "Forbidden"):
        super().__init__(status_code=status.HTTP_403_FORBIDDEN, detail=detail)

class NotFoundException(CollabSphereException):
    def __init__(self, resource: str, id: int):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"{resource} with id {id} not found"
        )

class ValidationException(CollabSphereException):
    def __init__(self, detail: str):
        super().__init__(status_code=status.HTTP_400_BAD_REQUEST, detail=detail)

# Usage in routers
from app.utils.exceptions import NotFoundException, ForbiddenException

@router.get("/projects/{project_id}")
def get_project(project_id: int, current_user: User = Depends(get_current_user)):
    project = session.get(Project, project_id)
    if not project:
        raise NotFoundException("Project", project_id)
    
    if not can_view_project(current_user, project):
        raise ForbiddenException("You don't have permission to view this project")
    
    return project
```

### Frontend Error Handling

```javascript
// utils/errorHandler.js
export const handleApiError = (error) => {
  if (error.response) {
    // Server responded with error status
    const status = error.response.status;
    const message = error.response.data?.detail || 'An error occurred';
    
    switch (status) {
      case 400:
        toast.error(`Validation Error: ${message}`);
        break;
      case 401:
        toast.error('Session expired. Please login again.');
        localStorage.clear();
        window.location.href = '/login';
        break;
      case 403:
        toast.error('You do not have permission to perform this action.');
        break;
      case 404:
        toast.error('Resource not found.');
        break;
      case 500:
        toast.error('Server error. Please try again later.');
        break;
      default:
        toast.error(message);
    }
  } else if (error.request) {
    // Request made but no response
    toast.error('Network error. Please check your connection.');
  } else {
    // Something else happened
    toast.error('An unexpected error occurred.');
  }
};

// Usage in components
try {
  await projectService.createProject(data);
  toast.success('Project created successfully!');
} catch (error) {
  handleApiError(error);
}
```

---

## 4.3.9. PERFORMANCE OPTIMIZATION

### Backend Optimization

**1. Database Query Optimization**
```python
# BAD - N+1 query problem
groups = session.exec(select(Group)).all()
for group in groups:
    print(group.leader.full_name)  # Triggers separate query for each group

# GOOD - Eager loading with joinedload
from sqlalchemy.orm import selectinload

groups = session.exec(
    select(Group)
    .options(selectinload(Group.leader))
    .options(selectinload(Group.members))
).all()
```

**2. Caching Strategy**
```python
from functools import lru_cache
from fastapi_cache import FastAPICache
from fastapi_cache.decorator import cache

@router.get("/subjects")
@cache(expire=3600)  # Cache for 1 hour
async def get_subjects():
    return session.exec(select(Subject)).all()
```

**3. Pagination**
```python
@router.get("/users")
def list_users(skip: int = 0, limit: int = 20):
    if limit > 100:
        limit = 100  # Max limit
    
    total = session.exec(select(func.count(User.id))).one()
    users = session.exec(select(User).offset(skip).limit(limit)).all()
    
    return {"total": total, "items": users, "skip": skip, "limit": limit}
```

### Frontend Optimization

**1. Code Splitting**
```javascript
// Lazy load routes
import { lazy, Suspense } from 'react';

const ProjectPage = lazy(() => import('./pages/ProjectPage'));
const GroupWorkspace = lazy(() => import('./pages/GroupWorkspace'));

function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/projects/:id" element={<ProjectPage />} />
        <Route path="/groups/:id" element={<GroupWorkspace />} />
      </Routes>
    </Suspense>
  );
}
```

**2. React Query for Data Fetching**
```javascript
import { useQuery, useMutation, useQueryClient } from 'react-query';

export const useProjects = () => {
  return useQuery('projects', () => projectService.getProjects(), {
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
  });
};

export const useCreateProject = () => {
  const queryClient = useQueryClient();
  
  return useMutation(
    (data) => projectService.createProject(data),
    {
      onSuccess: () => {
        queryClient.invalidateQueries('projects');
        toast.success('Project created!');
      },
    }
  );
};
```

**3. Virtualization for Large Lists**
```javascript
import { FixedSizeList } from 'react-window';

export const ProjectList = ({ projects }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      <ProjectCard project={projects[index]} />
    </div>
  );
  
  return (
    <FixedSizeList
      height={600}
      itemCount={projects.length}
      itemSize={120}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
};
```

---

## 4.3.10. TESTING CONSIDERATIONS

### Backend Unit Tests
```python
# tests/test_auth.py
import pytest
from fastapi.testclient import TestClient

def test_register_success(client: TestClient):
    response = client.post("/api/v1/auth/register", json={
        "username": "testuser",
        "email": "test@student.fpt.edu.vn",
        "password": "Test123!",
        "full_name": "Test User"
    })
    assert response.status_code == 201
    assert "access_token" in response.json()

def test_register_duplicate_email(client: TestClient, test_user):
    response = client.post("/api/v1/auth/register", json={
        "username": "newuser",
        "email": test_user.email,  # Duplicate email
        "password": "Test123!",
        "full_name": "New User"
    })
    assert response.status_code == 400
    assert "already exists" in response.json()["detail"]
```

### Frontend Component Tests
```javascript
// ProjectCard.test.jsx
import { render, screen, fireEvent } from '@testing-library/react';
import { ProjectCard } from './ProjectCard';

describe('ProjectCard', () => {
  const mockProject = {
    id: 1,
    title: 'Test Project',
    status: 'APPROVED',
    description: 'Test description'
  };
  
  it('renders project title', () => {
    render(<ProjectCard project={mockProject} />);
    expect(screen.getByText('Test Project')).toBeInTheDocument();
  });
  
  it('shows correct status chip color', () => {
    render(<ProjectCard project={mockProject} />);
    const chip = screen.getByText('APPROVED');
    expect(chip).toHaveClass('MuiChip-colorSuccess');
  });
});
```

---

## 4.3.11. DEPLOYMENT CONFIGURATION

### Docker Compose (Development)
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/collabsphere_db
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    depends_on:
      - db
    volumes:
      - ./backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --reload

  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=collabsphere_db
      - POSTGRES_USER=collabsphere
      - POSTGRES_PASSWORD=secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### Environment Variables
```bash
# .env.production
DATABASE_URL=postgresql://user:pass@prod-db:5432/collabsphere
JWT_SECRET_KEY=super-secret-key-min-32-characters
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

AWS_REGION=ap-southeast-1
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...

CLOUDINARY_CLOUD_NAME=collabsphere
CLOUDINARY_API_KEY=...
CLOUDINARY_API_SECRET=...

CORS_ORIGINS=https://collabsphere.com,https://www.collabsphere.com
```

---

## 4.3.12. REFERENCES

### Documentation Links
- **System Architecture**: [04-ARCHITECTURE-GUIDE.md](../../diagrams/04-ARCHITECTURE-GUIDE.md)
- **Class Diagrams**: [02-CLASS-GUIDE.md](../../diagrams/02-CLASS-GUIDE.md)
- **Sequence Diagrams**: [03-SEQUENCE-GUIDE.md](../../diagrams/03-SEQUENCE-GUIDE.md)
- **Use Cases**: [01-USE-CASE-GUIDE.md](../../diagrams/01-USE-CASE-GUIDE.md)
- **ERD Database**: [ERD_DATABASE_DESIGN_COLLABSPHERE.md](../../ERD_DATABASE_DESIGN_COLLABSPHERE.md)

### Technology Documentation
- **FastAPI**: https://fastapi.tiangolo.com/
- **SQLModel**: https://sqlmodel.tiangolo.com/
- **React**: https://react.dev/
- **Material-UI**: https://mui.com/
- **PostgreSQL**: https://www.postgresql.org/docs/
- **Docker**: https://docs.docker.com/

### API Standards
- **REST API Design**: https://restfulapi.net/
- **HTTP Status Codes**: https://httpstatuses.com/
- **JWT**: https://jwt.io/introduction
- **OpenAPI**: https://swagger.io/specification/

---

**[← Back to 4.2 Database Design](4.2-DatabaseDesign.md)** | **[↑ Back to 04-SDD.md](../04-SDD.md)** | **[Next: Section V - Testing →](../05-Testing.md)**
