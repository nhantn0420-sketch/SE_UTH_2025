# 4.1. SYSTEM DESIGN (Thiết kế Hệ thống)

**Thiết kế Kiến trúc Tổng thể - CollabSphere**

---

## 4.1.1. SYSTEM ARCHITECTURE OVERVIEW

### Sơ đồ Kiến trúc Hệ thống

![Figure 4.1: System Architecture Diagram](diagrams/4.1-system-architecture.png)

*Figure 4.1: **CollabSphere System Architecture** - Kiến trúc 3-tier bao gồm Client Layer (React SPA, Web Browser, Mobile App), Web Server Layer (Nginx Reverse Proxy với SSL/TLS), Application Layer (FastAPI Core, Socket.IO, WebRTC, Background Tasks), Data Layer (PostgreSQL 15 với 37 tables và Redis Cache), kết nối với External Services (AWS Bedrock AI, Cloudinary CDN, SMTP Email). Diagram minh họa data flow từ client qua HTTPS (Port 443) → Nginx → Application services → Database, với real-time bidirectional communication qua WebSocket và WebRTC P2P cho video calls. Hệ thống deploy bằng Docker Compose (3 containers), sử dụng JWT authentication, RBAC (5 roles), và bcrypt password hashing.*

**Các thành phần chính:**

| **Layer** | **Components** | **Technologies** | **Port** |
|-----------|----------------|------------------|----------|
| **Client** | Web Browser, React SPA, Mobile App (Future) | React 18.2+, Material-UI, TailwindCSS, Socket.IO Client | 3000 |
| **Web Server** | Nginx Reverse Proxy, Load Balancer, SSL/TLS | Nginx, Let's Encrypt SSL | 443 |
| **Application** | FastAPI Core (60+ endpoints), Socket.IO (Real-time), WebRTC (Video), Background Tasks | Python 3.11+, FastAPI 0.104+, SQLModel, Socket.IO, Celery | 8000 |
| **Data** | PostgreSQL 15 (37 tables, 6 modules), Redis Cache | PostgreSQL 15, Redis 7+ | 5432 |
| **External** | AWS Bedrock (AI), Cloudinary (CDN), SMTP (Email) | AWS SDK, Cloudinary SDK, Gmail/SendGrid | N/A |

**Data Flow:**
1. **Request Flow**: Client (HTTPS) → Nginx (Reverse Proxy) → FastAPI (REST API) → PostgreSQL/Redis → Response
2. **Real-time Flow**: Client (WebSocket) ↔ Socket.IO ↔ PostgreSQL (bidirectional events)
3. **P2P Flow**: Client (WebRTC) ↔ WebRTC Signaling Server ↔ STUN/TURN ↔ Client (direct peer-to-peer)
4. **Background Flow**: Background Tasks → SMTP (Async email queue) / AWS Bedrock (AI requests) / Cloudinary (File processing)

**Security Layers:**
- **Transport**: HTTPS/SSL (Let's Encrypt), TLS 1.2+
- **Authentication**: JWT tokens (Access + Refresh), bcrypt password hashing
- **Authorization**: RBAC with 5 roles (Admin, Head, Staff, Lecturer, Student)
- **Protection**: CORS policy, Rate limiting, Input validation (Pydantic)

---

### Tổng quan Kiến trúc

CollabSphere được thiết kế theo mô hình **3-Tier Architecture** (Kiến trúc 3 tầng), phân tách rõ ràng giữa Presentation Layer, Application Layer, và Data Layer. Kiến trúc này mang lại:

- ✅ **Separation of Concerns**: Mỗi layer có trách nhiệm riêng biệt
- ✅ **Scalability**: Dễ dàng scale từng layer độc lập
- ✅ **Maintainability**: Code dễ bảo trì và mở rộng
- ✅ **Security**: Bảo mật theo từng tầng
- ✅ **Flexibility**: Thay đổi technology stack dễ dàng

### Sơ đồ Kiến trúc Tổng thể

```
┌─────────────────────────────────────────────────────────────────────┐
│                         USERS / CLIENTS                              │
│                                                                       │
│   [Admin] [Staff] [Head] [Lecturer] [Student]                       │
│                                                                       │
│   Devices: Desktop, Laptop, Tablet (768px+)                         │
│   Browsers: Chrome 90+, Firefox 88+, Edge 90+, Safari 14+          │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │ HTTPS (TLS 1.2+)
                                │ Port 443
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  TIER 1: PRESENTATION LAYER                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                React Single Page Application                  │  │
│  │                                                               │  │
│  │  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐   │  │
│  │  │   Auth     │  │   Admin    │  │    Collaboration    │   │  │
│  │  │   Pages    │  │   Pages    │  │       Tools         │   │  │
│  │  │            │  │            │  │                     │   │  │
│  │  │ - Login    │  │ - Users    │  │ - Chat              │   │  │
│  │  │ - Register │  │ - Reports  │  │ - Video Call        │   │  │
│  │  │ - Profile  │  │ - Analytics│  │ - Whiteboard        │   │  │
│  │  └────────────┘  └────────────┘  └─────────────────────┘   │  │
│  │                                                               │  │
│  │  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐   │  │
│  │  │   Staff    │  │  Lecturer  │  │      Student        │   │  │
│  │  │   Pages    │  │   Pages    │  │       Pages         │   │  │
│  │  │            │  │            │  │                     │   │  │
│  │  │ - Import   │  │ - Projects │  │ - Classes           │   │  │
│  │  │ - Subjects │  │ - Groups   │  │ - Tasks             │   │  │
│  │  │ - Classes  │  │ - Evaluate │  │ - Submissions       │   │  │
│  │  └────────────┘  └────────────┘  └─────────────────────┘   │  │
│  │                                                               │  │
│  │  Tech Stack:                                                 │  │
│  │  - React 18.2+, TypeScript                                   │  │
│  │  - Material-UI (MUI), Tailwind CSS                           │  │
│  │  - React Router v6                                           │  │
│  │  - Axios (HTTP), Socket.IO Client                            │  │
│  │  - Context API (State Management)                            │  │
│  │                                                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                       │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │ REST API (JSON)
                                │ WebSocket
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      NGINX REVERSE PROXY                             │
│                                                                       │
│  Functions:                                                          │
│  - Load Balancing                                                    │
│  - SSL/TLS Termination                                               │
│  - Static File Serving                                               │
│  - Request Routing                                                   │
│  - Rate Limiting                                                     │
│                                                                       │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                    ▼                       ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 TIER 2: APPLICATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              FastAPI Backend Application                    │    │
│  │                                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐ │    │
│  │  │                  API ROUTERS (12 modules)             │ │    │
│  │  │                                                        │ │    │
│  │  │  /auth          - Authentication & Authorization      │ │    │
│  │  │  /users         - User management                     │ │    │
│  │  │  /subjects      - Subject & Curriculum                │ │    │
│  │  │  /classes       - Class management                    │ │    │
│  │  │  /projects      - Project management                  │ │    │
│  │  │  /groups        - Group & Workspace                   │ │    │
│  │  │  /evaluations   - Evaluation & Feedback               │ │    │
│  │  │  /resources     - File & Resource management          │ │    │
│  │  │  /notifications - Notification system                 │ │    │
│  │  │  /chat          - Chat messaging                      │ │    │
│  │  │  /meetings      - Meeting management                  │ │    │
│  │  │  /ai            - AI Assistant                        │ │    │
│  │  │                                                        │ │    │
│  │  └──────────────────────────────────────────────────────┘ │    │
│  │                                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐ │    │
│  │  │                    MIDDLEWARE                         │ │    │
│  │  │                                                        │ │    │
│  │  │  - CORS Handler                                       │ │    │
│  │  │  - JWT Authentication Validator                       │ │    │
│  │  │  - Request/Response Validation (Pydantic)             │ │    │
│  │  │  - Error Handler & Exception Middleware               │ │    │
│  │  │  - Logging Middleware                                 │ │    │
│  │  │                                                        │ │    │
│  │  └──────────────────────────────────────────────────────┘ │    │
│  │                                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐ │    │
│  │  │                    SERVICES                           │ │    │
│  │  │                                                        │ │    │
│  │  │  - AI Service (AWS Bedrock integration)              │ │    │
│  │  │  - Notification Service (Email SMTP)                 │ │    │
│  │  │  - Socket Service (Real-time sync)                   │ │    │
│  │  │  - Email Service (Welcome, Notifications)            │ │    │
│  │  │  - File Service (Cloudinary upload)                  │ │    │
│  │  │                                                        │ │    │
│  │  └──────────────────────────────────────────────────────┘ │    │
│  │                                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐ │    │
│  │  │                 MODELS (SQLModel/ORM)                 │ │    │
│  │  │                                                        │ │    │
│  │  │  User, Subject, Curriculum, Class, ClassMember,      │ │    │
│  │  │  Project, ProjectMilestone, ClassProject,            │ │    │
│  │  │  Group, GroupMember, GroupMilestone, Checkpoint,     │ │    │
│  │  │  Task, Meeting, ChatMessage, Resource,               │ │    │
│  │  │  Evaluation, PeerReview, Notification                │ │    │
│  │  │                                                        │ │    │
│  │  └──────────────────────────────────────────────────────┘ │    │
│  │                                                             │    │
│  │  Tech Stack:                                               │    │
│  │  - Python 3.11+, FastAPI 0.104+                            │    │
│  │  - SQLModel (ORM), Pydantic (Validation)                   │    │
│  │  - JWT (python-jose), bcrypt                               │    │
│  │  - Alembic (Migrations)                                    │    │
│  │                                                             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              Socket.IO Server (Real-time)                   │    │
│  │                                                             │    │
│  │  Handles:                                                   │    │
│  │  - Chat messaging (WebSocket)                               │    │
│  │  - Real-time notifications                                  │    │
│  │  - Collaboration sync (Whiteboard, Editor)                  │    │
│  │  - Presence detection (Online/Offline)                      │    │
│  │                                                             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                       │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │ SQL Queries (SQLModel)
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   TIER 3: DATA LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │              PostgreSQL 15 (Primary Database)               │    │
│  │                                                             │    │
│  │  Database: collabsphere_db                                  │    │
│  │                                                             │    │
│  │  Schemas (28 tables):                                       │    │
│  │                                                             │    │
│  │  1. Users & Authentication (1 table)                        │    │
│  │     - users                                                 │    │
│  │                                                             │    │
│  │  2. Academic Management (4 tables)                          │    │
│  │     - subjects                                              │    │
│  │     - curricula                                             │    │
│  │     - classes                                               │    │
│  │     - class_members                                         │    │
│  │                                                             │    │
│  │  3. Project & Group (9 tables)                              │    │
│  │     - projects, project_milestones, class_projects         │    │
│  │     - groups, group_members, group_milestones              │    │
│  │     - checkpoints, tasks, milestone_questions              │    │
│  │                                                             │    │
│  │  4. Collaboration (5 tables)                                │    │
│  │     - meetings, chat_messages, resources,                  │    │
│  │     - whiteboard_sessions, document_sessions               │    │
│  │                                                             │    │
│  │  5. Evaluation (5 tables)                                   │    │
│  │     - group_evaluations, member_evaluations,               │    │
│  │     - peer_reviews, checkpoint_evaluations,                │    │
│  │     - milestone_answers                                    │    │
│  │                                                             │    │
│  │  6. Notification (1 table)                                  │    │
│  │     - notifications                                         │    │
│  │                                                             │    │
│  │  7. Others (3 tables)                                       │    │
│  │     - project_tags, group_tags, resource_categories        │    │
│  │                                                             │    │
│  │  Features:                                                  │    │
│  │  - Indexes on all foreign keys                              │    │
│  │  - Composite indexes for common queries                     │    │
│  │  - Check constraints for business rules                     │    │
│  │  - Triggers for automatic timestamps                        │    │
│  │                                                             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                       EXTERNAL SERVICES                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ AWS Bedrock  │  │ Cloudinary   │  │ SMTP Server  │             │
│  │ (AI Service) │  │ (Storage)    │  │ (Email)      │             │
│  │              │  │              │  │              │             │
│  │ - Claude AI  │  │ - Images     │  │ - Welcome    │             │
│  │ - Chatbot    │  │ - Documents  │  │   emails     │             │
│  │ - Milestone  │  │ - Videos     │  │ - Notif      │             │
│  │   generation │  │ - Resources  │  │   emails     │             │
│  │              │  │              │  │              │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 4.1.2. TECHNOLOGY STACK

### Frontend Technology Stack

| Category | Technology | Version | Purpose |
|----------|-----------|---------|---------|
| **Core Framework** | React | 18.2+ | UI framework for building SPA |
| **Language** | JavaScript/TypeScript | ES6+ | Programming language |
| **UI Library** | Material-UI (MUI) | 5.14+ | Pre-built React components |
| **Styling** | Tailwind CSS | 3.3+ | Utility-first CSS framework |
| **Routing** | React Router | 6.16+ | Client-side routing |
| **HTTP Client** | Axios | 1.5+ | Making API requests |
| **State Management** | React Context API | Built-in | Global state management |
| **Real-time** | Socket.IO Client | 4.5+ | WebSocket communication |
| **Video Calls** | PeerJS / SimplePeer | Latest | WebRTC wrapper |
| **Form Handling** | React Hook Form | 7.47+ | Form validation |
| **Date/Time** | date-fns | 2.30+ | Date manipulation |
| **Charts** | Recharts | 2.8+ | Data visualization |
| **Notifications** | Notistack | 3.0+ | Snackbar notifications |
| **File Upload** | React Dropzone | 14.2+ | Drag-and-drop file upload |
| **Rich Text Editor** | Quill / Slate | Latest | Collaborative editing |
| **Whiteboard** | Excalidraw / Fabric.js | Latest | Drawing canvas |

### Backend Technology Stack

| Category | Technology | Version | Purpose |
|----------|-----------|---------|---------|
| **Language** | Python | 3.11+ | Programming language |
| **Web Framework** | FastAPI | 0.104+ | Async web framework |
| **ORM** | SQLModel | 0.0.12+ | Database ORM (based on SQLAlchemy) |
| **Validation** | Pydantic | 2.4+ | Data validation |
| **Authentication** | python-jose | 3.3+ | JWT token generation |
| **Password Hashing** | bcrypt | 4.1+ | Secure password hashing |
| **Database Driver** | psycopg2 | 2.9+ | PostgreSQL driver |
| **Migration** | Alembic | 1.12+ | Database schema migrations |
| **WebSocket** | Socket.IO | 3.0+ | Real-time communication |
| **Email** | email-validator | 2.1+ | Email validation |
| **SMTP** | smtplib | Built-in | Sending emails |
| **AI Integration** | boto3 | 1.29+ | AWS SDK for Bedrock |
| **File Upload** | cloudinary | 1.36+ | Cloud storage integration |
| **HTTP Client** | httpx | 0.25+ | Async HTTP client |
| **Environment** | python-dotenv | 1.0+ | Environment variable management |

### Database & Storage

| Category | Technology | Version | Purpose |
|----------|-----------|---------|---------|
| **Primary Database** | PostgreSQL | 15.x | Relational database |
| **Cache (Optional)** | Redis | 7.x | Caching layer |
| **File Storage** | Cloudinary | Cloud | Image & file storage |
| **Backup** | pg_dump | Built-in | Database backup |

### DevOps & Deployment

| Category | Technology | Version | Purpose |
|----------|-----------|---------|---------|
| **Containerization** | Docker | 24.x | Application containerization |
| **Orchestration** | Docker Compose | 2.x | Multi-container management |
| **Reverse Proxy** | Nginx | 1.25+ | Load balancing, SSL termination |
| **CI/CD** | GitHub Actions | - | Automated testing & deployment |
| **Version Control** | Git/GitHub | - | Source code management |

---

## 4.1.3. COMPONENT ARCHITECTURE

### Frontend Component Structure

```
src/
├── components/                  # Reusable UI components
│   ├── Auth/                   # Authentication components
│   │   ├── LoginForm.js
│   │   ├── RegisterForm.js
│   │   └── ProfileCard.js
│   ├── Admin/                  # Admin components
│   │   ├── UserManagement.js
│   │   ├── SystemReports.js
│   │   └── AnalyticsDashboard.js
│   ├── Common/                 # Shared components
│   │   ├── Navbar.js
│   │   ├── Sidebar.js
│   │   ├── Footer.js
│   │   ├── LoadingSpinner.js
│   │   └── ErrorBoundary.js
│   ├── Group/                  # Group/Team components
│   │   ├── GroupCard.js
│   │   ├── MilestoneList.js
│   │   ├── TaskBoard.js
│   │   └── MemberList.js
│   ├── Collaboration/          # Collaboration tools
│   │   ├── ChatPanel.js
│   │   ├── VideoRoom.js
│   │   ├── Whiteboard.js
│   │   └── CollaborativeEditor.js
│   └── Evaluation/             # Evaluation components
│       ├── EvaluationForm.js
│       ├── PeerReviewForm.js
│       └── FeedbackDisplay.js
│
├── pages/                       # Page components (routes)
│   ├── HomePage.js
│   ├── LoginPage.js
│   ├── DashboardPage.js
│   ├── ProjectsPage.js
│   ├── GroupsPage.js
│   └── ...
│
├── services/                    # API service layer
│   ├── api.js                  # Axios instance configuration
│   ├── authService.js          # Authentication APIs
│   ├── userService.js          # User APIs
│   ├── projectService.js       # Project APIs
│   ├── groupService.js         # Group APIs
│   └── ...
│
├── context/                     # React Context for state
│   ├── AuthContext.js          # Authentication state
│   ├── NotificationContext.js  # Notifications state
│   └── SocketContext.js        # WebSocket connection
│
├── hooks/                       # Custom React hooks
│   ├── useAuth.js
│   ├── useSocket.js
│   └── useNotification.js
│
├── utils/                       # Utility functions
│   ├── helpers.js
│   ├── validators.js
│   └── constants.js
│
├── App.js                       # Main app component
└── index.js                     # Entry point
```

### Backend Component Structure

```
app/
├── routers/                     # API route handlers
│   ├── __init__.py
│   ├── auth.py                 # /auth endpoints
│   ├── users.py                # /users endpoints
│   ├── subjects.py             # /subjects endpoints
│   ├── classes.py              # /classes endpoints
│   ├── projects.py             # /projects endpoints
│   ├── groups.py               # /groups endpoints
│   ├── evaluations.py          # /evaluations endpoints
│   ├── resources.py            # /resources endpoints
│   ├── notifications.py        # /notifications endpoints
│   ├── chat.py                 # /chat endpoints
│   ├── meetings.py             # /meetings endpoints
│   └── ai.py                   # /ai endpoints
│
├── models/                      # Database models (SQLModel)
│   ├── __init__.py
│   ├── user.py                 # User model
│   ├── subject.py              # Subject, Curriculum models
│   ├── academic.py             # Class, ClassMember models
│   ├── project.py              # Project, ProjectMilestone models
│   ├── group.py                # Group, GroupMember models
│   ├── communication.py        # ChatMessage, Meeting models
│   ├── resource.py             # Resource model
│   ├── evaluation.py           # Evaluation models
│   └── notification.py         # Notification model
│
├── schemas/                     # Pydantic schemas (request/response)
│   ├── __init__.py
│   ├── auth.py                 # Login, Register schemas
│   ├── common.py               # Common response schemas
│   └── ...
│
├── services/                    # Business logic layer
│   ├── __init__.py
│   ├── ai_service.py           # AI integration (AWS Bedrock)
│   ├── notification_service.py # Email & notifications
│   ├── socket_service.py       # WebSocket handlers
│   └── ...
│
├── utils/                       # Utility functions
│   ├── __init__.py
│   ├── dependencies.py         # Dependency injection
│   └── security.py             # JWT, password hashing
│
├── config.py                    # Configuration settings
├── database.py                  # Database connection
└── main.py                      # FastAPI app initialization
```

---

## 4.1.4. DEPLOYMENT ARCHITECTURE

### Development Environment (Docker Compose)

```
docker-compose.yml
├── frontend-dev (React Dev Server)
│   - Port: 3000
│   - Hot reload enabled
│   - Volume mount: ./frontend/src
│
├── backend-dev (FastAPI with Uvicorn)
│   - Port: 8000
│   - Auto-reload enabled
│   - Volume mount: ./backend/app
│
└── postgres (PostgreSQL 15)
    - Port: 5432
    - Volume: postgres_data
    - Database: collabsphere_db
```

**Docker Compose Configuration:**

```yaml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    command: npm start

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/app:/app/app
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/collabsphere_db
      - JWT_SECRET_KEY=your-secret-key
    depends_on:
      - postgres
    command: uvicorn app.main:app --host 0.0.0.0 --reload

  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=collabsphere_user
      - POSTGRES_PASSWORD=secure_password
      - POSTGRES_DB=collabsphere_db

volumes:
  postgres_data:
```

### Production Environment

![Figure 4.2: Production Deployment Architecture](diagrams/4.1-production-deployment.png)

*Figure 4.2: **Production Deployment Architecture** - Kiến trúc triển khai production trên Cloud Provider (AWS/Azure/GCP) với Load Balancer/CloudFlare (SSL Termination, DDoS Protection), 2 VM chạy Nginx Reverse Proxy, 2 Backend servers chạy FastAPI, PostgreSQL Master với 2 Read Replicas. Load Balancer phân phối traffic theo round-robin, Nginx proxy requests đến backend servers, backend kết nối PostgreSQL Master cho write operations và Read Replicas cho read operations. Hỗ trợ horizontal scaling và high availability.*

```
┌──────────────────────────────────────────────────────┐
│              Cloud Provider (AWS/Azure/GCP)           │
├──────────────────────────────────────────────────────┤
│                                                        │
│  ┌─────────────────────────────────────────────┐    │
│  │         Load Balancer / CloudFlare           │    │
│  │         - SSL Termination                    │    │
│  │         - DDoS Protection                    │    │
│  └─────────────────┬───────────────────────────┘    │
│                    │                                  │
│         ┌──────────┴──────────┐                     │
│         │                     │                     │
│         ▼                     ▼                     │
│  ┌─────────────┐      ┌─────────────┐             │
│  │   VM 1      │      │   VM 2      │             │
│  │   (Nginx)   │      │   (Nginx)   │             │
│  └──────┬──────┘      └──────┬──────┘             │
│         │                     │                     │
│         └──────────┬──────────┘                     │
│                    │                                 │
│         ┌──────────▼──────────┐                     │
│         │                     │                     │
│         ▼                     ▼                     │
│  ┌─────────────┐      ┌─────────────┐             │
│  │  Backend 1  │      │  Backend 2  │             │
│  │  (FastAPI)  │      │  (FastAPI)  │             │
│  └──────┬──────┘      └──────┬──────┘             │
│         │                     │                     │
│         └──────────┬──────────┘                     │
│                    │                                 │
│                    ▼                                 │
│         ┌─────────────────────┐                     │
│         │  PostgreSQL Master  │                     │
│         │  + Read Replicas    │                     │
│         └─────────────────────┘                     │
│                                                        │
└──────────────────────────────────────────────────────┘
```

---

## 4.1.5. COMMUNICATION PROTOCOLS

### 1. **HTTP/HTTPS REST API**

**Protocol**: HTTP/1.1, HTTPS (TLS 1.2+)  
**Port**: 80 (HTTP), 443 (HTTPS)  
**Usage**: Tất cả CRUD operations

**Request Flow**:
```
Client → HTTPS Request → Nginx → FastAPI → PostgreSQL
                                    ↓
Client ← HTTPS Response ← Nginx ← FastAPI ← PostgreSQL
```

**API Standards**:
- RESTful conventions
- JSON format for request/response
- JWT Bearer authentication
- HTTP status codes chuẩn

### 2. **WebSocket (Socket.IO)**

**Protocol**: WebSocket (wss://)  
**Port**: 443 (via Nginx proxy)  
**Usage**: Real-time features

**Features**:
- **Chat messaging**: Tin nhắn real-time
- **Notifications**: Thông báo instant
- **Presence detection**: Online/Offline status
- **Collaboration sync**: Whiteboard, collaborative editor

**Connection Flow**:
```
Client WebSocket ↔ Nginx (Proxy Pass) ↔ Socket.IO Server
```

### 3. **WebRTC**

**Protocol**: WebRTC (STUN/TURN)  
**Usage**: Video conferencing

**Components**:
- **Signaling**: Sử dụng Socket.IO
- **STUN Server**: ICE candidate discovery
- **TURN Server**: Relay khi P2P fail
- **Media Streams**: Camera, microphone, screen share

**Connection Flow**:
```
Client A ↔ Signaling Server (Socket.IO) ↔ Client B
    ↓                                          ↓
    └──────── P2P Media Stream ───────────────┘
```

---

## 4.1.6. SECURITY ARCHITECTURE

### Authentication Flow

![Figure 4.3: Authentication Flow Sequence](diagrams/4.3.7-seq-authentication.png)

*Figure 4.3: **Authentication Flow Sequence Diagram** - Mô tả quy trình xác thực người dùng từ User gửi POST /auth/login với username và password, FastAPI query database để lấy user và hash password, verify password bằng bcrypt.check(), trả về JWT token và user info. Các request tiếp theo gửi kèm Authorization: Bearer token, FastAPI decode và validate JWT, check permissions theo RBAC, sau đó trả về protected data.*

```
┌─────────┐                 ┌─────────┐                ┌──────────┐
│  User   │                 │ FastAPI │                │ Database │
└────┬────┘                 └────┬────┘                └─────┬────┘
     │                           │                           │
     │ 1. POST /auth/login       │                           │
     │   {username, password}    │                           │
     ├───────────────────────────>                           │
     │                           │                           │
     │                           │ 2. Query user by username │
     │                           ├───────────────────────────>
     │                           │                           │
     │                           │ 3. Return user + hash     │
     │                           <───────────────────────────┤
     │                           │                           │
     │                           │ 4. Verify password        │
     │                           │    bcrypt.check()         │
     │                           │                           │
     │ 5. Return JWT token       │                           │
     │   + user info             │                           │
     <───────────────────────────┤                           │
     │                           │                           │
     │ 6. Subsequent requests    │                           │
     │    with Authorization:    │                           │
     │    Bearer <token>         │                           │
     ├───────────────────────────>                           │
     │                           │                           │
     │                           │ 7. Decode & validate JWT  │
     │                           │                           │
     │                           │ 8. Check permissions      │
     │                           │    (RBAC)                 │
     │                           │                           │
     │ 9. Return protected data  │                           │
     <───────────────────────────┤                           │
     │                           │                           │
```

### Role-Based Access Control (RBAC)

![Figure 4.4: RBAC Hierarchy Diagram](diagrams/4.1-rbac-hierarchy.png)

*Figure 4.4: **RBAC Hierarchy Diagram** - Phân cấp 5 roles trong hệ thống CollabSphere. Admin (highest privilege) có tất cả permissions bao gồm user management và system configuration. Staff quản lý academic structure (import subjects/classes/users, view reports). Head of Department có quyền approve/reject projects, assign projects to classes, view lecturer activities. Lecturer có quyền create/manage projects và groups, evaluate teams, chat with students. Student (lowest privilege) chỉ có quyền view assigned classes/groups, manage tasks, submit checkpoints, peer review teammates. Authorization flow sử dụng JWT token và role-based middleware.*

```
┌────────────────────────────────────────────────────────────┐
│                    RBAC HIERARCHY                           │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  Admin (Highest Privilege)                                 │
│    ├── All permissions                                     │
│    ├── User management                                     │
│    └── System configuration                                │
│                                                              │
│  Staff                                                      │
│    ├── Import subjects/classes/users                       │
│    ├── Manage academic structure                           │
│    └── View reports                                        │
│                                                              │
│  Head of Department                                         │
│    ├── Approve/reject projects                             │
│    ├── Assign projects to classes                          │
│    ├── View all lecturer activities                        │
│    └── Generate department reports                         │
│                                                              │
│  Lecturer                                                   │
│    ├── Create/manage projects                              │
│    ├── Create/manage groups                                │
│    ├── Evaluate teams & members                            │
│    ├── View assigned classes                               │
│    └── Chat with students                                  │
│                                                              │
│  Student (Lowest Privilege)                                │
│    ├── View assigned classes & groups                      │
│    ├── Manage tasks in workspace                           │
│    ├── Submit checkpoints                                  │
│    ├── Peer review teammates                               │
│    └── Chat with team members                              │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

### Data Protection

1. **Password Security**:
   - Bcrypt hashing (salt rounds: 12)
   - Never store plain-text passwords
   - Password validation on registration

2. **API Security**:
   - JWT tokens with 24-hour expiration
   - HTTPS only in production
   - CORS configuration
   - Rate limiting

3. **Database Security**:
   - Parameterized queries (SQLModel)
   - No SQL injection vulnerabilities
   - Encrypted backups

4. **File Upload Security**:
   - File type validation
   - Size limits (100MB)
   - Virus scanning (optional)
   - Stored in Cloudinary (isolated)

---

## 4.1.7. ERROR HANDLING STRATEGY

### HTTP Status Codes

| Status Code | Meaning | Usage |
|-------------|---------|-------|
| **200 OK** | Success | Successful GET, PUT, DELETE |
| **201 Created** | Resource created | Successful POST |
| **204 No Content** | Success, no body | Successful DELETE |
| **400 Bad Request** | Validation error | Invalid input data |
| **401 Unauthorized** | Auth failed | Missing/invalid token |
| **403 Forbidden** | No permission | User doesn't have access |
| **404 Not Found** | Resource not found | Invalid resource ID |
| **409 Conflict** | Duplicate resource | Email already exists |
| **422 Unprocessable Entity** | Validation error | Pydantic validation failed |
| **500 Internal Server Error** | Server error | Unexpected backend error |

### Error Response Format

```json
{
  "detail": "Error message for user",
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2026-01-04T10:30:00Z",
  "path": "/api/v1/users",
  "method": "POST"
}
```

### Exception Handling Flow

```
Client Request
     ↓
FastAPI Router
     ↓
Try-Catch Block
     ↓
     ├─── Success → Return 2xx
     │
     └─── Exception
           ↓
           ├─── ValidationError → 400/422
           ├─── NotFoundError → 404
           ├─── PermissionError → 403
           └─── UnexpectedError → 500
                ↓
           Log Error
                ↓
           Return Error Response
```

---

## 4.1.8. SCALABILITY CONSIDERATIONS

### Horizontal Scaling

1. **Stateless API Design**:
   - No server-side sessions
   - JWT tokens for auth (client-side)
   - Multiple backend instances possible

2. **Load Balancing**:
   - Nginx load balancer
   - Round-robin distribution
   - Health checks

3. **Database Scaling**:
   - Read replicas for queries
   - Master-slave replication
   - Connection pooling

### Caching Strategy (Future)

```
Request → Cache (Redis) → Database
            ↑ Hit          ↓ Miss
            └──────────────┘
```

**Cacheable Data**:
- User profiles
- Subject/class lists
- Project lists
- Static resources

---

## 4.1.9. MONITORING & LOGGING

### Logging Levels

```python
# Backend logging configuration
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# Log examples:
logger.info("User logged in: user_id=123")
logger.warning("Failed login attempt: username=john")
logger.error("Database connection failed")
```

### Metrics to Monitor

1. **Application Metrics**:
   - API response times
   - Error rates
   - Request counts per endpoint

2. **Infrastructure Metrics**:
   - CPU usage
   - Memory usage
   - Disk I/O

3. **Database Metrics**:
   - Query execution times
   - Connection pool usage
   - Active connections

---

**[← Back to SDD Master](../04-SDD.md)** | **[Next: 4.2 Database Design →](4.2-DatabaseDesign.md)**
