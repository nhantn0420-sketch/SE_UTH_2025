# 4.2. DATABASE DESIGN (Thiáº¿t káº¿ CÆ¡ sá»Ÿ Dá»¯ liá»‡u)

**Thiáº¿t káº¿ CSDL Chi tiáº¿t - CollabSphere**

---

## 4.2.1. DATABASE OVERVIEW

### ThÃ´ng tin CÆ¡ báº£n

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ |
|------------|---------|
| **DBMS** | PostgreSQL 15.x |
| **Database Name** | collabsphere_db |
| **Character Set** | UTF-8 |
| **Collation** | en_US.UTF-8 |
| **Total Tables** | 28 tables |
| **ORM Framework** | SQLModel (Python) |
| **Migration Tool** | Alembic |

### CÃ¡c NhÃ³m Báº£ng (Table Groups)

```
collabsphere_db (28 tables)
â”œâ”€â”€ 1. Users & Authentication (1 table)
â”‚   â””â”€â”€ users
â”‚
â”œâ”€â”€ 2. Academic Management (4 tables)
â”‚   â”œâ”€â”€ subjects
â”‚   â”œâ”€â”€ curricula
â”‚   â”œâ”€â”€ classes
â”‚   â””â”€â”€ class_members
â”‚
â”œâ”€â”€ 3. Project & Group (9 tables)
â”‚   â”œâ”€â”€ projects
â”‚   â”œâ”€â”€ project_milestones
â”‚   â”œâ”€â”€ class_projects
â”‚   â”œâ”€â”€ groups
â”‚   â”œâ”€â”€ group_members
â”‚   â”œâ”€â”€ group_milestones
â”‚   â”œâ”€â”€ checkpoints
â”‚   â”œâ”€â”€ tasks
â”‚   â””â”€â”€ milestone_questions
â”‚
â”œâ”€â”€ 4. Collaboration (7 tables)
â”‚   â”œâ”€â”€ meetings
â”‚   â”œâ”€â”€ meeting_participants
â”‚   â”œâ”€â”€ chat_messages
â”‚   â”œâ”€â”€ resources
â”‚   â”œâ”€â”€ whiteboard_sessions
â”‚   â”œâ”€â”€ document_sessions
â”‚   â””â”€â”€ video_sessions (optional)
â”‚
â”œâ”€â”€ 5. Evaluation (5 tables)
â”‚   â”œâ”€â”€ peer_reviews
â”‚   â”œâ”€â”€ group_evaluations
â”‚   â”œâ”€â”€ member_evaluations
â”‚   â”œâ”€â”€ checkpoint_evaluations
â”‚   â””â”€â”€ milestone_answers
â”‚
â””â”€â”€ 6. Notification (1 table)
    â””â”€â”€ notifications
```

---

## 4.2.2. ERD - CONCEPTUAL MODEL

### SÆ¡ Ä‘á»“ Quan há»‡ Thá»±c thá»ƒ Tá»•ng quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COLLABSPHERE DATABASE                       â”‚
â”‚            Project-Based Learning Management System           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     USERS     â”‚ â”‚ ACADEMIC â”‚ â”‚   PROJECTS   â”‚
    â”‚               â”‚ â”‚          â”‚ â”‚              â”‚
    â”‚ - Admin       â”‚ â”‚ Subject  â”‚ â”‚ Project      â”‚
    â”‚ - Staff       â”‚ â”‚ Class    â”‚ â”‚ Milestone    â”‚
    â”‚ - Head        â”‚ â”‚ Members  â”‚ â”‚              â”‚
    â”‚ - Lecturer    â”‚ â”‚          â”‚ â”‚              â”‚
    â”‚ - Student     â”‚ â”‚          â”‚ â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚             â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      GROUPS & TEAMS        â”‚
            â”‚                            â”‚
            â”‚  Group                     â”‚
            â”‚  Group Members             â”‚
            â”‚  Tasks & Checkpoints       â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  COLLABORATION    â”‚ â”‚  EVALUATION    â”‚
      â”‚                   â”‚ â”‚                â”‚
      â”‚  Chat             â”‚ â”‚  Peer Review   â”‚
      â”‚  Meetings         â”‚ â”‚  Evaluations   â”‚
      â”‚  Resources        â”‚ â”‚  Feedback      â”‚
      â”‚  Whiteboard       â”‚ â”‚                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
          â”‚NOTIFICATION â”‚
          â”‚             â”‚
          â”‚ Email       â”‚
          â”‚ Real-time   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4.2.3. ERD - LOGICAL MODEL

### Entity Relationship Diagram (ERD)

**Complete ERD with 37 tables across 6 zones:**

![Figure 4.2: Entity Relationship Diagram](diagrams/4.2-erd-full.png)

*Figure 4.2: Complete Entity Relationship Diagram showing all 37 database tables organized into 6 functional zones (Users/Academic, Projects/Groups, Collaboration, Evaluation, Notifications, Activity Logs) with primary keys, foreign keys, and relationships.*

**Diagram Legend:**
- ðŸ”‘ **PRIMARY_KEY**: Gold indicator for primary key fields
- ðŸ”— **FOREIGN_KEY**: Blue indicator for foreign key relationships
- âš¡ **UNIQUE**: Green indicator for unique constraints
- **Lines with cardinality**: Show relationships (1:1, 1:N, M:N)
- **Color zones**: Group related tables by functional domain

**Zone Breakdown:**
- **Zone 1 (Blue)**: Users & Academic (7 tables) - users, subjects, curricula, classes, class_members, class_projects
- **Zone 2 (Orange)**: Projects & Groups (15 tables) - projects, milestones, groups, checkpoints, tasks, workspace
- **Zone 3 (Green)**: Collaboration (7 tables) - meetings, chat, resources, whiteboard, documents
- **Zone 4 (Purple)**: Evaluation (6 tables) - peer reviews, evaluations, checkpoint assessments
- **Zone 5 (Yellow)**: Notifications (1 table) - real-time and email notifications
- **Zone 6 (Gray)**: Activity Logs (1 table) - audit trail (optional)

For detailed table specifications, see sections below.

---

### Module 1: Users & Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          users                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     username (UNIQUE)          â”‚
â”‚     email (UNIQUE)             â”‚
â”‚     full_name                  â”‚
â”‚     hashed_password            â”‚
â”‚     role (ENUM)                â”‚â—„â”€â”€â”€â”€ 'ADMIN' | 'STAFF' | 'HEAD' | 
â”‚     avatar_url                 â”‚      'LECTURER' | 'STUDENT'
â”‚     phone                      â”‚
â”‚     is_active                  â”‚
â”‚     created_at                 â”‚
â”‚     updated_at                 â”‚
â”‚     last_login                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N relationships:
        â”œâ”€â”€â–º class_members (as student)
        â”œâ”€â”€â–º classes (as lecturer)
        â”œâ”€â”€â–º group_members (as member)
        â”œâ”€â”€â–º projects (as creator)
        â”œâ”€â”€â–º chat_messages (as sender)
        â”œâ”€â”€â–º evaluations (as evaluator)
        â””â”€â”€â–º notifications (as recipient)
```

### Module 2: Academic Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         subjects               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     code (UNIQUE)              â”‚
â”‚     name                       â”‚
â”‚     credits                    â”‚
â”‚     description                â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        curricula               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  subject_id                 â”‚
â”‚     content                    â”‚
â”‚     week_number                â”‚
â”‚     learning_outcomes          â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          classes               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     code (UNIQUE)              â”‚
â”‚     name                       â”‚
â”‚ FK  subject_id                 â”‚
â”‚ FK  lecturer_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Lecturer)
â”‚     semester                   â”‚
â”‚     academic_year              â”‚
â”‚     max_students               â”‚
â”‚     status                     â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      class_members             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  class_id                   â”‚
â”‚ FK  student_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Student)
â”‚     role                       â”‚
â”‚     joined_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Module 3: Project & Group

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         projects               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     title                      â”‚
â”‚     description                â”‚
â”‚     objectives                 â”‚
â”‚     scope                      â”‚
â”‚ FK  created_by â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Lecturer)
â”‚ FK  approved_by â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Head)
â”‚     status                     â”‚
â”‚     approval_status            â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    project_milestones          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  project_id                 â”‚
â”‚     title                      â”‚
â”‚     description                â”‚
â”‚     order_index                â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      class_projects            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  class_id                   â”‚
â”‚ FK  project_id                 â”‚
â”‚     assigned_at                â”‚
â”‚     max_groups                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          groups                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     name                       â”‚
â”‚ FK  class_id                   â”‚
â”‚ FK  project_id                 â”‚
â”‚ FK  leader_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Student)
â”‚     description                â”‚
â”‚     status                     â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
             â”œâ”€â”€â–º group_members
             â”œâ”€â”€â–º group_milestones
             â”œâ”€â”€â–º checkpoints
             â”œâ”€â”€â–º tasks
             â”œâ”€â”€â–º chat_messages
             â””â”€â”€â–º resources
```

### Module 4: Collaboration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         meetings               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     title                      â”‚
â”‚ FK  group_id                   â”‚
â”‚ FK  created_by                 â”‚
â”‚     scheduled_at               â”‚
â”‚     duration                   â”‚
â”‚     meeting_url                â”‚
â”‚     status                     â”‚
â”‚     notes                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      chat_messages             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  sender_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users
â”‚ FK  group_id                   â”‚
â”‚ FK  class_id                   â”‚
â”‚     message                    â”‚
â”‚     message_type               â”‚
â”‚     file_url                   â”‚
â”‚     is_read                    â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         resources              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚     title                      â”‚
â”‚     description                â”‚
â”‚     file_url                   â”‚
â”‚     file_type                  â”‚
â”‚     file_size                  â”‚
â”‚ FK  uploaded_by                â”‚
â”‚ FK  group_id                   â”‚
â”‚ FK  class_id                   â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Module 5: Evaluation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       peer_reviews             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  reviewer_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Reviewer)
â”‚ FK  reviewee_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Reviewee)
â”‚ FK  group_id                   â”‚
â”‚     period                     â”‚
â”‚     rating (1-5)               â”‚
â”‚     comments                   â”‚
â”‚     criteria (JSON)            â”‚
â”‚     is_anonymous               â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    group_evaluations           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK  id                         â”‚
â”‚ FK  group_id                   â”‚
â”‚ FK  evaluator_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º users (Lecturer)
â”‚     evaluation_type            â”‚
â”‚     score                      â”‚
â”‚     feedback                   â”‚
â”‚     criteria (JSON)            â”‚
â”‚     created_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4.2.4. ERD - PHYSICAL MODEL (Chi tiáº¿t 28 Tables)

### Table 1: users

**Purpose**: LÆ°u trá»¯ thÃ´ng tin tÃ i khoáº£n ngÆ°á»i dÃ¹ng

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | User ID |
| `username` | VARCHAR(100) | UNIQUE, NOT NULL | - | TÃªn Ä‘Äƒng nháº­p |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | - | Email (dÃ¹ng login) |
| `full_name` | VARCHAR(255) | NOT NULL | - | Há» tÃªn Ä‘áº§y Ä‘á»§ |
| `hashed_password` | VARCHAR(255) | NOT NULL | - | Password Ä‘Ã£ hash (bcrypt) |
| `role` | VARCHAR(20) | NOT NULL | 'STUDENT' | Vai trÃ²: ADMIN/STAFF/HEAD/LECTURER/STUDENT |
| `avatar_url` | TEXT | NULL | NULL | URL áº£nh Ä‘áº¡i diá»‡n |
| `phone` | VARCHAR(20) | NULL | NULL | Sá»‘ Ä‘iá»‡n thoáº¡i |
| `is_active` | BOOLEAN | NOT NULL | TRUE | Tráº¡ng thÃ¡i kÃ­ch hoáº¡t |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |
| `last_login` | TIMESTAMP | NULL | NULL | Láº§n Ä‘Äƒng nháº­p cuá»‘i |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**Sample Data:**
```sql
INSERT INTO users (username, email, full_name, hashed_password, role) VALUES
('admin', 'admin@collabsphere.com', 'System Admin', '$2b$12$...', 'ADMIN'),
('john.lecturer', 'john@fpt.edu.vn', 'John Doe', '$2b$12$...', 'LECTURER'),
('jane.student', 'jane@student.fpt.edu.vn', 'Jane Smith', '$2b$12$...', 'STUDENT');
```

---

### Table 2: subjects

**Purpose**: Quáº£n lÃ½ mÃ´n há»c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Subject ID |
| `code` | VARCHAR(20) | UNIQUE, NOT NULL | - | MÃ£ mÃ´n há»c (VD: SE101) |
| `name` | VARCHAR(255) | NOT NULL | - | TÃªn mÃ´n há»c |
| `credits` | INTEGER | NOT NULL | - | Sá»‘ tÃ­n chá»‰ |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ mÃ´n há»c |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE INDEX idx_subjects_name ON subjects(name);
```

**Sample Data:**
```sql
INSERT INTO subjects (code, name, credits, description) VALUES
('SE101', 'Software Engineering', 3, 'Introduction to Software Engineering'),
('SE401', 'Capstone Project', 6, 'Final year capstone project');
```

---

### Table 3: curricula

**Purpose**: Ná»™i dung giáº£ng dáº¡y theo tuáº§n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Curriculum ID |
| `subject_id` | INTEGER | FOREIGN KEY â†’ subjects(id), NOT NULL | - | MÃ´n há»c |
| `content` | TEXT | NOT NULL | - | Ná»™i dung há»c |
| `week_number` | INTEGER | NULL | NULL | Tuáº§n há»c (1-15) |
| `learning_outcomes` | TEXT | NULL | NULL | Äáº§u ra há»c táº­p |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_curricula_subject_id ON curricula(subject_id);
CREATE INDEX idx_curricula_week ON curricula(subject_id, week_number);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE
```

---

### Table 4: classes

**Purpose**: Quáº£n lÃ½ lá»›p há»c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Class ID |
| `code` | VARCHAR(50) | UNIQUE, NOT NULL | - | MÃ£ lá»›p (VD: SE1701) |
| `name` | VARCHAR(255) | NOT NULL | - | TÃªn lá»›p |
| `subject_id` | INTEGER | FOREIGN KEY â†’ subjects(id), NOT NULL | - | MÃ´n há»c |
| `lecturer_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | Giáº£ng viÃªn phá»¥ trÃ¡ch |
| `semester` | VARCHAR(20) | NOT NULL | - | Há»c ká»³ (Spring2025) |
| `academic_year` | VARCHAR(20) | NOT NULL | - | NÄƒm há»c (2024-2025) |
| `max_students` | INTEGER | NULL | 40 | Sá»‘ SV tá»‘i Ä‘a |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
CREATE INDEX idx_classes_subject_id ON classes(subject_id);
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_classes_semester ON classes(semester);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE RESTRICT,
FOREIGN KEY (lecturer_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 5: class_members

**Purpose**: Sinh viÃªn trong lá»›p

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `class_id` | INTEGER | FOREIGN KEY â†’ classes(id), NOT NULL | - | Lá»›p há»c |
| `student_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | Sinh viÃªn |
| `role` | VARCHAR(20) | NOT NULL | 'MEMBER' | MEMBER/MONITOR |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y tham gia |

**Indexes:**
```sql
CREATE INDEX idx_class_members_class_id ON class_members(class_id);
CREATE INDEX idx_class_members_student_id ON class_members(student_id);
CREATE UNIQUE INDEX idx_class_members_unique ON class_members(class_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 6: projects

**Purpose**: Quáº£n lÃ½ Ä‘á» tÃ i dá»± Ã¡n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Project ID |
| `title` | VARCHAR(255) | NOT NULL | - | TÃªn Ä‘á» tÃ i |
| `description` | TEXT | NOT NULL | - | MÃ´ táº£ chi tiáº¿t |
| `objectives` | TEXT | NULL | NULL | Má»¥c tiÃªu |
| `scope` | TEXT | NULL | NULL | Pháº¡m vi |
| `expected_outcomes` | TEXT | NULL | NULL | Káº¿t quáº£ mong Ä‘á»£i |
| `created_by` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i táº¡o (Lecturer) |
| `approved_by` | INTEGER | FOREIGN KEY â†’ users(id), NULL | NULL | NgÆ°á»i duyá»‡t (Head) |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/APPROVED/REJECTED |
| `approval_status` | VARCHAR(20) | NULL | NULL | Tráº¡ng thÃ¡i duyá»‡t |
| `rejection_reason` | TEXT | NULL | NULL | LÃ½ do tá»« chá»‘i (náº¿u rejected) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |

**Indexes:**
```sql
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_approval_status ON projects(approval_status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 7: project_milestones

**Purpose**: CÃ¡c cá»™t má»‘c cá»§a dá»± Ã¡n (template)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `project_id` | INTEGER | FOREIGN KEY â†’ projects(id), NOT NULL | - | Dá»± Ã¡n |
| `title` | VARCHAR(255) | NOT NULL | - | TÃªn milestone |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ |
| `order_index` | INTEGER | NOT NULL | - | Thá»© tá»± (1, 2, 3...) |
| `duration_weeks` | INTEGER | NULL | NULL | Thá»i lÆ°á»£ng Æ°á»›c tÃ­nh (tuáº§n) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_project_milestones_project_id ON project_milestones(project_id);
CREATE INDEX idx_project_milestones_order ON project_milestones(project_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 8: class_projects

**Purpose**: GÃ¡n dá»± Ã¡n cho lá»›p

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Assignment ID |
| `class_id` | INTEGER | FOREIGN KEY â†’ classes(id), NOT NULL | - | Lá»›p há»c |
| `project_id` | INTEGER | FOREIGN KEY â†’ projects(id), NOT NULL | - | Dá»± Ã¡n |
| `assigned_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y gÃ¡n |
| `max_groups` | INTEGER | NULL | NULL | Sá»‘ nhÃ³m tá»‘i Ä‘a cÃ³ thá»ƒ chá»n |

**Indexes:**
```sql
CREATE INDEX idx_class_projects_class_id ON class_projects(class_id);
CREATE INDEX idx_class_projects_project_id ON class_projects(project_id);
CREATE UNIQUE INDEX idx_class_projects_unique ON class_projects(class_id, project_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 9: groups

**Purpose**: NhÃ³m sinh viÃªn lÃ m dá»± Ã¡n

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Group ID |
| `name` | VARCHAR(255) | NOT NULL | - | TÃªn nhÃ³m |
| `class_id` | INTEGER | FOREIGN KEY â†’ classes(id), NOT NULL | - | Lá»›p há»c |
| `project_id` | INTEGER | FOREIGN KEY â†’ projects(id), NOT NULL | - | Dá»± Ã¡n Ä‘Æ°á»£c chá»n |
| `leader_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NhÃ³m trÆ°á»Ÿng |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ nhÃ³m |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |

**Indexes:**
```sql
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_groups_project_id ON groups(project_id);
CREATE INDEX idx_groups_leader_id ON groups(leader_id);
CREATE INDEX idx_groups_status ON groups(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE RESTRICT,
FOREIGN KEY (leader_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 10: group_members

**Purpose**: ThÃ nh viÃªn trong nhÃ³m

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `student_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | Sinh viÃªn |
| `role` | VARCHAR(50) | NULL | 'MEMBER' | LEADER/MEMBER/... |
| `contribution_score` | FLOAT | NOT NULL | 0.0 | Äiá»ƒm Ä‘Ã³ng gÃ³p (0-100) |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y tham gia |

**Indexes:**
```sql
CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_student_id ON group_members(student_id);
CREATE UNIQUE INDEX idx_group_members_unique ON group_members(group_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 11: group_milestones

**Purpose**: Milestone cá»§a tá»«ng nhÃ³m (copy tá»« project_milestones)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `title` | VARCHAR(255) | NOT NULL | - | TÃªn milestone |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/IN_PROGRESS/COMPLETED |
| `is_completed` | BOOLEAN | NOT NULL | FALSE | ÄÃ£ hoÃ n thÃ nh chÆ°a |
| `completed_at` | TIMESTAMP | NULL | NULL | NgÃ y hoÃ n thÃ nh |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_group_milestones_group_id ON group_milestones(group_id);
CREATE INDEX idx_group_milestones_deadline ON group_milestones(deadline);
CREATE INDEX idx_group_milestones_status ON group_milestones(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 12: checkpoints

**Purpose**: Äiá»ƒm kiá»ƒm tra/ná»™p bÃ i trong milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Checkpoint ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `title` | VARCHAR(255) | NOT NULL | - | TÃªn checkpoint |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `assigned_members` | JSON | NULL | NULL | Danh sÃ¡ch thÃ nh viÃªn Ä‘Æ°á»£c gÃ¡n |
| `submission_url` | TEXT | NULL | NULL | Link ná»™p bÃ i |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/EVALUATED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_checkpoints_group_id ON checkpoints(group_id);
CREATE INDEX idx_checkpoints_deadline ON checkpoints(deadline);
CREATE INDEX idx_checkpoints_status ON checkpoints(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 13: tasks

**Purpose**: Task trong Kanban board (workspace)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Task ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `title` | VARCHAR(255) | NOT NULL | - | TÃªn task |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ chi tiáº¿t |
| `assigned_to` | INTEGER | FOREIGN KEY â†’ users(id), NULL | NULL | NgÆ°á»i Ä‘Æ°á»£c gÃ¡n |
| `status` | VARCHAR(20) | NOT NULL | 'TODO' | TODO/IN_PROGRESS/DONE |
| `priority` | VARCHAR(20) | NOT NULL | 'MEDIUM' | LOW/MEDIUM/HIGH |
| `due_date` | TIMESTAMP | NULL | NULL | Háº¡n hoÃ n thÃ nh |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y cáº­p nháº­t |

**Indexes:**
```sql
CREATE INDEX idx_tasks_group_id ON tasks(group_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 14: meetings

**Purpose**: Cuá»™c há»p nhÃ³m

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Meeting ID |
| `title` | VARCHAR(255) | NOT NULL | - | TiÃªu Ä‘á» cuá»™c há»p |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `created_by` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i táº¡o |
| `scheduled_at` | TIMESTAMP | NOT NULL | - | Thá»i gian há»p |
| `duration` | INTEGER | NULL | 60 | Thá»i lÆ°á»£ng (phÃºt) |
| `meeting_url` | TEXT | NULL | NULL | Link meeting (Zoom/Google Meet) |
| `status` | VARCHAR(20) | NOT NULL | 'SCHEDULED' | SCHEDULED/IN_PROGRESS/COMPLETED/CANCELLED |
| `notes` | TEXT | NULL | NULL | Ghi chÃº |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_meetings_group_id ON meetings(group_id);
CREATE INDEX idx_meetings_created_by ON meetings(created_by);
CREATE INDEX idx_meetings_scheduled_at ON meetings(scheduled_at);
CREATE INDEX idx_meetings_status ON meetings(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 15: meeting_participants

**Purpose**: NgÆ°á»i tham gia cuá»™c há»p

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Participant ID |
| `meeting_id` | INTEGER | FOREIGN KEY â†’ meetings(id), NOT NULL | - | Cuá»™c há»p |
| `user_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i tham gia |
| `status` | VARCHAR(20) | NOT NULL | 'INVITED' | INVITED/ACCEPTED/DECLINED/ATTENDED |
| `joined_at` | TIMESTAMP | NULL | NULL | Thá»i gian join |

**Indexes:**
```sql
CREATE INDEX idx_meeting_participants_meeting_id ON meeting_participants(meeting_id);
CREATE INDEX idx_meeting_participants_user_id ON meeting_participants(user_id);
CREATE UNIQUE INDEX idx_meeting_participants_unique ON meeting_participants(meeting_id, user_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (meeting_id) REFERENCES meetings(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 16: chat_messages

**Purpose**: Tin nháº¯n chat

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Message ID |
| `sender_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i gá»­i |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NULL | NULL | NhÃ³m (náº¿u group chat) |
| `class_id` | INTEGER | FOREIGN KEY â†’ classes(id), NULL | NULL | Lá»›p (náº¿u class chat) |
| `message` | TEXT | NOT NULL | - | Ná»™i dung tin nháº¯n |
| `message_type` | VARCHAR(20) | NOT NULL | 'TEXT' | TEXT/FILE/IMAGE/VIDEO |
| `file_url` | TEXT | NULL | NULL | URL file Ä‘Ã­nh kÃ¨m |
| `is_read` | BOOLEAN | NOT NULL | FALSE | ÄÃ£ Ä‘á»c chÆ°a |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Thá»i gian gá»­i |

**Indexes:**
```sql
CREATE INDEX idx_chat_messages_sender_id ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
CREATE INDEX idx_chat_messages_class_id ON chat_messages(class_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at DESC);
CREATE INDEX idx_chat_messages_group_created ON chat_messages(group_id, created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 17: resources

**Purpose**: TÃ i liá»‡u/tÃ i nguyÃªn

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Resource ID |
| `title` | VARCHAR(255) | NOT NULL | - | TiÃªu Ä‘á» |
| `description` | TEXT | NULL | NULL | MÃ´ táº£ |
| `file_url` | TEXT | NOT NULL | - | URL file (Cloudinary) |
| `file_type` | VARCHAR(50) | NULL | NULL | Loáº¡i file (PDF, DOCX...) |
| `file_size` | INTEGER | NULL | NULL | KÃ­ch thÆ°á»›c (bytes) |
| `uploaded_by` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i upload |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NULL | NULL | NhÃ³m (náº¿u nhÃ³m upload) |
| `class_id` | INTEGER | FOREIGN KEY â†’ classes(id), NULL | NULL | Lá»›p (náº¿u giáº£ng viÃªn upload) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y upload |

**Indexes:**
```sql
CREATE INDEX idx_resources_uploaded_by ON resources(uploaded_by);
CREATE INDEX idx_resources_group_id ON resources(group_id);
CREATE INDEX idx_resources_class_id ON resources(class_id);
CREATE INDEX idx_resources_created_at ON resources(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 18: whiteboard_sessions

**Purpose**: PhiÃªn báº£ng tráº¯ng cá»™ng tÃ¡c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Session ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `session_name` | VARCHAR(255) | NULL | NULL | TÃªn phiÃªn |
| `data` | JSON | NULL | NULL | Dá»¯ liá»‡u váº½ (JSON) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Láº§n cáº­p nháº­t cuá»‘i |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_whiteboard_sessions_group_id ON whiteboard_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 19: document_sessions

**Purpose**: PhiÃªn chá»‰nh sá»­a tÃ i liá»‡u cá»™ng tÃ¡c

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Document ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `title` | VARCHAR(255) | NOT NULL | - | TiÃªu Ä‘á» tÃ i liá»‡u |
| `content` | TEXT | NULL | NULL | Ná»™i dung (HTML/Markdown) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Láº§n cáº­p nháº­t cuá»‘i |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_document_sessions_group_id ON document_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 20: peer_reviews

**Purpose**: ÄÃ¡nh giÃ¡ Ä‘á»“ng nghiá»‡p (peer review)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Review ID |
| `reviewer_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i Ä‘Ã¡nh giÃ¡ |
| `reviewee_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `period` | VARCHAR(50) | NOT NULL | - | Giai Ä‘oáº¡n (Midterm/Final) |
| `rating` | INTEGER | NOT NULL | - | Äiá»ƒm (1-5) |
| `comments` | TEXT | NULL | NULL | Nháº­n xÃ©t |
| `criteria` | JSON | NULL | NULL | TiÃªu chÃ­ Ä‘Ã¡nh giÃ¡ (JSON) |
| `is_anonymous` | BOOLEAN | NOT NULL | TRUE | áº¨n danh hay khÃ´ng |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y Ä‘Ã¡nh giÃ¡ |

**Indexes:**
```sql
CREATE INDEX idx_peer_reviews_reviewer_id ON peer_reviews(reviewer_id);
CREATE INDEX idx_peer_reviews_reviewee_id ON peer_reviews(reviewee_id);
CREATE INDEX idx_peer_reviews_group_id ON peer_reviews(group_id);
CREATE INDEX idx_peer_reviews_period ON peer_reviews(period);
```

**Constraints:**
```sql
CHECK (rating >= 1 AND rating <= 5)
```

**Foreign Keys:**
```sql
FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (reviewee_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 21: group_evaluations

**Purpose**: ÄÃ¡nh giÃ¡ nhÃ³m bá»Ÿi giáº£ng viÃªn

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `evaluator_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i Ä‘Ã¡nh giÃ¡ (Lecturer) |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Loáº¡i (Progress/Final/Presentation) |
| `score` | FLOAT | NOT NULL | - | Äiá»ƒm (0-10) |
| `feedback` | TEXT | NULL | NULL | Pháº£n há»“i |
| `criteria` | JSON | NULL | NULL | TiÃªu chÃ­ (JSON) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y Ä‘Ã¡nh giÃ¡ |

**Indexes:**
```sql
CREATE INDEX idx_group_evaluations_group_id ON group_evaluations(group_id);
CREATE INDEX idx_group_evaluations_evaluator_id ON group_evaluations(evaluator_id);
CREATE INDEX idx_group_evaluations_type ON group_evaluations(evaluation_type);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 22: member_evaluations

**Purpose**: ÄÃ¡nh giÃ¡ thÃ nh viÃªn bá»Ÿi giáº£ng viÃªn

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_member_id` | INTEGER | FOREIGN KEY â†’ group_members(id), NOT NULL | - | ThÃ nh viÃªn |
| `evaluator_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i Ä‘Ã¡nh giÃ¡ |
| `score` | FLOAT | NOT NULL | - | Äiá»ƒm (0-10) |
| `feedback` | TEXT | NULL | NULL | Pháº£n há»“i |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Loáº¡i Ä‘Ã¡nh giÃ¡ |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y Ä‘Ã¡nh giÃ¡ |

**Indexes:**
```sql
CREATE INDEX idx_member_evaluations_member_id ON member_evaluations(group_member_id);
CREATE INDEX idx_member_evaluations_evaluator_id ON member_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_member_id) REFERENCES group_members(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 23: checkpoint_evaluations

**Purpose**: ÄÃ¡nh giÃ¡ checkpoint

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `checkpoint_id` | INTEGER | FOREIGN KEY â†’ checkpoints(id), NOT NULL | - | Checkpoint |
| `evaluator_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i Ä‘Ã¡nh giÃ¡ |
| `score` | FLOAT | NOT NULL | - | Äiá»ƒm (0-10) |
| `feedback` | TEXT | NULL | NULL | Pháº£n há»“i |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y Ä‘Ã¡nh giÃ¡ |

**Indexes:**
```sql
CREATE INDEX idx_checkpoint_evaluations_checkpoint_id ON checkpoint_evaluations(checkpoint_id);
CREATE INDEX idx_checkpoint_evaluations_evaluator_id ON checkpoint_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (checkpoint_id) REFERENCES checkpoints(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 24: milestone_questions

**Purpose**: CÃ¢u há»i cho tá»«ng milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Question ID |
| `milestone_id` | INTEGER | FOREIGN KEY â†’ project_milestones(id), NOT NULL | - | Milestone template |
| `question` | TEXT | NOT NULL | - | Ná»™i dung cÃ¢u há»i |
| `order_index` | INTEGER | NOT NULL | - | Thá»© tá»± (1, 2, 3...) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |

**Indexes:**
```sql
CREATE INDEX idx_milestone_questions_milestone_id ON milestone_questions(milestone_id);
CREATE INDEX idx_milestone_questions_order ON milestone_questions(milestone_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (milestone_id) REFERENCES project_milestones(id) ON DELETE CASCADE
```

---

### Table 25: milestone_answers

**Purpose**: CÃ¢u tráº£ lá»i cá»§a nhÃ³m cho milestone questions

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Answer ID |
| `question_id` | INTEGER | FOREIGN KEY â†’ milestone_questions(id), NOT NULL | - | CÃ¢u há»i |
| `group_id` | INTEGER | FOREIGN KEY â†’ groups(id), NOT NULL | - | NhÃ³m |
| `user_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i tráº£ lá»i |
| `answer` | TEXT | NOT NULL | - | CÃ¢u tráº£ lá»i |
| `submitted_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y ná»™p |

**Indexes:**
```sql
CREATE INDEX idx_milestone_answers_question_id ON milestone_answers(question_id);
CREATE INDEX idx_milestone_answers_group_id ON milestone_answers(group_id);
CREATE INDEX idx_milestone_answers_user_id ON milestone_answers(user_id);
CREATE UNIQUE INDEX idx_milestone_answers_unique ON milestone_answers(question_id, group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (question_id) REFERENCES milestone_questions(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 26: notifications

**Purpose**: ThÃ´ng bÃ¡o há»‡ thá»‘ng

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Notification ID |
| `user_id` | INTEGER | FOREIGN KEY â†’ users(id), NOT NULL | - | NgÆ°á»i nháº­n |
| `type` | VARCHAR(50) | NOT NULL | - | Loáº¡i (PROJECT_APPROVED, CHAT_MESSAGE...) |
| `title` | VARCHAR(255) | NOT NULL | - | TiÃªu Ä‘á» |
| `content` | TEXT | NOT NULL | - | Ná»™i dung |
| `link` | TEXT | NULL | NULL | Link liÃªn quan |
| `is_read` | BOOLEAN | NOT NULL | FALSE | ÄÃ£ Ä‘á»c chÆ°a |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | NgÃ y táº¡o |
| `read_at` | TIMESTAMP | NULL | NULL | NgÃ y Ä‘á»c |

**Indexes:**
```sql
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_is_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Tables 27-28: Additional Tables (Optional)

#### Table 27: project_tags

**Purpose**: Tag cho project (AI-generated hoáº·c manual)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Tag ID |
| `project_id` | INTEGER | FOREIGN KEY â†’ projects | Project |
| `tag` | VARCHAR(50) | NOT NULL | Tag name |

#### Table 28: activity_logs

**Purpose**: Audit trail / activity logs

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Log ID |
| `user_id` | INTEGER | FOREIGN KEY â†’ users | User |
| `action` | VARCHAR(100) | NOT NULL | Action type |
| `entity_type` | VARCHAR(50) | NOT NULL | Entity affected |
| `entity_id` | INTEGER | NULL | Entity ID |
| `timestamp` | TIMESTAMP | NOT NULL | When |

---

## 4.2.5. DATABASE OPTIMIZATION

### Indexes Strategy

**1. Primary Key Indexes** (Tá»± Ä‘á»™ng):
- Má»i báº£ng Ä‘á»u cÃ³ PK index trÃªn `id`

**2. Foreign Key Indexes** (Báº¯t buá»™c):
```sql
-- Performance cho JOIN queries
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
-- ... (tá»•ng ~40 FK indexes)
```

**3. Composite Indexes** (Tá»‘i Æ°u queries thÆ°á»ng dÃ¹ng):
```sql
-- Chat messages by group, sorted by time
CREATE INDEX idx_chat_messages_group_created 
ON chat_messages(group_id, created_at DESC);

-- Notifications by user, filtered by read status
CREATE INDEX idx_notifications_user_read 
ON notifications(user_id, is_read);

-- Peer reviews by reviewee and period
CREATE INDEX idx_peer_reviews_reviewee_period 
ON peer_reviews(reviewee_id, period);
```

**4. Unique Indexes** (Business rules):
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
```

### Query Optimization Examples

**Query 1: Láº¥y táº¥t cáº£ chat messages cá»§a nhÃ³m**
```sql
-- Tá»‘i Æ°u vá»›i index idx_chat_messages_group_created
SELECT * FROM chat_messages 
WHERE group_id = 123 
ORDER BY created_at DESC 
LIMIT 50;

-- EXPLAIN: Index Scan on idx_chat_messages_group_created
```

**Query 2: Láº¥y notifications chÆ°a Ä‘á»c cá»§a user**
```sql
-- Tá»‘i Æ°u vá»›i index idx_notifications_user_read
SELECT * FROM notifications 
WHERE user_id = 456 AND is_read = FALSE 
ORDER BY created_at DESC;

-- EXPLAIN: Index Scan on idx_notifications_user_read
```

**Query 3: Láº¥y nhÃ³m vÃ  thÃ nh viÃªn**
```sql
-- Sá»­ dá»¥ng JOIN vá»›i FK indexes
SELECT g.*, u.full_name as leader_name 
FROM groups g 
JOIN users u ON g.leader_id = u.id 
WHERE g.class_id = 789;

-- EXPLAIN: Index Scan on idx_groups_class_id, Index Scan on users_pkey
```

### Connection Pooling

**SQLModel Configuration:**
```python
# app/database.py
from sqlmodel import create_engine, Session

DATABASE_URL = "postgresql://user:pass@localhost:5432/collabsphere_db"

# Connection pool settings
engine = create_engine(
    DATABASE_URL,
    echo=False,
    pool_size=10,        # Number of connections to keep open
    max_overflow=20,     # Max additional connections
    pool_timeout=30,     # Timeout for getting connection
    pool_pre_ping=True   # Test connection before use
)
```

---

## 4.2.6. DATABASE BACKUP & RECOVERY

### Backup Strategy

**1. Daily Automated Backup:**
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -h localhost -U collabsphere_user -d collabsphere_db \
  -F c -f /backups/collabsphere_backup_$DATE.dump

# Retention: Keep last 30 days
find /backups -name "collabsphere_backup_*.dump" -mtime +30 -delete
```

**2. Restore from Backup:**
```bash
pg_restore -h localhost -U collabsphere_user -d collabsphere_db \
  -c /backups/collabsphere_backup_20260104_120000.dump
```

### Recovery Time Objective (RTO)

- **Target RTO**: < 4 hours
- **Target RPO** (Recovery Point Objective): < 1 day (daily backup)

---

## 4.2.7. DATABASE MIGRATIONS (Alembic)

### Migration Files

**Location**: `collabsphere/backend/alembic/versions/`

**Example Migration:**
```python
"""create users table

Revision ID: 001_create_users
Revises: 
Create Date: 2026-01-04 10:00:00
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(100), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('full_name', sa.String(255), nullable=False),
        sa.Column('hashed_password', sa.String(255), nullable=False),
        sa.Column('role', sa.String(20), nullable=False, server_default='STUDENT'),
        sa.Column('avatar_url', sa.Text(), nullable=True),
        sa.Column('phone', sa.String(20), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=False, server_default='true'),
        sa.Column('created_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('updated_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('last_login', sa.TIMESTAMP(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_users_username', 'users', ['username'], unique=True)
    op.create_index('idx_users_email', 'users', ['email'], unique=True)

def downgrade():
    op.drop_index('idx_users_email')
    op.drop_index('idx_users_username')
    op.drop_table('users')
```

### Run Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Show migration history
alembic history

# Generate new migration
alembic revision --autogenerate -m "description"
```

---

## 4.2.8. DATABASE SECURITY

### Security Measures

1. **Password Security**:
   - Use environment variables for DB credentials
   - Never commit passwords to Git
   - Rotate passwords quarterly

2. **Access Control**:
   ```sql
   -- Create limited user for application
   CREATE USER collabsphere_app WITH PASSWORD 'secure_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_app;
   GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO collabsphere_app;
   
   -- Read-only user for reports
   CREATE USER collabsphere_readonly WITH PASSWORD 'readonly_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_readonly;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO collabsphere_readonly;
   ```

3. **Encryption**:
   - TLS/SSL for connections: `sslmode=require`
   - Encrypt backups
   - Encrypt sensitive columns (if needed)

4. **Audit Logging**:
   - Log all DDL operations
   - Log failed login attempts
   - Monitor suspicious queries

---

## 4.2.9. DATABASE MONITORING

### Metrics to Monitor

1. **Performance Metrics**:
   - Query execution time
   - Connection pool usage
   - Cache hit ratio
   - Index usage statistics

2. **Capacity Metrics**:
   - Database size growth
   - Table sizes
   - Index sizes

3. **Health Metrics**:
   - Active connections
   - Long-running queries
   - Deadlocks

### Monitoring Queries

```sql
-- Check database size
SELECT pg_size_pretty(pg_database_size('collabsphere_db'));

-- Check table sizes
SELECT schemaname, tablename, 
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Check active connections
SELECT count(*) FROM pg_stat_activity 
WHERE datname = 'collabsphere_db';

-- Find slow queries
SELECT pid, now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - query_start > interval '5 seconds';
```

---

**[â† Back to 4.1 System Design](4.1-SystemDesign.md)** | **[Next: 4.3 Detailed Design â†’](4.3-DetailedDesign.md)**
