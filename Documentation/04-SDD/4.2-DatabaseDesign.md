# 4.2. DATABASE DESIGN (Thiết kế Cơ sở Dữ liệu)

**Thiết kế CSDL Chi tiết - CollabSphere**

---

## 4.2.1. DATABASE OVERVIEW

### Thông tin Cơ bản

| Thuộc tính | Giá trị |
|------------|---------|
| **DBMS** | PostgreSQL 15.x |
| **Database Name** | collabsphere_db |
| **Character Set** | UTF-8 |
| **Collation** | en_US.UTF-8 |
| **Total Tables** | 28 tables |
| **ORM Framework** | SQLModel (Python) |
| **Migration Tool** | Alembic |

### Các Nhóm Bảng (Table Groups)

```
collabsphere_db (28 tables)
├── 1. Users & Authentication (1 table)
│   └── users
│
├── 2. Academic Management (4 tables)
│   ├── subjects
│   ├── curricula
│   ├── classes
│   └── class_members
│
├── 3. Project & Group (9 tables)
│   ├── projects
│   ├── project_milestones
│   ├── class_projects
│   ├── groups
│   ├── group_members
│   ├── group_milestones
│   ├── checkpoints
│   ├── tasks
│   └── milestone_questions
│
├── 4. Collaboration (7 tables)
│   ├── meetings
│   ├── meeting_participants
│   ├── chat_messages
│   ├── resources
│   ├── whiteboard_sessions
│   ├── document_sessions
│   └── video_sessions (optional)
│
├── 5. Evaluation (5 tables)
│   ├── peer_reviews
│   ├── group_evaluations
│   ├── member_evaluations
│   ├── checkpoint_evaluations
│   └── milestone_answers
│
└── 6. Notification (1 table)
    └── notifications
```

---

## 4.2.2. ERD - CONCEPTUAL MODEL

### Sơ đồ Quan hệ Thực thể Tổng quan

```
┌──────────────────────────────────────────────────────────────┐
│                   COLLABSPHERE DATABASE                       │
│            Project-Based Learning Management System           │
└──────────────────────────────────────────────────────────────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
    ┌───────▼───────┐ ┌───▼──────┐ ┌────▼─────────┐
    │     USERS     │ │ ACADEMIC │ │   PROJECTS   │
    │               │ │          │ │              │
    │ - Admin       │ │ Subject  │ │ Project      │
    │ - Staff       │ │ Class    │ │ Milestone    │
    │ - Head        │ │ Members  │ │              │
    │ - Lecturer    │ │          │ │              │
    │ - Student     │ │          │ │              │
    └───────┬───────┘ └───┬──────┘ └────┬─────────┘
            │             │              │
            └─────────────┼──────────────┘
                          │
            ┌─────────────▼──────────────┐
            │      GROUPS & TEAMS        │
            │                            │
            │  Group                     │
            │  Group Members             │
            │  Tasks & Checkpoints       │
            └────┬──────────────┬────────┘
                 │              │
      ┌──────────▼────────┐ ┌──▼─────────────┐
      │  COLLABORATION    │ │  EVALUATION    │
      │                   │ │                │
      │  Chat             │ │  Peer Review   │
      │  Meetings         │ │  Evaluations   │
      │  Resources        │ │  Feedback      │
      │  Whiteboard       │ │                │
      └───────────────────┘ └────────────────┘
                 │
          ┌──────▼──────┐
          │NOTIFICATION │
          │             │
          │ Email       │
          │ Real-time   │
          └─────────────┘
```

---

## 4.2.3. ERD - LOGICAL MODEL

### Module 1: Users & Authentication

```
┌────────────────────────────────┐
│          users                 │
├────────────────────────────────┤
│ PK  id                         │
│     username (UNIQUE)          │
│     email (UNIQUE)             │
│     full_name                  │
│     hashed_password            │
│     role (ENUM)                │◄──── 'ADMIN' | 'STAFF' | 'HEAD' | 
│     avatar_url                 │      'LECTURER' | 'STUDENT'
│     phone                      │
│     is_active                  │
│     created_at                 │
│     updated_at                 │
│     last_login                 │
└────────────────────────────────┘
        │
        │ 1:N relationships:
        ├──► class_members (as student)
        ├──► classes (as lecturer)
        ├──► group_members (as member)
        ├──► projects (as creator)
        ├──► chat_messages (as sender)
        ├──► evaluations (as evaluator)
        └──► notifications (as recipient)
```

### Module 2: Academic Management

```
┌────────────────────────────────┐
│         subjects               │
├────────────────────────────────┤
│ PK  id                         │
│     code (UNIQUE)              │
│     name                       │
│     credits                    │
│     description                │
│     created_at                 │
└────────────┬───────────────────┘
             │ 1:N
             ▼
┌────────────────────────────────┐
│        curricula               │
├────────────────────────────────┤
│ PK  id                         │
│ FK  subject_id                 │
│     content                    │
│     week_number                │
│     learning_outcomes          │
│     created_at                 │
└────────────────────────────────┘

┌────────────────────────────────┐
│          classes               │
├────────────────────────────────┤
│ PK  id                         │
│     code (UNIQUE)              │
│     name                       │
│ FK  subject_id                 │
│ FK  lecturer_id ───────────────┼──► users (Lecturer)
│     semester                   │
│     academic_year              │
│     max_students               │
│     status                     │
│     created_at                 │
└────────────┬───────────────────┘
             │ 1:N
             ▼
┌────────────────────────────────┐
│      class_members             │
├────────────────────────────────┤
│ PK  id                         │
│ FK  class_id                   │
│ FK  student_id ────────────────┼──► users (Student)
│     role                       │
│     joined_at                  │
└────────────────────────────────┘
```

### Module 3: Project & Group

```
┌────────────────────────────────┐
│         projects               │
├────────────────────────────────┤
│ PK  id                         │
│     title                      │
│     description                │
│     objectives                 │
│     scope                      │
│ FK  created_by ────────────────┼──► users (Lecturer)
│ FK  approved_by ───────────────┼──► users (Head)
│     status                     │
│     approval_status            │
│     created_at                 │
└────────────┬───────────────────┘
             │ 1:N
             ▼
┌────────────────────────────────┐
│    project_milestones          │
├────────────────────────────────┤
│ PK  id                         │
│ FK  project_id                 │
│     title                      │
│     description                │
│     order_index                │
│     created_at                 │
└────────────────────────────────┘

┌────────────────────────────────┐
│      class_projects            │
├────────────────────────────────┤
│ PK  id                         │
│ FK  class_id                   │
│ FK  project_id                 │
│     assigned_at                │
│     max_groups                 │
└────────────────────────────────┘

┌────────────────────────────────┐
│          groups                │
├────────────────────────────────┤
│ PK  id                         │
│     name                       │
│ FK  class_id                   │
│ FK  project_id                 │
│ FK  leader_id ─────────────────┼──► users (Student)
│     description                │
│     status                     │
│     created_at                 │
└────────────┬───────────────────┘
             │ 1:N
             ├──► group_members
             ├──► group_milestones
             ├──► checkpoints
             ├──► tasks
             ├──► chat_messages
             └──► resources
```

### Module 4: Collaboration

```
┌────────────────────────────────┐
│         meetings               │
├────────────────────────────────┤
│ PK  id                         │
│     title                      │
│ FK  group_id                   │
│ FK  created_by                 │
│     scheduled_at               │
│     duration                   │
│     meeting_url                │
│     status                     │
│     notes                      │
└────────────────────────────────┘

┌────────────────────────────────┐
│      chat_messages             │
├────────────────────────────────┤
│ PK  id                         │
│ FK  sender_id ─────────────────┼──► users
│ FK  group_id                   │
│ FK  class_id                   │
│     message                    │
│     message_type               │
│     file_url                   │
│     is_read                    │
│     created_at                 │
└────────────────────────────────┘

┌────────────────────────────────┐
│         resources              │
├────────────────────────────────┤
│ PK  id                         │
│     title                      │
│     description                │
│     file_url                   │
│     file_type                  │
│     file_size                  │
│ FK  uploaded_by                │
│ FK  group_id                   │
│ FK  class_id                   │
│     created_at                 │
└────────────────────────────────┘
```

### Module 5: Evaluation

```
┌────────────────────────────────┐
│       peer_reviews             │
├────────────────────────────────┤
│ PK  id                         │
│ FK  reviewer_id ───────────────┼──► users (Reviewer)
│ FK  reviewee_id ───────────────┼──► users (Reviewee)
│ FK  group_id                   │
│     period                     │
│     rating (1-5)               │
│     comments                   │
│     criteria (JSON)            │
│     is_anonymous               │
│     created_at                 │
└────────────────────────────────┘

┌────────────────────────────────┐
│    group_evaluations           │
├────────────────────────────────┤
│ PK  id                         │
│ FK  group_id                   │
│ FK  evaluator_id ──────────────┼──► users (Lecturer)
│     evaluation_type            │
│     score                      │
│     feedback                   │
│     criteria (JSON)            │
│     created_at                 │
└────────────────────────────────┘
```

---

## 4.2.4. ERD - PHYSICAL MODEL (Chi tiết 28 Tables)

### Table 1: users

**Purpose**: Lưu trữ thông tin tài khoản người dùng

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | User ID |
| `username` | VARCHAR(100) | UNIQUE, NOT NULL | - | Tên đăng nhập |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | - | Email (dùng login) |
| `full_name` | VARCHAR(255) | NOT NULL | - | Họ tên đầy đủ |
| `hashed_password` | VARCHAR(255) | NOT NULL | - | Password đã hash (bcrypt) |
| `role` | VARCHAR(20) | NOT NULL | 'STUDENT' | Vai trò: ADMIN/STAFF/HEAD/LECTURER/STUDENT |
| `avatar_url` | TEXT | NULL | NULL | URL ảnh đại diện |
| `phone` | VARCHAR(20) | NULL | NULL | Số điện thoại |
| `is_active` | BOOLEAN | NOT NULL | TRUE | Trạng thái kích hoạt |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |
| `last_login` | TIMESTAMP | NULL | NULL | Lần đăng nhập cuối |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**Sample Data:**
```sql
INSERT INTO users (username, email, full_name, hashed_password, role) VALUES
('admin', 'admin@collabsphere.com', 'System Admin', '$2b$12$...', 'ADMIN'),
('john.lecturer', 'john@fpt.edu.vn', 'John Doe', '$2b$12$...', 'LECTURER'),
('jane.student', 'jane@student.fpt.edu.vn', 'Jane Smith', '$2b$12$...', 'STUDENT');
```

---

### Table 2: subjects

**Purpose**: Quản lý môn học

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Subject ID |
| `code` | VARCHAR(20) | UNIQUE, NOT NULL | - | Mã môn học (VD: SE101) |
| `name` | VARCHAR(255) | NOT NULL | - | Tên môn học |
| `credits` | INTEGER | NOT NULL | - | Số tín chỉ |
| `description` | TEXT | NULL | NULL | Mô tả môn học |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE INDEX idx_subjects_name ON subjects(name);
```

**Sample Data:**
```sql
INSERT INTO subjects (code, name, credits, description) VALUES
('SE101', 'Software Engineering', 3, 'Introduction to Software Engineering'),
('SE401', 'Capstone Project', 6, 'Final year capstone project');
```

---

### Table 3: curricula

**Purpose**: Nội dung giảng dạy theo tuần

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Curriculum ID |
| `subject_id` | INTEGER | FOREIGN KEY → subjects(id), NOT NULL | - | Môn học |
| `content` | TEXT | NOT NULL | - | Nội dung học |
| `week_number` | INTEGER | NULL | NULL | Tuần học (1-15) |
| `learning_outcomes` | TEXT | NULL | NULL | Đầu ra học tập |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_curricula_subject_id ON curricula(subject_id);
CREATE INDEX idx_curricula_week ON curricula(subject_id, week_number);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE CASCADE
```

---

### Table 4: classes

**Purpose**: Quản lý lớp học

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Class ID |
| `code` | VARCHAR(50) | UNIQUE, NOT NULL | - | Mã lớp (VD: SE1701) |
| `name` | VARCHAR(255) | NOT NULL | - | Tên lớp |
| `subject_id` | INTEGER | FOREIGN KEY → subjects(id), NOT NULL | - | Môn học |
| `lecturer_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Giảng viên phụ trách |
| `semester` | VARCHAR(20) | NOT NULL | - | Học kỳ (Spring2025) |
| `academic_year` | VARCHAR(20) | NOT NULL | - | Năm học (2024-2025) |
| `max_students` | INTEGER | NULL | 40 | Số SV tối đa |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |

**Indexes:**
```sql
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
CREATE INDEX idx_classes_subject_id ON classes(subject_id);
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_classes_semester ON classes(semester);
```

**Foreign Keys:**
```sql
FOREIGN KEY (subject_id) REFERENCES subjects(id) ON DELETE RESTRICT,
FOREIGN KEY (lecturer_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 5: class_members

**Purpose**: Sinh viên trong lớp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `class_id` | INTEGER | FOREIGN KEY → classes(id), NOT NULL | - | Lớp học |
| `student_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Sinh viên |
| `role` | VARCHAR(20) | NOT NULL | 'MEMBER' | MEMBER/MONITOR |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tham gia |

**Indexes:**
```sql
CREATE INDEX idx_class_members_class_id ON class_members(class_id);
CREATE INDEX idx_class_members_student_id ON class_members(student_id);
CREATE UNIQUE INDEX idx_class_members_unique ON class_members(class_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 6: projects

**Purpose**: Quản lý đề tài dự án

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Project ID |
| `title` | VARCHAR(255) | NOT NULL | - | Tên đề tài |
| `description` | TEXT | NOT NULL | - | Mô tả chi tiết |
| `objectives` | TEXT | NULL | NULL | Mục tiêu |
| `scope` | TEXT | NULL | NULL | Phạm vi |
| `expected_outcomes` | TEXT | NULL | NULL | Kết quả mong đợi |
| `created_by` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người tạo (Lecturer) |
| `approved_by` | INTEGER | FOREIGN KEY → users(id), NULL | NULL | Người duyệt (Head) |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/APPROVED/REJECTED |
| `approval_status` | VARCHAR(20) | NULL | NULL | Trạng thái duyệt |
| `rejection_reason` | TEXT | NULL | NULL | Lý do từ chối (nếu rejected) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |

**Indexes:**
```sql
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_approval_status ON projects(approval_status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 7: project_milestones

**Purpose**: Các cột mốc của dự án (template)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `project_id` | INTEGER | FOREIGN KEY → projects(id), NOT NULL | - | Dự án |
| `title` | VARCHAR(255) | NOT NULL | - | Tên milestone |
| `description` | TEXT | NULL | NULL | Mô tả |
| `order_index` | INTEGER | NOT NULL | - | Thứ tự (1, 2, 3...) |
| `duration_weeks` | INTEGER | NULL | NULL | Thời lượng ước tính (tuần) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_project_milestones_project_id ON project_milestones(project_id);
CREATE INDEX idx_project_milestones_order ON project_milestones(project_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 8: class_projects

**Purpose**: Gán dự án cho lớp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Assignment ID |
| `class_id` | INTEGER | FOREIGN KEY → classes(id), NOT NULL | - | Lớp học |
| `project_id` | INTEGER | FOREIGN KEY → projects(id), NOT NULL | - | Dự án |
| `assigned_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày gán |
| `max_groups` | INTEGER | NULL | NULL | Số nhóm tối đa có thể chọn |

**Indexes:**
```sql
CREATE INDEX idx_class_projects_class_id ON class_projects(class_id);
CREATE INDEX idx_class_projects_project_id ON class_projects(project_id);
CREATE UNIQUE INDEX idx_class_projects_unique ON class_projects(class_id, project_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
```

---

### Table 9: groups

**Purpose**: Nhóm sinh viên làm dự án

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Group ID |
| `name` | VARCHAR(255) | NOT NULL | - | Tên nhóm |
| `class_id` | INTEGER | FOREIGN KEY → classes(id), NOT NULL | - | Lớp học |
| `project_id` | INTEGER | FOREIGN KEY → projects(id), NOT NULL | - | Dự án được chọn |
| `leader_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Nhóm trưởng |
| `description` | TEXT | NULL | NULL | Mô tả nhóm |
| `status` | VARCHAR(20) | NOT NULL | 'ACTIVE' | ACTIVE/INACTIVE/COMPLETED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |

**Indexes:**
```sql
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_groups_project_id ON groups(project_id);
CREATE INDEX idx_groups_leader_id ON groups(leader_id);
CREATE INDEX idx_groups_status ON groups(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE,
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE RESTRICT,
FOREIGN KEY (leader_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 10: group_members

**Purpose**: Thành viên trong nhóm

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Membership ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `student_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Sinh viên |
| `role` | VARCHAR(50) | NULL | 'MEMBER' | LEADER/MEMBER/... |
| `contribution_score` | FLOAT | NOT NULL | 0.0 | Điểm đóng góp (0-100) |
| `joined_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tham gia |

**Indexes:**
```sql
CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_student_id ON group_members(student_id);
CREATE UNIQUE INDEX idx_group_members_unique ON group_members(group_id, student_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 11: group_milestones

**Purpose**: Milestone của từng nhóm (copy từ project_milestones)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Milestone ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `title` | VARCHAR(255) | NOT NULL | - | Tên milestone |
| `description` | TEXT | NULL | NULL | Mô tả |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/IN_PROGRESS/COMPLETED |
| `is_completed` | BOOLEAN | NOT NULL | FALSE | Đã hoàn thành chưa |
| `completed_at` | TIMESTAMP | NULL | NULL | Ngày hoàn thành |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_group_milestones_group_id ON group_milestones(group_id);
CREATE INDEX idx_group_milestones_deadline ON group_milestones(deadline);
CREATE INDEX idx_group_milestones_status ON group_milestones(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 12: checkpoints

**Purpose**: Điểm kiểm tra/nộp bài trong milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Checkpoint ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `title` | VARCHAR(255) | NOT NULL | - | Tên checkpoint |
| `description` | TEXT | NULL | NULL | Mô tả |
| `deadline` | TIMESTAMP | NOT NULL | - | Deadline |
| `assigned_members` | JSON | NULL | NULL | Danh sách thành viên được gán |
| `submission_url` | TEXT | NULL | NULL | Link nộp bài |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | PENDING/SUBMITTED/EVALUATED |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_checkpoints_group_id ON checkpoints(group_id);
CREATE INDEX idx_checkpoints_deadline ON checkpoints(deadline);
CREATE INDEX idx_checkpoints_status ON checkpoints(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 13: tasks

**Purpose**: Task trong Kanban board (workspace)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Task ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `title` | VARCHAR(255) | NOT NULL | - | Tên task |
| `description` | TEXT | NULL | NULL | Mô tả chi tiết |
| `assigned_to` | INTEGER | FOREIGN KEY → users(id), NULL | NULL | Người được gán |
| `status` | VARCHAR(20) | NOT NULL | 'TODO' | TODO/IN_PROGRESS/DONE |
| `priority` | VARCHAR(20) | NOT NULL | 'MEDIUM' | LOW/MEDIUM/HIGH |
| `due_date` | TIMESTAMP | NULL | NULL | Hạn hoàn thành |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `updated_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày cập nhật |

**Indexes:**
```sql
CREATE INDEX idx_tasks_group_id ON tasks(group_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
```

---

### Table 14: meetings

**Purpose**: Cuộc họp nhóm

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Meeting ID |
| `title` | VARCHAR(255) | NOT NULL | - | Tiêu đề cuộc họp |
| `description` | TEXT | NULL | NULL | Mô tả |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `created_by` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người tạo |
| `scheduled_at` | TIMESTAMP | NOT NULL | - | Thời gian họp |
| `duration` | INTEGER | NULL | 60 | Thời lượng (phút) |
| `meeting_url` | TEXT | NULL | NULL | Link meeting (Zoom/Google Meet) |
| `status` | VARCHAR(20) | NOT NULL | 'SCHEDULED' | SCHEDULED/IN_PROGRESS/COMPLETED/CANCELLED |
| `notes` | TEXT | NULL | NULL | Ghi chú |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_meetings_group_id ON meetings(group_id);
CREATE INDEX idx_meetings_created_by ON meetings(created_by);
CREATE INDEX idx_meetings_scheduled_at ON meetings(scheduled_at);
CREATE INDEX idx_meetings_status ON meetings(status);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 15: meeting_participants

**Purpose**: Người tham gia cuộc họp

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Participant ID |
| `meeting_id` | INTEGER | FOREIGN KEY → meetings(id), NOT NULL | - | Cuộc họp |
| `user_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người tham gia |
| `status` | VARCHAR(20) | NOT NULL | 'INVITED' | INVITED/ACCEPTED/DECLINED/ATTENDED |
| `joined_at` | TIMESTAMP | NULL | NULL | Thời gian join |

**Indexes:**
```sql
CREATE INDEX idx_meeting_participants_meeting_id ON meeting_participants(meeting_id);
CREATE INDEX idx_meeting_participants_user_id ON meeting_participants(user_id);
CREATE UNIQUE INDEX idx_meeting_participants_unique ON meeting_participants(meeting_id, user_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (meeting_id) REFERENCES meetings(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 16: chat_messages

**Purpose**: Tin nhắn chat

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Message ID |
| `sender_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người gửi |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NULL | NULL | Nhóm (nếu group chat) |
| `class_id` | INTEGER | FOREIGN KEY → classes(id), NULL | NULL | Lớp (nếu class chat) |
| `message` | TEXT | NOT NULL | - | Nội dung tin nhắn |
| `message_type` | VARCHAR(20) | NOT NULL | 'TEXT' | TEXT/FILE/IMAGE/VIDEO |
| `file_url` | TEXT | NULL | NULL | URL file đính kèm |
| `is_read` | BOOLEAN | NOT NULL | FALSE | Đã đọc chưa |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Thời gian gửi |

**Indexes:**
```sql
CREATE INDEX idx_chat_messages_sender_id ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
CREATE INDEX idx_chat_messages_class_id ON chat_messages(class_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at DESC);
CREATE INDEX idx_chat_messages_group_created ON chat_messages(group_id, created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 17: resources

**Purpose**: Tài liệu/tài nguyên

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Resource ID |
| `title` | VARCHAR(255) | NOT NULL | - | Tiêu đề |
| `description` | TEXT | NULL | NULL | Mô tả |
| `file_url` | TEXT | NOT NULL | - | URL file (Cloudinary) |
| `file_type` | VARCHAR(50) | NULL | NULL | Loại file (PDF, DOCX...) |
| `file_size` | INTEGER | NULL | NULL | Kích thước (bytes) |
| `uploaded_by` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người upload |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NULL | NULL | Nhóm (nếu nhóm upload) |
| `class_id` | INTEGER | FOREIGN KEY → classes(id), NULL | NULL | Lớp (nếu giảng viên upload) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày upload |

**Indexes:**
```sql
CREATE INDEX idx_resources_uploaded_by ON resources(uploaded_by);
CREATE INDEX idx_resources_group_id ON resources(group_id);
CREATE INDEX idx_resources_class_id ON resources(class_id);
CREATE INDEX idx_resources_created_at ON resources(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE RESTRICT,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE
```

---

### Table 18: whiteboard_sessions

**Purpose**: Phiên bảng trắng cộng tác

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Session ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `session_name` | VARCHAR(255) | NULL | NULL | Tên phiên |
| `data` | JSON | NULL | NULL | Dữ liệu vẽ (JSON) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Lần cập nhật cuối |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_whiteboard_sessions_group_id ON whiteboard_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 19: document_sessions

**Purpose**: Phiên chỉnh sửa tài liệu cộng tác

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Document ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `title` | VARCHAR(255) | NOT NULL | - | Tiêu đề tài liệu |
| `content` | TEXT | NULL | NULL | Nội dung (HTML/Markdown) |
| `last_updated` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Lần cập nhật cuối |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_document_sessions_group_id ON document_sessions(group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 20: peer_reviews

**Purpose**: Đánh giá đồng nghiệp (peer review)

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Review ID |
| `reviewer_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người đánh giá |
| `reviewee_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người được đánh giá |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `period` | VARCHAR(50) | NOT NULL | - | Giai đoạn (Midterm/Final) |
| `rating` | INTEGER | NOT NULL | - | Điểm (1-5) |
| `comments` | TEXT | NULL | NULL | Nhận xét |
| `criteria` | JSON | NULL | NULL | Tiêu chí đánh giá (JSON) |
| `is_anonymous` | BOOLEAN | NOT NULL | TRUE | Ẩn danh hay không |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày đánh giá |

**Indexes:**
```sql
CREATE INDEX idx_peer_reviews_reviewer_id ON peer_reviews(reviewer_id);
CREATE INDEX idx_peer_reviews_reviewee_id ON peer_reviews(reviewee_id);
CREATE INDEX idx_peer_reviews_group_id ON peer_reviews(group_id);
CREATE INDEX idx_peer_reviews_period ON peer_reviews(period);
```

**Constraints:**
```sql
CHECK (rating >= 1 AND rating <= 5)
```

**Foreign Keys:**
```sql
FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (reviewee_id) REFERENCES users(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
```

---

### Table 21: group_evaluations

**Purpose**: Đánh giá nhóm bởi giảng viên

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `evaluator_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người đánh giá (Lecturer) |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Loại (Progress/Final/Presentation) |
| `score` | FLOAT | NOT NULL | - | Điểm (0-10) |
| `feedback` | TEXT | NULL | NULL | Phản hồi |
| `criteria` | JSON | NULL | NULL | Tiêu chí (JSON) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày đánh giá |

**Indexes:**
```sql
CREATE INDEX idx_group_evaluations_group_id ON group_evaluations(group_id);
CREATE INDEX idx_group_evaluations_evaluator_id ON group_evaluations(evaluator_id);
CREATE INDEX idx_group_evaluations_type ON group_evaluations(evaluation_type);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 22: member_evaluations

**Purpose**: Đánh giá thành viên bởi giảng viên

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `group_member_id` | INTEGER | FOREIGN KEY → group_members(id), NOT NULL | - | Thành viên |
| `evaluator_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người đánh giá |
| `score` | FLOAT | NOT NULL | - | Điểm (0-10) |
| `feedback` | TEXT | NULL | NULL | Phản hồi |
| `evaluation_type` | VARCHAR(50) | NOT NULL | - | Loại đánh giá |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày đánh giá |

**Indexes:**
```sql
CREATE INDEX idx_member_evaluations_member_id ON member_evaluations(group_member_id);
CREATE INDEX idx_member_evaluations_evaluator_id ON member_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (group_member_id) REFERENCES group_members(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 23: checkpoint_evaluations

**Purpose**: Đánh giá checkpoint

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Evaluation ID |
| `checkpoint_id` | INTEGER | FOREIGN KEY → checkpoints(id), NOT NULL | - | Checkpoint |
| `evaluator_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người đánh giá |
| `score` | FLOAT | NOT NULL | - | Điểm (0-10) |
| `feedback` | TEXT | NULL | NULL | Phản hồi |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày đánh giá |

**Indexes:**
```sql
CREATE INDEX idx_checkpoint_evaluations_checkpoint_id ON checkpoint_evaluations(checkpoint_id);
CREATE INDEX idx_checkpoint_evaluations_evaluator_id ON checkpoint_evaluations(evaluator_id);
```

**Constraints:**
```sql
CHECK (score >= 0 AND score <= 10)
```

**Foreign Keys:**
```sql
FOREIGN KEY (checkpoint_id) REFERENCES checkpoints(id) ON DELETE CASCADE,
FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE RESTRICT
```

---

### Table 24: milestone_questions

**Purpose**: Câu hỏi cho từng milestone

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Question ID |
| `milestone_id` | INTEGER | FOREIGN KEY → project_milestones(id), NOT NULL | - | Milestone template |
| `question` | TEXT | NOT NULL | - | Nội dung câu hỏi |
| `order_index` | INTEGER | NOT NULL | - | Thứ tự (1, 2, 3...) |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |

**Indexes:**
```sql
CREATE INDEX idx_milestone_questions_milestone_id ON milestone_questions(milestone_id);
CREATE INDEX idx_milestone_questions_order ON milestone_questions(milestone_id, order_index);
```

**Foreign Keys:**
```sql
FOREIGN KEY (milestone_id) REFERENCES project_milestones(id) ON DELETE CASCADE
```

---

### Table 25: milestone_answers

**Purpose**: Câu trả lời của nhóm cho milestone questions

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Answer ID |
| `question_id` | INTEGER | FOREIGN KEY → milestone_questions(id), NOT NULL | - | Câu hỏi |
| `group_id` | INTEGER | FOREIGN KEY → groups(id), NOT NULL | - | Nhóm |
| `user_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người trả lời |
| `answer` | TEXT | NOT NULL | - | Câu trả lời |
| `submitted_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày nộp |

**Indexes:**
```sql
CREATE INDEX idx_milestone_answers_question_id ON milestone_answers(question_id);
CREATE INDEX idx_milestone_answers_group_id ON milestone_answers(group_id);
CREATE INDEX idx_milestone_answers_user_id ON milestone_answers(user_id);
CREATE UNIQUE INDEX idx_milestone_answers_unique ON milestone_answers(question_id, group_id);
```

**Foreign Keys:**
```sql
FOREIGN KEY (question_id) REFERENCES milestone_questions(id) ON DELETE CASCADE,
FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Table 26: notifications

**Purpose**: Thông báo hệ thống

| Column | Type | Constraints | Default | Description |
|--------|------|-------------|---------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | Notification ID |
| `user_id` | INTEGER | FOREIGN KEY → users(id), NOT NULL | - | Người nhận |
| `type` | VARCHAR(50) | NOT NULL | - | Loại (PROJECT_APPROVED, CHAT_MESSAGE...) |
| `title` | VARCHAR(255) | NOT NULL | - | Tiêu đề |
| `content` | TEXT | NOT NULL | - | Nội dung |
| `link` | TEXT | NULL | NULL | Link liên quan |
| `is_read` | BOOLEAN | NOT NULL | FALSE | Đã đọc chưa |
| `created_at` | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | Ngày tạo |
| `read_at` | TIMESTAMP | NULL | NULL | Ngày đọc |

**Indexes:**
```sql
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_is_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
```

**Foreign Keys:**
```sql
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

### Tables 27-28: Additional Tables (Optional)

#### Table 27: project_tags

**Purpose**: Tag cho project (AI-generated hoặc manual)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Tag ID |
| `project_id` | INTEGER | FOREIGN KEY → projects | Project |
| `tag` | VARCHAR(50) | NOT NULL | Tag name |

#### Table 28: activity_logs

**Purpose**: Audit trail / activity logs

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY | Log ID |
| `user_id` | INTEGER | FOREIGN KEY → users | User |
| `action` | VARCHAR(100) | NOT NULL | Action type |
| `entity_type` | VARCHAR(50) | NOT NULL | Entity affected |
| `entity_id` | INTEGER | NULL | Entity ID |
| `timestamp` | TIMESTAMP | NOT NULL | When |

---

## 4.2.5. DATABASE OPTIMIZATION

### Indexes Strategy

**1. Primary Key Indexes** (Tự động):
- Mọi bảng đều có PK index trên `id`

**2. Foreign Key Indexes** (Bắt buộc):
```sql
-- Performance cho JOIN queries
CREATE INDEX idx_classes_lecturer_id ON classes(lecturer_id);
CREATE INDEX idx_groups_class_id ON groups(class_id);
CREATE INDEX idx_chat_messages_group_id ON chat_messages(group_id);
-- ... (tổng ~40 FK indexes)
```

**3. Composite Indexes** (Tối ưu queries thường dùng):
```sql
-- Chat messages by group, sorted by time
CREATE INDEX idx_chat_messages_group_created 
ON chat_messages(group_id, created_at DESC);

-- Notifications by user, filtered by read status
CREATE INDEX idx_notifications_user_read 
ON notifications(user_id, is_read);

-- Peer reviews by reviewee and period
CREATE INDEX idx_peer_reviews_reviewee_period 
ON peer_reviews(reviewee_id, period);
```

**4. Unique Indexes** (Business rules):
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX idx_subjects_code ON subjects(code);
CREATE UNIQUE INDEX idx_classes_code ON classes(code);
```

### Query Optimization Examples

**Query 1: Lấy tất cả chat messages của nhóm**
```sql
-- Tối ưu với index idx_chat_messages_group_created
SELECT * FROM chat_messages 
WHERE group_id = 123 
ORDER BY created_at DESC 
LIMIT 50;

-- EXPLAIN: Index Scan on idx_chat_messages_group_created
```

**Query 2: Lấy notifications chưa đọc của user**
```sql
-- Tối ưu với index idx_notifications_user_read
SELECT * FROM notifications 
WHERE user_id = 456 AND is_read = FALSE 
ORDER BY created_at DESC;

-- EXPLAIN: Index Scan on idx_notifications_user_read
```

**Query 3: Lấy nhóm và thành viên**
```sql
-- Sử dụng JOIN với FK indexes
SELECT g.*, u.full_name as leader_name 
FROM groups g 
JOIN users u ON g.leader_id = u.id 
WHERE g.class_id = 789;

-- EXPLAIN: Index Scan on idx_groups_class_id, Index Scan on users_pkey
```

### Connection Pooling

**SQLModel Configuration:**
```python
# app/database.py
from sqlmodel import create_engine, Session

DATABASE_URL = "postgresql://user:pass@localhost:5432/collabsphere_db"

# Connection pool settings
engine = create_engine(
    DATABASE_URL,
    echo=False,
    pool_size=10,        # Number of connections to keep open
    max_overflow=20,     # Max additional connections
    pool_timeout=30,     # Timeout for getting connection
    pool_pre_ping=True   # Test connection before use
)
```

---

## 4.2.6. DATABASE BACKUP & RECOVERY

### Backup Strategy

**1. Daily Automated Backup:**
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -h localhost -U collabsphere_user -d collabsphere_db \
  -F c -f /backups/collabsphere_backup_$DATE.dump

# Retention: Keep last 30 days
find /backups -name "collabsphere_backup_*.dump" -mtime +30 -delete
```

**2. Restore from Backup:**
```bash
pg_restore -h localhost -U collabsphere_user -d collabsphere_db \
  -c /backups/collabsphere_backup_20260104_120000.dump
```

### Recovery Time Objective (RTO)

- **Target RTO**: < 4 hours
- **Target RPO** (Recovery Point Objective): < 1 day (daily backup)

---

## 4.2.7. DATABASE MIGRATIONS (Alembic)

### Migration Files

**Location**: `collabsphere/backend/alembic/versions/`

**Example Migration:**
```python
"""create users table

Revision ID: 001_create_users
Revises: 
Create Date: 2026-01-04 10:00:00
"""
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(100), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('full_name', sa.String(255), nullable=False),
        sa.Column('hashed_password', sa.String(255), nullable=False),
        sa.Column('role', sa.String(20), nullable=False, server_default='STUDENT'),
        sa.Column('avatar_url', sa.Text(), nullable=True),
        sa.Column('phone', sa.String(20), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=False, server_default='true'),
        sa.Column('created_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('updated_at', sa.TIMESTAMP(), nullable=False, server_default=sa.text('now()')),
        sa.Column('last_login', sa.TIMESTAMP(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_users_username', 'users', ['username'], unique=True)
    op.create_index('idx_users_email', 'users', ['email'], unique=True)

def downgrade():
    op.drop_index('idx_users_email')
    op.drop_index('idx_users_username')
    op.drop_table('users')
```

### Run Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Show migration history
alembic history

# Generate new migration
alembic revision --autogenerate -m "description"
```

---

## 4.2.8. DATABASE SECURITY

### Security Measures

1. **Password Security**:
   - Use environment variables for DB credentials
   - Never commit passwords to Git
   - Rotate passwords quarterly

2. **Access Control**:
   ```sql
   -- Create limited user for application
   CREATE USER collabsphere_app WITH PASSWORD 'secure_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_app;
   GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO collabsphere_app;
   
   -- Read-only user for reports
   CREATE USER collabsphere_readonly WITH PASSWORD 'readonly_password';
   GRANT CONNECT ON DATABASE collabsphere_db TO collabsphere_readonly;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO collabsphere_readonly;
   ```

3. **Encryption**:
   - TLS/SSL for connections: `sslmode=require`
   - Encrypt backups
   - Encrypt sensitive columns (if needed)

4. **Audit Logging**:
   - Log all DDL operations
   - Log failed login attempts
   - Monitor suspicious queries

---

## 4.2.9. DATABASE MONITORING

### Metrics to Monitor

1. **Performance Metrics**:
   - Query execution time
   - Connection pool usage
   - Cache hit ratio
   - Index usage statistics

2. **Capacity Metrics**:
   - Database size growth
   - Table sizes
   - Index sizes

3. **Health Metrics**:
   - Active connections
   - Long-running queries
   - Deadlocks

### Monitoring Queries

```sql
-- Check database size
SELECT pg_size_pretty(pg_database_size('collabsphere_db'));

-- Check table sizes
SELECT schemaname, tablename, 
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Check active connections
SELECT count(*) FROM pg_stat_activity 
WHERE datname = 'collabsphere_db';

-- Find slow queries
SELECT pid, now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - query_start > interval '5 seconds';
```

---

**[← Back to 4.1 System Design](4.1-SystemDesign.md)** | **[Next: 4.3 Detailed Design →](4.3-DetailedDesign.md)**
